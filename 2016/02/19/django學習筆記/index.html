
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="cwza&#39;s blog">
    <title>django學習筆記 - cwza&#39;s blog</title>
    <meta name="author" content="Cwza">
    
    
        <link rel="alternative" type="application/atom+xml" title="RSS" href="/my_blog/atom.xml">
    
    <meta name="description" content="Table of Contents


1. Coding Style

1.1. Use Explicit Relative Imports


2. Layout Django Project
3. Setting Files

3.1. 如何處理多環境設定(production, staging, local)
3.2. 重要的secret key問題(secret key不該進入vers">
<meta property="og:type" content="blog">
<meta property="og:title" content="django學習筆記">
<meta property="og:url" content="http://cwza.github.io/my_blog/2016/02/19/django學習筆記/index.html">
<meta property="og:site_name" content="cwza's blog">
<meta property="og:description" content="Table of Contents


1. Coding Style

1.1. Use Explicit Relative Imports


2. Layout Django Project
3. Setting Files

3.1. 如何處理多環境設定(production, staging, local)
3.2. 重要的secret key問題(secret key不該進入vers">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/table6_2.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure8_1.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/table10_1.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/table16_2.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure19_2.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure19_3.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure19_5.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure19_6.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/table23_1.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure31_1.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/figure31_3.png">
<meta property="og:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/table31_1.png">
<meta property="og:updated_time" content="2017-03-10T02:26:35.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="django學習筆記">
<meta name="twitter:description" content="Table of Contents


1. Coding Style

1.1. Use Explicit Relative Imports


2. Layout Django Project
3. Setting Files

3.1. 如何處理多環境設定(production, staging, local)
3.2. 重要的secret key問題(secret key不該進入vers">
<meta name="twitter:image" content="http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/table6_2.png">
    
    
    
        <meta property="og:image" content="https://www.gravatar.com/avatar/f563bb5ba525d2aa148cd22fb4c2db26?s=640"/>
    
    
    
    

    <!--add google search console verification-->
    

    <!--STYLES-->
    <link rel="stylesheet" href="/my_blog/assets/css/style.min.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-70916999-1']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


<header id="header" data-behavior="3">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <h1 class="header-title">
        <a class="header-title-link" href="/my_blog/ ">cwza&#39;s blog</a>
    </h1>
    
        
            <a  class="header-right-icon st-search-show-outputs"
                href="#search">
        
        
            <i class="fa fa-lg fa-search"></i>
        
        </a>
    
</header>

            <!-- Define author's picture -->


    

<nav id="sidebar" data-behavior="3">
    
        <div class="sidebar-profile">
            <a href="/my_blog/#about">
                    <img class="sidebar-profile-picture" src="https://www.gravatar.com/avatar/f563bb5ba525d2aa148cd22fb4c2db26?s=110"/>
            </a>
            <span class="sidebar-profile-name">Cwza</span>
        </div>
    
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/my_blog/ "
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-home"></i>
                    <span class="sidebar-button-desc">Home</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/my_blog/all-categories"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
                    <span class="sidebar-button-desc">Categories</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/my_blog/all-tags"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
                    <span class="sidebar-button-desc">Tags</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/my_blog/all-archives"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
                    <span class="sidebar-button-desc">Archives</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link st-search-show-outputs"
                         href="#search"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-search"></i>
                    <span class="sidebar-button-desc">Search</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="#about"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-question"></i>
                    <span class="sidebar-button-desc">About</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://github.com/cwza" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-github"></i>
                    <span class="sidebar-button-desc">GitHub</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="https://facebook.com/profile.php?id=100001791342932" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-facebook"></i>
                    <span class="sidebar-button-desc">Facebook</span>
                </a>
        </li>
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link " href="mailto:cwz0205a@gmail.com" target="_blank">
                
                    <i class="sidebar-button-icon fa fa-lg fa-envelope-o"></i>
                    <span class="sidebar-button-desc">Mail</span>
                </a>
        </li>
        
    </ul>
    
        <ul class="sidebar-buttons">
        
            <li class="sidebar-button">
                
                    <a  class="sidebar-button-link "
                         href="/my_blog/atom.xml"
                        
                    >
                
                    <i class="sidebar-button-icon fa fa-lg fa-rss"></i>
                    <span class="sidebar-button-desc">RSS</span>
                </a>
        </li>
        
    </ul>
    
</nav>

            
            <div id="main" data-behavior="3"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post" itemscope itemType="http://schema.org/BlogPosting">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title" itemprop="headline">
            django學習筆記
        </h1>
    
    <div class="post-meta">
    <time itemprop="datePublished" content="Fri Feb 19 2016 16:15:00 GMT+0800">
	
		    Feb 19, 2016
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/my_blog/categories/python/">python</a>


    
</div>
</div>
    
    <div class="post-content markdown" itemprop="articleBody">
        <div class="main-content-wrap">
            

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Coding Style</a>
<ul>
<li><a href="#sec-1-1">1.1. Use Explicit Relative Imports</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Layout Django Project</a></li>
<li><a href="#sec-3">3. Setting Files</a>
<ul>
<li><a href="#sec-3-1">3.1. 如何處理多環境設定(production, staging, local)</a></li>
<li><a href="#sec-3-2">3.2. 重要的secret key問題(secret key不該進入version control)</a></li>
<li><a href="#sec-3-3">3.3. 當環境限制無法使用environment variable時怎麼做呢</a></li>
<li><a href="#sec-3-4">3.4. Requirements Files也要照環境分開</a></li>
<li><a href="#sec-3-5">3.5. Setting Files中的Path不要使用Absolute Path</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Model</a>
<ul>
<li><a href="#sec-4-1">4.1. Model Inheritance</a></li>
<li><a href="#sec-4-2">4.2. Model Design Ordering</a></li>
<li><a href="#sec-4-3">4.3. When to Use Null and Blank</a></li>
<li><a href="#sec-4-4">4.4. When to Use BinaryField</a></li>
<li><a href="#sec-4-5">4.5. Try to Avoid Using Generic Relations</a></li>
<li><a href="#sec-4-6">4.6. The Model meta API</a></li>
<li><a href="#sec-4-7">4.7. Fat Models</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Queries and the Database Layer</a>
<ul>
<li><a href="#sec-5-1">5.1. Use get object or 404() for Single Objects instead of get()</a></li>
<li><a href="#sec-5-2">5.2. Be Careful With Queries That Might Throw Exceptions</a>
<ul>
<li><a href="#sec-5-2-1">5.2.1. ObjectDoesNotExist vs. DoesNotExist</a></li>
<li><a href="#sec-5-2-2">5.2.2. When You Just Want One Object but Get Three Back</a></li>
</ul>
</li>
<li><a href="#sec-5-3">5.3. Transactions</a>
<ul>
<li><a href="#sec-5-3-1">5.3.1. Wrapping Each HTTP Request in a Transaction</a></li>
<li><a href="#sec-5-3-2">5.3.2. Explicit Transaction Declaration</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-6">6. Function- and Class-Based Views</a>
<ul>
<li><a href="#sec-6-1">6.1. When to Use FBVs or CBVs</a></li>
<li><a href="#sec-6-2">6.2. Keep View Logic Out of URLConfs</a></li>
<li><a href="#sec-6-3">6.3. Use URL Namespaces</a></li>
<li><a href="#sec-6-4">6.4. Django Views Are Functions</a></li>
<li><a href="#sec-6-5">6.5. Don't Use locals() as Views Context</a></li>
</ul>
</li>
<li><a href="#sec-7">7. Function-Based Views</a>
<ul>
<li><a href="#sec-7-1">7.1. Use Decorator To Modify Request And Response</a></li>
</ul>
</li>
<li><a href="#sec-8">8. Class-Based Views</a>
<ul>
<li><a href="#sec-8-1">8.1. Guidelines When Working With CBVs</a></li>
<li><a href="#sec-8-2">8.2. Using Mixins With CBVs</a></li>
<li><a href="#sec-8-3">8.3. Which Django GCBV Should Be Used for What Task?</a></li>
<li><a href="#sec-8-4">8.4. General Tips for Django CBVs</a>
<ul>
<li><a href="#sec-8-4-1">8.4.1. Constraining Django CBV/GCBV Access to Authenticated Users</a></li>
<li><a href="#sec-8-4-2">8.4.2. Performing Custom Actions on Views With Valid Forms</a></li>
<li><a href="#sec-8-4-3">8.4.3. Performing Custom Actions on Views With Invalid Forms</a></li>
<li><a href="#sec-8-4-4">8.4.4. Using the View Object</a></li>
</ul>
</li>
<li><a href="#sec-8-5">8.5. How GCBVs and Forms Fit Together</a>
<ul>
<li><a href="#sec-8-5-1">8.5.1. Views + ModelForm Example</a></li>
<li><a href="#sec-8-5-2">8.5.2. Views + Form Example</a></li>
</ul>
</li>
<li><a href="#sec-8-6">8.6. Using Just django.views.generic.View</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Form Fundamentals</a>
<ul>
<li><a href="#sec-9-1">9.1. Validate All Incoming Data With Django Forms</a></li>
<li><a href="#sec-9-2">9.2. Always Use CSRF Protection and POST With HTTP Forms That Modify Data</a></li>
<li><a href="#sec-9-3">9.3. Understand How to Add Django Form Instance Attributes</a></li>
<li><a href="#sec-9-4">9.4. Know How Form Validation Works</a>
<ul>
<li><a href="#sec-9-4-1">9.4.1. ModelForm Data Is Saved to the Form, Then the Model In- stance</a></li>
</ul>
</li>
<li><a href="#sec-9-5">9.5. Add Errors to Forms with Form.add error()</a></li>
</ul>
</li>
<li><a href="#sec-10">10. Common Patterns for Forms</a>
<ul>
<li><a href="#sec-10-1">10.1. Pattern 1: Simple ModelForm With Default Validators</a></li>
<li><a href="#sec-10-2">10.2. Pattern 2: Custom Form Field Validators in ModelForms</a>
<ul>
<li><a href="#sec-10-2-1">10.2.1. put validator in Model</a></li>
<li><a href="#sec-10-2-2">10.2.2. put validator in Form</a></li>
</ul>
</li>
<li><a href="#sec-10-3">10.3. Pattern 3: Overriding the Clean Stage of Validation</a></li>
<li><a href="#sec-10-4">10.4. Pattern 4: Hacking Form Fields (2 CBVs, 2 Forms, 1 Model)</a></li>
<li><a href="#sec-10-5">10.5. Pattern 5: Reusable Search Mixin View</a></li>
</ul>
</li>
<li><a href="#sec-11">11. Templates</a>
<ul>
<li><a href="#sec-11-1">11.1. Keep Templates Mostly in templates/</a></li>
<li><a href="#sec-11-2">11.2. Template Architecture Patterns</a>
<ul>
<li><a href="#sec-11-2-1">11.2.1. 2-Tier Template Architecture Example</a></li>
<li><a href="#sec-11-2-2">11.2.2. 3-Tier Template Architecture Example</a></li>
<li><a href="#sec-11-2-3">11.2.3. Flat Is Better Than Nested</a></li>
</ul>
</li>
<li><a href="#sec-11-3">11.3. Limit Processing in Templates</a>
<ul>
<li><a href="#sec-11-3-1">11.3.1. Gotcha 1: Aggregation in Templates</a></li>
<li><a href="#sec-11-3-2">11.3.2. Gotcha 2: Filtering With Conditionals in Templates</a></li>
<li><a href="#sec-11-3-3">11.3.3. Gotcha 3: Complex Implied Queries in Templates</a></li>
<li><a href="#sec-11-3-4">11.3.4. Gotcha 4: Hidden CPU Load in Templates</a></li>
<li><a href="#sec-11-3-5">11.3.5. Gotcha 5: Hidden REST API Calls in Templates</a></li>
</ul>
</li>
<li><a href="#sec-11-4">11.4. Exploring Template Inheritance</a></li>
<li><a href="#sec-11-5">11.5. block.super Gives the Power of Control</a></li>
<li><a href="#sec-11-6">11.6. Useful Things to Consider</a>
<ul>
<li><a href="#sec-11-6-1">11.6.1. Avoid Coupling Styles Too Tightly to Python Code</a></li>
<li><a href="#sec-11-6-2">11.6.2. Common Conventions</a></li>
<li><a href="#sec-11-6-3">11.6.3. Location</a></li>
<li><a href="#sec-11-6-4">11.6.4. Use Named Context Objects</a></li>
<li><a href="#sec-11-6-5">11.6.5. Use URL Names Instead of Hardcoded Paths</a></li>
<li><a href="#sec-11-6-6">11.6.6. Debugging Complex Templates</a></li>
</ul>
</li>
<li><a href="#sec-11-7">11.7. Error Page Templates</a></li>
</ul>
</li>
<li><a href="#sec-12">12. Template Tags and Filters</a>
<ul>
<li><a href="#sec-12-1">12.1. Filters Are Functions</a>
<ul>
<li><a href="#sec-12-1-1">12.1.1. When to Write Filters</a></li>
</ul>
</li>
<li><a href="#sec-12-2">12.2. Custom Template Tags</a>
<ul>
<li><a href="#sec-12-2-1">12.2.1. When to Write Template Tags</a></li>
</ul>
</li>
<li><a href="#sec-12-3">12.3. Naming Your Template Tag Libraries</a></li>
<li><a href="#sec-12-4">12.4. Loading Your Template Tag Modules</a>
<ul>
<li><a href="#sec-12-4-1">12.4.1. Watch Out for This Crazy Anti-Pattern</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-13">13. Building REST APIs</a>
<ul>
<li><a href="#sec-13-1">13.1. Fundamentals of Basic REST API Design</a></li>
<li><a href="#sec-13-2">13.2. Implementing a Simple JSON API</a></li>
<li><a href="#sec-13-3">13.3. REST API Architecture</a>
<ul>
<li><a href="#sec-13-3-1">13.3.1. Code for a Project Should Be Neatly Organized</a></li>
<li><a href="#sec-13-3-2">13.3.2. Code for an App Should Remain in the App</a></li>
<li><a href="#sec-13-3-3">13.3.3. Grouping API URLs</a></li>
<li><a href="#sec-13-3-4">13.3.4. Version Your API</a></li>
</ul>
</li>
<li><a href="#sec-13-4">13.4. Shutting Down an External API</a></li>
<li><a href="#sec-13-5">13.5. Rate Limiting Your API</a></li>
</ul>
</li>
<li><a href="#sec-14">14. Working With the Django Admin</a>
<ul>
<li><a href="#sec-14-1">14.1. It's Not for End Users</a></li>
<li><a href="#sec-14-2">14.2. Add <span class="underline"><span class="underline">str</span></span> to Model</a></li>
<li><a href="#sec-14-3">14.3. Adding Callables to ModelAdmin Classes</a></li>
<li><a href="#sec-14-4">14.4. Django's Admin Documentation Generator</a></li>
<li><a href="#sec-14-5">14.5. Securing the Django Admin and Django Admin Docs</a></li>
</ul>
</li>
<li><a href="#sec-15">15. Dealing With the User Model</a>
<ul>
<li><a href="#sec-15-1">15.1. Use Django's Tools for Finding the User Model</a>
<ul>
<li><a href="#sec-15-1-1">15.1.1. Use settings.AUTH_USER_MODEL for Foreign Keys to User</a></li>
<li><a href="#sec-15-1-2">15.1.2. Don't Use get user model() for Foreign Keys to User</a></li>
</ul>
</li>
<li><a href="#sec-15-2">15.2. Custom User Fields for Django 1.8 Projects</a>
<ul>
<li><a href="#sec-15-2-1">15.2.1. Option 1: Subclass AbstractUser</a></li>
<li><a href="#sec-15-2-2">15.2.2. Option 2: Subclass AbstractBaseUser</a></li>
<li><a href="#sec-15-2-3">15.2.3. Option 3: Linking Back From a Related Model</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-16">16. Third-Party Packages</a>
<ul>
<li><a href="#sec-16-1">16.1. Wiring Up Django Packages: The Basics</a></li>
</ul>
</li>
<li><a href="#sec-17">17. Testing</a>
<ul>
<li><a href="#sec-17-1">17.1. Useful Library for Testing Django Projects</a></li>
<li><a href="#sec-17-2">17.2. How to Structure Tests</a></li>
<li><a href="#sec-17-3">17.3. How to Write Unit Tests</a>
<ul>
<li><a href="#sec-17-3-1">17.3.1. Each Test Method Tests One Thing</a></li>
<li><a href="#sec-17-3-2">17.3.2. For Views, When Possible Use the Request Factory</a></li>
<li><a href="#sec-17-3-3">17.3.3. Don't Repeat Yourself Doesn't Apply to Writing Tests</a></li>
<li><a href="#sec-17-3-4">17.3.4. Don't Rely on Fixtures</a></li>
<li><a href="#sec-17-3-5">17.3.5. Things That Should Be Tested</a></li>
<li><a href="#sec-17-3-6">17.3.6. Test for Failure</a></li>
<li><a href="#sec-17-3-7">17.3.7. Use Mock to Keep Unit Tests From Touching the World</a></li>
<li><a href="#sec-17-3-8">17.3.8. Use Fancier Assertion Methods</a></li>
<li><a href="#sec-17-3-9">17.3.9. Document the Purpose of Each Test</a></li>
</ul>
</li>
<li><a href="#sec-17-4">17.4. What About Integration Tests?</a></li>
<li><a href="#sec-17-5">17.5. Continuous Integration</a></li>
<li><a href="#sec-17-6">17.6. Setting Up the Test Coverage Game</a>
<ul>
<li><a href="#sec-17-6-1">17.6.1. Step 1: Start Writing Tests</a></li>
<li><a href="#sec-17-6-2">17.6.2. Step 2: Run Tests and Generate Coverage Report</a></li>
<li><a href="#sec-17-6-3">17.6.3. Step 3: Generate the Report!</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-18">18. Documentation</a>
<ul>
<li><a href="#sec-18-1">18.1. Use reStructuredText for Python Docs</a></li>
<li><a href="#sec-18-2">18.2. Use Sphinx to Generate Documentation From reStructuredText</a></li>
<li><a href="#sec-18-3">18.3. What Docs Should Django Projects Contain?</a></li>
<li><a href="#sec-18-4">18.4. Additional Documentation Resources</a></li>
</ul>
</li>
<li><a href="#sec-19">19. Finding and Reducing Bottlenecks</a>
<ul>
<li><a href="#sec-19-1">19.1. Should You Even Care?</a></li>
<li><a href="#sec-19-2">19.2. Speed Up Query-Heavy Pages</a>
<ul>
<li><a href="#sec-19-2-1">19.2.1. Find Excessive Queries With Django Debug Toolbar</a></li>
<li><a href="#sec-19-2-2">19.2.2. Reduce the Number of Queries</a></li>
<li><a href="#sec-19-2-3">19.2.3. Speed Up Common Queries</a></li>
<li><a href="#sec-19-2-4">19.2.4. Switch ATOMIC REQUESTS to False</a></li>
</ul>
</li>
<li><a href="#sec-19-3">19.3. Know What Doesn't Belong in the Database</a></li>
<li><a href="#sec-19-4">19.4. Cache Queries With Memcached or Redis</a></li>
<li><a href="#sec-19-5">19.5. Identify Specific Places to Cache</a></li>
<li><a href="#sec-19-6">19.6. Compression and Minification of HTML, CSS, and JavaScript</a></li>
<li><a href="#sec-19-7">19.7. Use Upstream Caching or a Content Delivery Network</a></li>
</ul>
</li>
<li><a href="#sec-20">20. Asynchronous Task Queues</a>
<ul>
<li><a href="#sec-20-1">20.1. Do We Need a Task Queue?</a></li>
<li><a href="#sec-20-2">20.2. Choosing Task Queue Software</a></li>
<li><a href="#sec-20-3">20.3. Best Practices for Task Queues</a>
<ul>
<li><a href="#sec-20-3-1">20.3.1. Treat Tasks Like Views</a></li>
<li><a href="#sec-20-3-2">20.3.2. Tasks Aren't Free</a></li>
<li><a href="#sec-20-3-3">20.3.3. Only Pass JSON-Serializable Values to Task Functions</a></li>
<li><a href="#sec-20-3-4">20.3.4. Learn How to Monitor Tasks and Workers</a></li>
<li><a href="#sec-20-3-5">20.3.5. Logging!</a></li>
<li><a href="#sec-20-3-6">20.3.6. Monitor the Backlog</a></li>
<li><a href="#sec-20-3-7">20.3.7. Periodically Clear Out Dead Tasks</a></li>
<li><a href="#sec-20-3-8">20.3.8. Use the Queue's Error Handling</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-21">21. Security</a>
<ul>
<li><a href="#sec-21-1">21.1. Know Django's Security Features</a></li>
<li><a href="#sec-21-2">21.2. Turn Off DEBUG Mode in Production</a></li>
<li><a href="#sec-21-3">21.3. Keep Your Secret Keys Secret</a></li>
<li><a href="#sec-21-4">21.4. HTTPS Everywhere</a>
<ul>
<li><a href="#sec-21-4-1">21.4.1. Use django.middleware.security.SecurityMiddleware</a></li>
<li><a href="#sec-21-4-2">21.4.2. Use Secure Cookies</a></li>
<li><a href="#sec-21-4-3">21.4.3. Use HTTP Strict Transport Security (HSTS)</a></li>
<li><a href="#sec-21-4-4">21.4.4. HTTPS Configuration Tools</a></li>
</ul>
</li>
<li><a href="#sec-21-5">21.5. Use Allowed Hosts Validation</a></li>
<li><a href="#sec-21-6">21.6. Always Use CSRF Protection With HTTP Forms That Modify Data</a></li>
<li><a href="#sec-21-7">21.7. Obfuscate Primary Keys with UUIDs</a></li>
</ul>
</li>
<li><a href="#sec-22">22. Logging</a>
<ul>
<li><a href="#sec-22-1">22.1. When to Use Each Log Level</a>
<ul>
<li><a href="#sec-22-1-1">22.1.1. Log Catastrophes With CRITICAL</a></li>
<li><a href="#sec-22-1-2">22.1.2. Log Production Errors With ERROR</a></li>
<li><a href="#sec-22-1-3">22.1.3. Log Lower-Priority Problems With WARNING</a></li>
<li><a href="#sec-22-1-4">22.1.4. Log Useful State Information With INFO</a></li>
<li><a href="#sec-22-1-5">22.1.5. Log Debug-Related Messages to DEBUG</a></li>
</ul>
</li>
<li><a href="#sec-22-2">22.2. Log Tracebacks When Catching Exceptions</a></li>
<li><a href="#sec-22-3">22.3. One Logger Per Module That Uses Logging</a></li>
<li><a href="#sec-22-4">22.4. Log Locally to Rotating Files</a></li>
<li><a href="#sec-22-5">22.5. Log settings files</a></li>
</ul>
</li>
<li><a href="#sec-23">23. Signals: Use Cases and Avoidance Techniques</a>
<ul>
<li><a href="#sec-23-1">23.1. When to Use and Avoid Signals</a></li>
<li><a href="#sec-23-2">23.2. Signal Avoidance Techniques</a>
<ul>
<li><a href="#sec-23-2-1">23.2.1. Using Custom Model Manager Methods Instead of Signals</a></li>
<li><a href="#sec-23-2-2">23.2.2. Validate Your Model Elsewhere</a></li>
<li><a href="#sec-23-2-3">23.2.3. Override Your Model's Save or Delete Method Instead</a></li>
<li><a href="#sec-23-2-4">23.2.4. Use a Helper Function Instead of Signals</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-24">24. Utilities</a>
<ul>
<li><a href="#sec-24-1">24.1. Create a Core App for Your Utilities</a></li>
<li><a href="#sec-24-2">24.2. Optimize Apps with Utility Modules</a>
<ul>
<li><a href="#sec-24-2-1">24.2.1. Trimming Models</a></li>
</ul>
</li>
<li><a href="#sec-24-3">24.3. Django's Own Swiss Army Knife</a></li>
<li><a href="#sec-24-4">24.4. Exceptions</a>
<ul>
<li><a href="#sec-24-4-1">24.4.1. django.core.exceptions.ImproperlyConfigured</a></li>
<li><a href="#sec-24-4-2">24.4.2. django.core.exceptions.ObjectDoesNotExist</a></li>
<li><a href="#sec-24-4-3">24.4.3. django.core.exceptions.PermissionDenied</a></li>
</ul>
</li>
<li><a href="#sec-24-5">24.5. Serializers and Deserializers</a>
<ul>
<li><a href="#sec-24-5-1">24.5.1. django.core.serializers.json.DjangoJSONEncoder</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-25">25. Deployment:Platforms as a Service</a>
<ul>
<li><a href="#sec-25-1">25.1. Automate All the Things!</a></li>
</ul>
</li>
<li><a href="#sec-26">26. Deploying Django Projects</a>
<ul>
<li><a href="#sec-26-1">26.1. Single-Server for Small Projects</a>
<ul>
<li><a href="#sec-26-1-1">26.1.1. Example: Quick Ubuntu + Gunicorn Setup</a></li>
</ul>
</li>
<li><a href="#sec-26-2">26.2. Multi-Server for Medium to Large Projects</a>
<ul>
<li><a href="#sec-26-2-1">26.2.1. Advanced Multi-Server Setup</a></li>
</ul>
</li>
<li><a href="#sec-26-3">26.3. WSGI Application Servers</a></li>
<li><a href="#sec-26-4">26.4. Automated, Repeatable Deployments</a></li>
</ul>
</li>
<li><a href="#sec-27">27. Continuous Integration</a>
<ul>
<li><a href="#sec-27-1">27.1. Principles of Continuous Integration</a>
<ul>
<li><a href="#sec-27-1-1">27.1.1. Write Lots of Tests!</a></li>
<li><a href="#sec-27-1-2">27.1.2. Keeping the Build Fast</a></li>
</ul>
</li>
<li><a href="#sec-27-2">27.2. Tools for Continuously Integrating Your Project</a>
<ul>
<li><a href="#sec-27-2-1">27.2.1. Tox</a></li>
<li><a href="#sec-27-2-2">27.2.2. Jenkins</a></li>
</ul>
</li>
<li><a href="#sec-27-3">27.3. Continuous Integration as a Service</a>
<ul>
<li><a href="#sec-27-3-1">27.3.1. Code Coverage as a Service</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-28">28. Debugging</a>
<ul>
<li><a href="#sec-28-1">28.1. Debugging in Development</a>
<ul>
<li><a href="#sec-28-1-1">28.1.1. Use django-debug-toolbar</a></li>
<li><a href="#sec-28-1-2">28.1.2. That Annoying CBV Error</a></li>
<li><a href="#sec-28-1-3">28.1.3. Master the Python Debugger</a></li>
<li><a href="#sec-28-1-4">28.1.4. Remember the Essentials for Form File Uploads</a></li>
</ul>
</li>
<li><a href="#sec-28-2">28.2. Debugging Production Systems</a>
<ul>
<li><a href="#sec-28-2-1">28.2.1. Read the Logs the Easy Way</a></li>
<li><a href="#sec-28-2-2">28.2.2. Mirroring Production</a></li>
<li><a href="#sec-28-2-3">28.2.3. UserBasedExceptionMiddleware</a></li>
<li><a href="#sec-28-2-4">28.2.4. That Troublesome settings.ALLOWED HOSTS Error</a></li>
</ul>
</li>
<li><a href="#sec-28-3">28.3. Feature Flags</a>
<ul>
<li><a href="#sec-28-3-1">28.3.1. Feature Flag Packages</a></li>
<li><a href="#sec-28-3-2">28.3.2. Unit Testing Code Affected by Feature Flags</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-29">29. Internationalization and Localization</a>
<ul>
<li><a href="#sec-29-1">29.1. Define Python Source Code Encodings</a></li>
<li><a href="#sec-29-2">29.2. Wrap Content Strings with Translation Functions</a>
<ul>
<li><a href="#sec-29-2-1">29.2.1. Convention: Use the Underscore Alias to Save Typing</a></li>
</ul>
</li>
<li><a href="#sec-29-3">29.3. Don't Interpolate Words in Sentences</a></li>
<li><a href="#sec-29-4">29.4. Unicode Tricks</a></li>
<li><a href="#sec-29-5">29.5. Browser Page Layout</a></li>
</ul>
</li>
<li><a href="#sec-30">30. Security Settings Reference</a>
<ul>
<li><a href="#sec-30-1">30.1. Email SSL</a></li>
<li><a href="#sec-30-2">30.2. SESSION SERIALIZER</a></li>
<li><a href="#sec-30-3">30.3. SECURE PROXY SSL HEADER</a></li>
</ul>
</li>
<li><a href="#sec-31">31. Some Useful Packages</a>
<ul>
<li><a href="#sec-31-1">31.1. Core</a></li>
<li><a href="#sec-31-2">31.2. Asynchronous</a></li>
<li><a href="#sec-31-3">31.3. Deployment</a></li>
<li><a href="#sec-31-4">31.4. Forms</a></li>
<li><a href="#sec-31-5">31.5. Logging</a></li>
<li><a href="#sec-31-6">31.6. Project Templates</a></li>
<li><a href="#sec-31-7">31.7. REST APIs</a></li>
<li><a href="#sec-31-8">31.8. Testing</a></li>
<li><a href="#sec-31-9">31.9. Views</a></li>
<li><a href="#sec-31-10">31.10. Feature Flag</a></li>
</ul>
</li>
<li><a href="#sec-32">32. Reference</a></li>
</ul>
</div>
</div>
<p>
django學習筆記<br>
隨筆亂記，陸續增加中<br>
</p>
<a id="more"></a>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Coding Style</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Use Explicit Relative Imports</h3>
<div class="outline-text-3" id="text-1-1">
<p>
here’s a table of the different Python import types and when to use them in Django projects:<br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Code</th>
<th scope="col" class="left">Import Type</th>
<th scope="col" class="left">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">from core.views import FoodMixin</td>
<td class="left">absolute import</td>
<td class="left">Use when importing from outside the current app</td>
</tr>

<tr>
<td class="left">from .models import WaffleCone</td>
<td class="left">explicit relative</td>
<td class="left">Use when importing from another module in the current app</td>
</tr>

<tr>
<td class="left">from models import WaffleCone</td>
<td class="left">implicit relative</td>
<td class="left">Often used when importing from another module in the current app, but not a good idea</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Layout Django Project</h2>
<div class="outline-text-2" id="text-2">
<p>
For Example:<br>
icecreamratings project/: git repository root<br>
icecreamratings/: project root<br>
products/, ratings/&#x2026;etc: app root<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">icecreamratings_project/</span><br><span class="line">    .gitignore</span><br><span class="line">    Makefile</span><br><span class="line">    docs/</span><br><span class="line">    README.rst</span><br><span class="line">    requirements.txt</span><br><span class="line">    icecreamratings/</span><br><span class="line">	manage.py</span><br><span class="line">	media/  <span class="comment"># Development ONLY!</span></span><br><span class="line">	products/</span><br><span class="line">	profiles/</span><br><span class="line">	ratings/</span><br><span class="line">	static/</span><br><span class="line">	templates/</span><br><span class="line">	config/</span><br><span class="line">	    __init__.py</span><br><span class="line">	    settings/</span><br><span class="line">	    urls.py</span><br><span class="line">	    wsgi.py</span><br></pre></td></tr></table></figure>
</div>
<p>
可參考github上大大寫好的django project layout工具吧<br>
<a href="https://github.com/pydanny/cookiecutter-django" target="_blank" rel="external">https://github.com/pydanny/cookiecutter-django</a><br>
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Setting Files</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> 如何處理多環境設定(production, staging, local)</h3>
<div class="outline-text-3" id="text-3-1">
<p>
將setting files分開成各個環境，所有setting file全部進入git控管<br>
底下為例子，在&lt;repository root&gt;/config/settings<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">settings/</span><br><span class="line">      __init__.py</span><br><span class="line">      base.py</span><br><span class="line">      dev_audreyr.py</span><br><span class="line">      dev_pydanny.py</span><br><span class="line">      local.py</span><br><span class="line">      staging.py</span><br><span class="line">      test.py</span><br><span class="line">      production.py</span><br></pre></td></tr></table></figure>
</div>

<p>
local設定繼承自base<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings/local.py </span></span><br><span class="line"><span class="keyword">from</span> .base <span class="keyword">import</span> *</span><br><span class="line">DEBUG = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">EMAIL_BACKEND = <span class="string">'django.core.mail.backends.console.EmailBackend'</span></span><br><span class="line"></span><br><span class="line">DATABASES = {</span><br><span class="line">    <span class="string">"default"</span>: {</span><br><span class="line">	<span class="string">"ENGINE"</span>: <span class="string">"django.db.backends.postgresql_psycopg2"</span>,</span><br><span class="line">	<span class="string">"NAME"</span>: <span class="string">"twoscoops"</span>,</span><br><span class="line">	<span class="string">"USER"</span>: <span class="string">""</span>,</span><br><span class="line">	<span class="string">"PASSWORD"</span>: <span class="string">""</span>,</span><br><span class="line">	<span class="string">"HOST"</span>: </span><br><span class="line">	<span class="string">"localhost"</span>,</span><br><span class="line">	<span class="string">"PORT"</span>: <span class="string">""</span>,</span><br><span class="line">	} </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">INSTALLED_APPS += (<span class="string">"debug_toolbar"</span>, )</span><br></pre></td></tr></table></figure>
</div>

<p>
個人設定，繼承自local<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings/dev_pydanny.py </span></span><br><span class="line"><span class="keyword">from</span> .local <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># Set short cache timeout</span></span><br><span class="line">CACHE_TIMEOUT = <span class="number">30</span></span><br></pre></td></tr></table></figure>
</div>

<p>
執行時用以下方式指定setting file執行<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">django-admin shell --settings=twoscoops.settings.local</span><br><span class="line">django-admin runserver --settings=twoscoops.settings.local</span><br></pre></td></tr></table></figure>
</div>
<p>
在server上可以設定環境變數DJANGO SETTINGS MODULE and PYTHONPATH來指定setting file，或利用virtualenv來設定(add Export to the end of virtualenv's bin/activate)<br>
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> 重要的secret key問題(secret key不該進入version control)</h3>
<div class="outline-text-3" id="text-3-2">
<p>
secret key不該進入version control所以不要把它放在setting file中<br>
最好是放在environment variable，setting file中用os.environ["SOME_SECRET_KEY"]去拿<br>
</p>

<p>
linux下將以下放到.bashrc, .bash_profile, or .profile<br>
或利用virtualenv來設定(add Export to the end of virtualenv's bin/activate)<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> SOME_SECRET_KEY=<span class="number">1</span>c3-cr3am-<span class="number">15</span>-yummy</span><br></pre></td></tr></table></figure>
</div>

<p>
setting file用以下方式拿secret key<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Top of settings/production.py</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">SOME_SECRET_KEY = os.environ[<span class="string">"SOME_SECRET_KEY"</span>]</span><br></pre></td></tr></table></figure>
</div>

<p>
上述方式在拿不到environ variable時錯誤訊息會是key_error，不甚好，可在base.py中加入以下改良<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings/base.py </span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="comment"># Normally you should not import ANYTHING from Django directly</span></span><br><span class="line"><span class="comment"># into your settings, but ImproperlyConfigured is an exception.</span></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ImproperlyConfigured .</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_env_variable</span><span class="params">(var_name)</span>:</span></span><br><span class="line">    <span class="string">"""Get the environment variable or return exception."""</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">return</span> os.environ[var_name] </span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">	error_msg = <span class="string">"Set the {} environment variable"</span>.format(var_name)</span><br><span class="line">	<span class="keyword">raise</span> ImproperlyConfigured(erro.r_msg)</span><br></pre></td></tr></table></figure>
</div>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SOME_SECRET_KEY = get_env_variable(<span class="string">"SOME_SECRET_KEY"</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3">
<h3 id="sec-3-3"><span class="section-number-3">3.3</span> 當環境限制無法使用environment variable時怎麼做呢</h3>
<div class="outline-text-3" id="text-3-3">
<p>
將secret_key放進json file(or xml, yml &#x2026;etc)，setting file中利用json util將secret_key讀出，注意此secret file不該進入version control<br>
</p>
<div class="org-src-container">

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">{</span><br><span class="line">    <span class="string">"FILENAME"</span>: <span class="string">"secrets.json"</span>,</span><br><span class="line">    <span class="string">"SECRET_KEY"</span>: <span class="string">"I've got a secret!"</span>,</span><br><span class="line">    <span class="string">"DATABASES_HOST"</span>: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    <span class="string">"PORT"</span>: <span class="string">"5432"</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings/base.py</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="comment"># Normally you should not import ANYTHING from Django directly # into your settings, but ImproperlyConfigured is an exception. from django.core.exceptions import ImproperlyConfigured</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># JSON-based secrets module</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"secrets.json"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    secrets = json.loads(f.read())</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_secret</span><span class="params">(setting, secrets=secrets)</span>:</span></span><br><span class="line">    <span class="string">"""Get the secret variable or return explicit exception."""</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">return</span> secrets[setting] </span><br><span class="line">    <span class="keyword">except</span> KeyError:</span><br><span class="line">	error_msg = <span class="string">"Set the {0} environment variable"</span>.format(setting) </span><br><span class="line">	<span class="keyword">raise</span> ImproperlyConfigured(error_msg)</span><br><span class="line"></span><br><span class="line">SECRET_KEY = get_secret(<span class="string">"SECRET_KEY"</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>

<div id="outline-container-sec-3-4" class="outline-3">
<h3 id="sec-3-4"><span class="section-number-3">3.4</span> Requirements Files也要照環境分開</h3>
<div class="outline-text-3" id="text-3-4">
<p>
不同環境可能需要裝不同package(ex: local才需要debug工具)<br>
在&lt;repository root&gt;/requirements<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">requirements/</span><br><span class="line">    base.txt</span><br><span class="line">    local.txt</span><br><span class="line">    staging.txt</span><br><span class="line">    production.txt</span><br></pre></td></tr></table></figure>
</div>

<p>
in base.txt<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Django==<span class="number">1.8</span><span class="number">.0</span></span><br><span class="line">psycopg2==<span class="number">2.6</span></span><br><span class="line">djangorestframework==<span class="number">3.1</span><span class="number">.1</span></span><br></pre></td></tr></table></figure>
</div>

<p>
in local.txt<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">-r base.txt <span class="comment"># includes the base.txt requirements file</span></span><br><span class="line"></span><br><span class="line">coverage==<span class="number">3.7</span><span class="number">.1</span></span><br><span class="line">django-debug-toolbar==<span class="number">1.3</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>
</div>

<p>
in production.txt<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">-r base.txt <span class="comment"># includes the base.txt requirements file</span></span><br></pre></td></tr></table></figure>
</div>

<p>
裝package時用以下指令指定requirements檔案安裝<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ pip install -r requirements/local.txt</span><br><span class="line">$ pip install -r requirements/production.txt</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-3-5" class="outline-3">
<h3 id="sec-3-5"><span class="section-number-3">3.5</span> Setting Files中的Path不要使用Absolute Path</h3>
<div class="outline-text-3" id="text-3-5">
<p>
利用Unipath (<a href="http://pypi.python.org/pypi/Unipath/" target="_blank" rel="external">http://pypi.python.org/pypi/Unipath/</a>)<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># At the top of settings/base.py </span></span><br><span class="line"><span class="keyword">from</span> unipath <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">BASE_DIR = Path(__file__).ancestor(<span class="number">3</span>)</span><br><span class="line">MEDIA_ROOT = BASE_DIR.child(<span class="string">"media"</span>)</span><br><span class="line">STATIC_ROOT = BASE_DIR.child(<span class="string">"static"</span>)</span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">    BASE_DIR.child(<span class="string">"assets"</span>),</span><br><span class="line">)</span><br><span class="line">TEMPLATES = [</span><br><span class="line">    {</span><br><span class="line">	 <span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">	 DIRS = (BASE_DIR.child(<span class="string">"templates"</span>),)</span><br><span class="line">     },</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>

<p>
或用python內建的os.path<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># At the top of settings/base.py</span></span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> join, abspath, dirname</span><br><span class="line">here = <span class="keyword">lambda</span> *dirs: join(abspath(dirname(__file__)), *dirs) BASE_DIR = here(<span class="string">".."</span>, <span class="string">".."</span>)</span><br><span class="line">root = <span class="keyword">lambda</span> *dirs: join(abspath(BASE_DIR), *dirs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuring MEDIA_ROOT</span></span><br><span class="line">MEDIA_ROOT = root(<span class="string">"media"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuring STATIC_ROOT</span></span><br><span class="line">STATIC_ROOT = root(<span class="string">"collected_static"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Additional locations of static files</span></span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">    root(<span class="string">"assets"</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configuring TEMPLATE_DIRS</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    {</span><br><span class="line">	<span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">	DIRS = (root(<span class="string">"templates"</span>),)</span><br><span class="line">    }, </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Model</h2>
<div class="outline-text-2" id="text-4">
</div><div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Model Inheritance</h3>
<div class="outline-text-3" id="text-4-1">
<p>
當重複field太多時，可考慮abstract base inheritance，例如幾乎每個model都要有created, modified<br>
</p>
<ul class="org-ul">
<li>Abstract base classes: 實際上DB不會有parent table<br>
</li>
<li>multi-table inheritance: DB確實會長出parent table and child table然後用foreign key連結<br>
</li>
<li>proxy models<br>
</li>
</ul>

<p>
<b>不要使用multi-table inheritance，由於其實是使用foreign key處理所以會有效能問題</b><br>
</p>

<p>
以下為例子<br>
core.models.TimeStampedModel裡有常用的created and modified field<br>
flavors.Flovor繼承TimeStampedModel的field<br>
注意<br>
    class Meta:<br>
        abstract = True<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeStampedModel</span><span class="params">(models.Model)</span>:</span> </span><br><span class="line">    <span class="string">"""</span><br><span class="line">    An abstract base class model that provides self-</span><br><span class="line">    updating ``created`` and ``modified`` fields.</span><br><span class="line">    """</span></span><br><span class="line">    created = models.DateTimeField(auto_now_add=<span class="keyword">True</span>)</span><br><span class="line">    modified = models.DateTimeField(auto_now=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </span><br><span class="line">	abstract = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
</div>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> core.models <span class="keyword">import</span> TimeStampedModel</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flavor</span><span class="params">(TimeStampedModel)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">200</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Model Design Ordering</h3>
<div class="outline-text-3" id="text-4-2">
<ol class="org-ol">
<li>Start Normalized<br>
</li>
<li>Cache Before Denormalizing<br>
</li>
<li>Denormalize Only if Absolutely Needed(try cache, row SQL, indexes)<br>
</li>
</ol>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> When to Use Null and Blank</h3>
<div class="outline-text-3" id="text-4-3">
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/table6_2.png" alt="table6_2.png" title=""></i><br>
</p>
</div>
</div>
<div id="outline-container-sec-4-4" class="outline-3">
<h3 id="sec-4-4"><span class="section-number-3">4.4</span> When to Use BinaryField</h3>
<div class="outline-text-3" id="text-4-4">
<p>
<b>Don't Serve Files From BinaryField. Use FileField!!!</b><br>
</p>
<ul class="org-ul">
<li>MessagePack-formatted content.<br>
</li>
<li>Raw sensor data.<br>
</li>
<li>Compressed data e.g. the type of data Sentry stores as a BLOB, but is required to base64-encode due to legacy issues.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-5" class="outline-3">
<h3 id="sec-4-5"><span class="section-number-3">4.5</span> Try to Avoid Using Generic Relations</h3>
<div class="outline-text-3" id="text-4-5">
<p>
Cons:<br>
</p>
<ul class="org-ul">
<li>Reduction in speed of queries due to lack of indexing between models.<br>
</li>
<li>Danger of data corruption as a table can refer to another against a non-existent record.<br>
</li>
</ul>
<p>
So:<br>
</p>
<ul class="org-ul">
<li>Try to avoid generic relations and GenericForeignKey.<br>
</li>
<li>If you think you need generic relations, see if the problem can be solved through better model design or the new PostgreSQL  elds.<br>
</li>
<li>If usage can’t be avoided, try to use an existing third-party app.  e isolation a third-party app provides will help keep data cleaner.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3">
<h3 id="sec-4-6"><span class="section-number-3">4.6</span> The Model meta API</h3>
<div class="outline-text-3" id="text-4-6">
<p>
Main Usages:<br>
</p>
<ul class="org-ul">
<li>Get a list of a model’s fields.<br>
</li>
<li>Get the class of a particular  eld for a model (or its inheritance chain or other info derived from such).<br>
</li>
<li>Ensure that how you get this information remains constant across future Django versions.<br>
</li>
</ul>

<p>
Examples:<br>
</p>
<ul class="org-ul">
<li>Building a Django model introspection tool.<br>
</li>
<li>Building your own custom specialized Django form library.<br>
</li>
<li>Creating admin-like tools to edit or interact with Django model data.<br>
</li>
<li>Writing visualization or analysis libraries, e.g. analyzing info only about  elds that start with “foo”.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-4-7" class="outline-3">
<h3 id="sec-4-7"><span class="section-number-3">4.7</span> Fat Models</h3>
<div class="outline-text-3" id="text-4-7">
<p>
將跟DB有關的邏輯從view中抽出放到Model中包裝是好的設計，但project到最後會發生Model肥大的問題，一個Model數千行這就不好了，底下提供兩個解法<br>
</p>
<ul class="org-ul">
<li>Model Behaviors Pattern: <a href="http://blog.kevinastone.com/django-model-behaviors.html" target="_blank" rel="external">http://blog.kevinastone.com/django-model-behaviors.html</a><br>
</li>
<li>Mixin<br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Queries and the Database Layer</h2>
<div class="outline-text-2" id="text-5">
</div><div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Use get object or 404() for Single Objects instead of get()</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Only use it in views.<br>
</li>
<li>Don’t use it in helper functions, forms, model methods or anything that is not a view or directly view related.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Be Careful With Queries That Might Throw Exceptions</h3>
<div class="outline-text-3" id="text-5-2">
</div><div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"><span class="section-number-4">5.2.1</span> ObjectDoesNotExist vs. DoesNotExist</h4>
<div class="outline-text-4" id="text-5-2-1">
<p>
ObjectDoesNotExist can be applied to any model object, whereas DoesNotExist is for a speci c model.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ObjectDoesNotExist </span><br><span class="line"><span class="keyword">from</span> flavors.models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="keyword">from</span> store.exceptions <span class="keyword">import</span> OutOfStock</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_flavor_line_item</span><span class="params">(sku)</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">return</span> Flavor.objects.get(sku=sku, quantity__gt=<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">except</span> Flavor.DoesNotExist:</span><br><span class="line">	msg = <span class="string">"We are out of {0}"</span>.format(sku) </span><br><span class="line">	<span class="keyword">raise</span> OutOfStock(msg)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_any_line_item</span><span class="params">(model, sku)</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">return</span> model.objects.get(sku=sku, quantity__gt=<span class="number">0</span>) </span><br><span class="line">    <span class="keyword">except</span> ObjectDoesNotExist:</span><br><span class="line">	msg = <span class="string">"We are out of {0}"</span>.format(sku) </span><br><span class="line">	<span class="keyword">raise</span> OutOfStock(msg)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-5-2-2" class="outline-4">
<h4 id="sec-5-2-2"><span class="section-number-4">5.2.2</span> When You Just Want One Object but Get Three Back</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
check for a MultipleObjectsRe- turned exception<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flavors.models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="keyword">from</span> store.exceptions <span class="keyword">import</span> OutOfStock, CorruptedDatabase</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">list_flavor_line_item</span><span class="params">(sku)</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">return</span> Flavor.objects.get(sku=sku, quantity__gt=<span class="number">0</span>) .</span><br><span class="line">    <span class="keyword">except</span> Flavor.DoesNotExist:</span><br><span class="line">	msg = <span class="string">"We are out of {}"</span>.format(sku) </span><br><span class="line">	<span class="keyword">raise</span> OutOfStock(msg)</span><br><span class="line">    <span class="keyword">except</span> Flavor.MultipleObjectsReturned:</span><br><span class="line">	msg = <span class="string">"Multiple items have SKU {}. Please fix!"</span>.format(sku) </span><br><span class="line">	<span class="keyword">raise</span> CorruptedDatabase(msg)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3"><span class="section-number-3">5.3</span> Transactions</h3>
<div class="outline-text-3" id="text-5-3">
</div><div id="outline-container-sec-5-3-1" class="outline-4">
<h4 id="sec-5-3-1"><span class="section-number-4">5.3.1</span> Wrapping Each HTTP Request in a Transaction</h4>
<div class="outline-text-4" id="text-5-3-1">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings/base.py</span></span><br><span class="line">DATABASES = {</span><br><span class="line"><span class="string">'default'</span>: {</span><br><span class="line">	<span class="comment"># ...</span></span><br><span class="line">	<span class="string">'ATOMIC_REQUESTS'</span>: <span class="keyword">True</span>,</span><br><span class="line">	},</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</div>

<p>
non atomic function include atomic code:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404 </span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="decorator">@transaction.non_atomic_requests</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">posting_flavor_status</span><span class="params">(request, pk, status)</span>:</span></span><br><span class="line">    flavor = get_object_or_404(Flavor, pk=pk)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This will execute in autocommit mode (Django's default).</span></span><br><span class="line">    flavor.latest_status_change_attempt = timezone.now()</span><br><span class="line">    flavor.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">    <span class="comment"># This code executes inside a transaction. </span></span><br><span class="line">	flavor.status = status </span><br><span class="line">	flavor.latest_status_</span><br><span class="line">	change_success = timezone.now() </span><br><span class="line">	flavor.save()</span><br><span class="line">	<span class="keyword">return</span> HttpResponse(<span class="string">"Hooray"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If the transaction fails, return the appropriate status </span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Sadness"</span>, status_code=<span class="number">400</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-5-3-2" class="outline-4">
<h4 id="sec-5-3-2"><span class="section-number-4">5.3.2</span> Explicit Transaction Declaration</h4>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Function- and Class-Based Views</h2>
<div class="outline-text-2" id="text-6">
</div><div id="outline-container-sec-6-1" class="outline-3">
<h3 id="sec-6-1"><span class="section-number-3">6.1</span> When to Use FBVs or CBVs</h3>
<div class="outline-text-3" id="text-6-1">
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure8_1.png" alt="figure8_1.png" title=""></i><br>
</p>
</div>
</div>
<div id="outline-container-sec-6-2" class="outline-3">
<h3 id="sec-6-2"><span class="section-number-3">6.2</span> Keep View Logic Out of URLConfs</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Bad Example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> DetailView</span><br><span class="line"><span class="keyword">from</span> tastings.models <span class="keyword">import</span> Tasting</span><br><span class="line"></span><br><span class="line">urlpatterns = [ </span><br><span class="line">    url(<span class="string">r"ˆ(?P&amp;lt;pk&amp;gt;\d+)/$"</span>,</span><br><span class="line">	DetailView.as_view(</span><br><span class="line">	    model=Tasting,</span><br><span class="line">	    template_name=<span class="string">"tastings/detail.html"</span>),</span><br><span class="line">	name=<span class="string">"detail"</span>),</span><br><span class="line">    url(<span class="string">r"ˆ(?P&amp;lt;pk&amp;gt;\d+)/results/$"</span>, </span><br><span class="line">	DetailView.as_view(</span><br><span class="line">	    model=Tasting,</span><br><span class="line">	    template_name=<span class="string">"tastings/results.html"</span>),</span><br><span class="line">	name=<span class="string">"results"</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>

<p>
Good view example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tastings/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView, DetailView, UpdateView </span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Tasting </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasteListView</span><span class="params">(ListView)</span>:</span></span><br><span class="line">    model = Tasting</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasteDetailView</span><span class="params">(DetailView)</span>:</span></span><br><span class="line">    model = Tasting</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasteResultsView</span><span class="params">(TasteDetailView)</span>:</span></span><br><span class="line">    template_name = <span class="string">"tastings/results.html"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasteUpdateView</span><span class="params">(UpdateView)</span>:</span> </span><br><span class="line">    model = Tasting</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_url</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> reverse(<span class="string">"tastings:detail"</span>,</span><br><span class="line">	    kwargs={<span class="string">"pk"</span>: self.object.pk})</span><br></pre></td></tr></table></figure>
</div>

<p>
Good urls example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tastings/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(</span><br><span class="line">	regex=<span class="string">r"ˆ$"</span>, </span><br><span class="line">	view=views.TasteListView.as_view(), </span><br><span class="line">	name=<span class="string">"list"</span></span><br><span class="line">    ),</span><br><span class="line">    url(</span><br><span class="line">	regex=<span class="string">r"ˆ(?P&amp;lt;pk&amp;gt;\d+)/$"</span>, </span><br><span class="line">	view=views.TasteDetailView.as_view(), </span><br><span class="line">	name=<span class="string">"detail"</span></span><br><span class="line">    ), </span><br><span class="line">    url(</span><br><span class="line">	regex=<span class="string">r"ˆ(?P&amp;lt;pk&amp;gt;\d+)/results/$"</span>, </span><br><span class="line">	view=views.TasteResultsView.as_.view(), </span><br><span class="line">	name=<span class="string">"results"</span></span><br><span class="line">    ), </span><br><span class="line">    url(</span><br><span class="line">	regex=<span class="string">r"ˆ(?P&amp;lt;pk&amp;gt;\d+)/update/$"</span>, </span><br><span class="line">	view=views.TasteUpdateView.as_view(), </span><br><span class="line">	name=<span class="string">"update"</span></span><br><span class="line">    ) </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-6-3" class="outline-3">
<h3 id="sec-6-3"><span class="section-number-3">6.3</span> Use URL Namespaces</h3>
<div class="outline-text-3" id="text-6-3">
<p>
In the root URLConf we would add:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># urls.py at root of project</span></span><br><span class="line">urlpatterns += [</span><br><span class="line">    url(<span class="string">r'ˆtastings/'</span>, include(<span class="string">'tastings.urls'</span>, namespace=<span class="string">'tastings'</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>

<p>
view example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># tastings/views.py snippet</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasteUpdateView</span><span class="params">(UpdateView)</span>:</span></span><br><span class="line">    model = Tasting</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_success_url</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> reverse(<span class="string">"tastings:detail"</span>, .</span><br><span class="line">	    kwargs={<span class="string">"pk"</span>: self.object.pk})</span><br></pre></td></tr></table></figure>
</div>

<p>
template example:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">{% extends <span class="string">"base.html"</span> %}</span><br><span class="line">{% block title %}Tastings{% endblock title %}</span><br><span class="line">{% block content %}</span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">  {% <span class="keyword">for</span> taste <span class="keyword">in</span> tastings %} </span><br><span class="line">    &amp;lt;li&amp;gt;</span><br><span class="line">      &amp;lt;a href=<span class="string">"{% url "</span>tastings:detail<span class="string">" taste.pk %}"</span>&amp;gt;{{ taste.title }}&amp;lt;/a&amp;gt;</span><br><span class="line">      &amp;lt;small&amp;gt;</span><br><span class="line">	(&amp;lt;a href=<span class="string">"{% url "</span>tastings:update<span class="string">" taste.pk %}"</span>&amp;gt;update&amp;lt;/a&amp;gt;)</span><br><span class="line">      &amp;lt;/small&amp;gt;</span><br><span class="line">    &amp;lt;/li&amp;gt;</span><br><span class="line">  {% endfor %}</span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br><span class="line">{% endblock content %}</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-6-4" class="outline-3">
<h3 id="sec-6-4"><span class="section-number-3">6.4</span> Django Views Are Functions</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Class-Based Views Are Actually Called as Functions<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># simplest_views.py</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse </span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="comment"># The simplest FBV</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">simplest_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># Business logic goes here </span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"FBV"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The simplest CBV</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimplestView</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">       <span class="comment"># Business logic goes here</span></span><br><span class="line">       <span class="keyword">return</span> HttpResponse(<span class="string">"CBV"</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-6-5" class="outline-3">
<h3 id="sec-6-5"><span class="section-number-3">6.5</span> Don't Use locals() as Views Context</h3>
<div class="outline-text-3" id="text-6-5">
<p>
Bad example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ice_cream_store_display</span><span class="params">(request, store_id)</span>:</span> </span><br><span class="line">    store = get_object_or_404(Store, id=store_id)</span><br><span class="line">    now = timezone.now()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'melted_ice_cream_report.html'</span>, locals())</span><br></pre></td></tr></table></figure>
</div>

<p>
Good example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ice_cream_store_display</span><span class="params">(request, store_id)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'melted_ice_cream_report.html'</span>, dict{</span><br><span class="line">	<span class="string">'store'</span>: get_object_or_404(Store, id=store_id),</span><br><span class="line">	<span class="string">'now'</span>: timezone.now()</span><br><span class="line">    })</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Function-Based Views</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1"><span class="section-number-3">7.1</span> Use Decorator To Modify Request And Response</h3>
<div class="outline-text-3" id="text-7-1">
<p>
Here’s a sample decorator template for use in function-based views:<br>
functools.wraps() is a convenience tool that copies over metadata including critical data like docstrings to the newly decorated function.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># simple decorator template import functools</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(view_func)</span>:</span> </span><br><span class="line"><span class="decorator">    @functools.wraps(view_func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_view_func</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">	<span class="comment"># You can modify the request (HttpRequest) object here. </span></span><br><span class="line">	response = view_func(request, *args, **kwargs)</span><br><span class="line">	<span class="comment"># You can modify the response (HttpResponse) object here. </span></span><br><span class="line">	<span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">return</span> new_view_func</span><br></pre></td></tr></table></figure>
</div>

<p>
check_sprinkles is a decorator to modify request:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sprinkles/decorators.py </span></span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> wraps</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># based off the decorator template from Example 8.5 </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_sprinkles</span><span class="params">(view_func)</span>:</span></span><br><span class="line"><span class="string">"""Check if a user can add sprinkles"""</span> </span><br><span class="line"><span class="decorator">    @wraps(view_func)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new_view_func</span><span class="params">(request, *args, **kwargs)</span>:</span></span><br><span class="line">	<span class="comment"># Act on the request object with utils.can_sprinkle()</span></span><br><span class="line">	request = utils.can_sprinkle(request)</span><br><span class="line">	<span class="comment"># Call the view function</span></span><br><span class="line">	response = view_func(request, *args, **kwargs)</span><br><span class="line">	<span class="comment"># Return the HttpResponse object</span></span><br><span class="line">	<span class="keyword">return</span> response </span><br><span class="line">    <span class="keyword">return</span> new_view_func</span><br></pre></td></tr></table></figure>
</div>

<p>
Then we attach it to the function thus:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render</span><br><span class="line"><span class="keyword">from</span> .decorators <span class="keyword">import</span> check_sprinkles</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Sprinkle</span><br><span class="line"></span><br><span class="line"><span class="comment"># Attach the decorator to the view </span></span><br><span class="line"><span class="decorator">@check_sprinkles</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sprinkle_detail</span><span class="params">(request, pk)</span>:</span></span><br><span class="line">    <span class="string">"""Standard detail view"""</span></span><br><span class="line">    sprinkle = get_object_or_404(Sprinkle, pk=pk)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">"sprinkles/sprinkle_detail.html"</span>,</span><br><span class="line">	{<span class="string">"sprinkle"</span>: sprinkle})</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Class-Based Views</h2>
<div class="outline-text-2" id="text-8">
</div><div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Guidelines When Working With CBVs</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>Less view code is better.<br>
</li>
<li>Never repeat code in views.<br>
</li>
<li>Views should handle presentation logic. Try to keep business logic in models when possible, or in forms if you must.<br>
</li>
<li>Keep your views simple.<br>
</li>
<li>Don’t use CBVs to write custom 403, 404, and 500 error handlers. Use FBVs instead.<br>
</li>
<li>Keep your mixins simpler.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-8-2" class="outline-3">
<h3 id="sec-8-2"><span class="section-number-3">8.2</span> Using Mixins With CBVs</h3>
<div class="outline-text-3" id="text-8-2">
<p>
The rules follow Python’s method resolution order, which in the most simplistic de nition possible, proceeds from left to right:<br>
</p>
<ol class="org-ol">
<li>The base view classes provided by Django always go to the right.<br>
</li>
<li>Mixins go to the left of the base view.<br>
</li>
<li>Mixins should inherit from Python’s built-in object type.<br>
</li>
</ol>

<p>
Example of the rules in action:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> TemplateView </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FreshFruitMixin</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span> </span><br><span class="line">	context = super(FreshFruitMixin,</span><br><span class="line">	    . self).get_context_data(**kwargs)</span><br><span class="line">	context[<span class="string">"has_fresh_fruit"</span>] = <span class="keyword">True</span> </span><br><span class="line">	<span class="keyword">return</span> context</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FruityFlavorView</span><span class="params">(FreshFruitMixin, TemplateView)</span>:</span> </span><br><span class="line">    template_name = <span class="string">"fruity_flavor.html"</span></span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-8-3" class="outline-3">
<h3 id="sec-8-3"><span class="section-number-3">8.3</span> Which Django GCBV Should Be Used for What Task?</h3>
<div class="outline-text-3" id="text-8-3">
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/table10_1.png" alt="table10_1.png" title=""></i><br>
</p>
</div>
</div>
<div id="outline-container-sec-8-4" class="outline-3">
<h3 id="sec-8-4"><span class="section-number-3">8.4</span> General Tips for Django CBVs</h3>
<div class="outline-text-3" id="text-8-4">
</div><div id="outline-container-sec-8-4-1" class="outline-4">
<h4 id="sec-8-4-1"><span class="section-number-4">8.4.1</span> Constraining Django CBV/GCBV Access to Authenticated Users</h4>
<div class="outline-text-4" id="text-8-4-1">
<p>
Use django-braces LoginRequiredMixin<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> DetailView</span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorDetailView</span><span class="params">(LoginRequiredMixin, DetailView)</span>:</span></span><br><span class="line">    model = Flavor</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-8-4-2" class="outline-4">
<h4 id="sec-8-4-2"><span class="section-number-4">8.4.2</span> Performing Custom Actions on Views With Valid Forms</h4>
<div class="outline-text-4" id="text-8-4-2">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> CreateView </span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateView</span><span class="params">(LoginRequiredMixin, CreateView)</span>:</span></span><br><span class="line">    model = Flavor</span><br><span class="line">    fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">	<span class="comment"># Do custom logic here</span></span><br><span class="line">	<span class="keyword">return</span> super(FlavorCreateView, self).form_valid(form)</span><br></pre></td></tr></table></figure>
</div>
<p>
To perform custom logic on form data that has already been validated, simply add the logic to formvalid().  e return value of formvalid() should be a django.http.HttpResponseRedirect.<br>
</p>
</div>
</div>
<div id="outline-container-sec-8-4-3" class="outline-4">
<h4 id="sec-8-4-3"><span class="section-number-4">8.4.3</span> Performing Custom Actions on Views With Invalid Forms</h4>
<div class="outline-text-4" id="text-8-4-3">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> CreateView </span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateView</span><span class="params">(LoginRequiredMixin, CreateView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_invalid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">    <span class="comment"># Do custom logic here .</span></span><br><span class="line">	<span class="keyword">return</span> super(FlavorCreateView, self).form_invalid(form)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-8-4-4" class="outline-4">
<h4 id="sec-8-4-4"><span class="section-number-4">8.4.4</span> Using the View Object</h4>
<div class="outline-text-4" id="text-8-4-4">
<p>
If you are using class-based views for rendering content, consider using the view object itself to provide access to properties and methods that can be called by other method and properties.  ey can also be called from templates. For example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.functional <span class="keyword">import</span> cached_property</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> UpdateView, TemplateView</span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="keyword">from</span> .tasks <span class="keyword">import</span> update_users_who_favorited </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FavoriteMixin</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="decorator">    @cached_property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">likes_and_favorites</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""Returns a dictionary of likes and favorites"""</span> </span><br><span class="line">    likes = self.object.likes()</span><br><span class="line">    favorites = self.object.favorites()</span><br><span class="line">    <span class="keyword">return</span> {</span><br><span class="line">	<span class="string">"likes"</span>: likes,</span><br><span class="line">	<span class="string">"favorites"</span>: favorites,</span><br><span class="line">	<span class="string">"favorites_count"</span>: favorites.count(),</span><br><span class="line">    }</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorUpdateView</span><span class="params">(LoginRequiredMixin, FavoriteMixin, UpdateView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br><span class="line">    fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span> </span><br><span class="line">	update_users_who_favorited(</span><br><span class="line">	    instance=self.object,</span><br><span class="line">	    favorites=self.likes_and_favorites[<span class="string">'favorites'</span>]</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> super(FlavorCreateView, self).form_valid(form)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorDetailView</span><span class="params">(LoginRequiredMixin, FavoriteMixin, TemplateView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br></pre></td></tr></table></figure>
</div>

<p>
The nice thing about this is the various  avors/ app templates can now access this property:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">{<span class="comment"># flavors/base.html #}</span></span><br><span class="line">{% extends <span class="string">"base.html"</span> %}</span><br><span class="line"></span><br><span class="line">{% block likes_and_favorites %} </span><br><span class="line">  &amp;lt;ul&amp;gt;</span><br><span class="line">    &amp;lt;li&amp;gt;Likes: {{ view.likes_and_favorites.likes }}&amp;lt;/li&amp;gt;</span><br><span class="line">    &amp;lt;li&amp;gt;Favorites: {{ view.likes_and_favorites.favorites_count }}&amp;lt;/li&amp;gt; </span><br><span class="line">  &amp;lt;/ul&amp;gt;</span><br><span class="line">{% endblock likes_and_favorites %}</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-8-5" class="outline-3">
<h3 id="sec-8-5"><span class="section-number-3">8.5</span> How GCBVs and Forms Fit Together</h3>
<div class="outline-text-3" id="text-8-5">
<p>
First, let’s define a flavor model to use in this section’s view examples:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line">STATUS = (</span><br><span class="line">    (<span class="number">0</span>, <span class="string">"zero"</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="string">"one"</span>),</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flavor</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    slug = models.SlugField(unique=<span class="keyword">True</span>)</span><br><span class="line">    scoops_remaining = models.IntegerField(default=<span class="number">0</span>, choices=STATUS)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> reverse(<span class="string">"flavors:detail"</span>, kwargs={<span class="string">"slug"</span>: self.slug})</span><br></pre></td></tr></table></figure>
</div>
</div>
<div id="outline-container-sec-8-5-1" class="outline-4">
<h4 id="sec-8-5-1"><span class="section-number-4">8.5.1</span> Views + ModelForm Example</h4>
<div class="outline-text-4" id="text-8-5-1">
<p>
Here we have the following views:<br>
</p>
<ol class="org-ol">
<li>FlavorCreateView corresponds to a form for adding new flavors.<br>
</li>
<li>FlavorUpdateView corresponds to a form for editing existing flavors.<br>
</li>
<li>FlavorDetailView corresponds to the con rmation page for both  avor creation and flavor updates.<br>
</li>
</ol>
<p>
Views:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> messages</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> CreateView, UpdateView, DetailView</span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorActionMixin</span><span class="params">(object)</span>:</span></span><br><span class="line">    fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br><span class="line"><span class="decorator">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">success_msg</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">NotImplemented</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">	messages.info(self.request, self.success_msg)</span><br><span class="line">	<span class="keyword">return</span> super(FlavorActionMixin, self).form_valid(form)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateView</span><span class="params">(LoginRequiredMixin, FlavorActionMixin, CreateView)</span>:</span></span><br><span class="line">    model = Flavor</span><br><span class="line">    success_msg = <span class="string">"Flavor created!"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorUpdateView</span><span class="params">(LoginRequiredMixin, FlavorActionMixin, UpdateView)</span>:</span></span><br><span class="line">    model = Flavor</span><br><span class="line">    success_msg = <span class="string">"Flavor updated!"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorDetailView</span><span class="params">(DetailView)</span>:</span></span><br><span class="line">    model = Flavor</span><br></pre></td></tr></table></figure>
</div>

<p>
Template:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">{# templates/flavors/flavor_detail.html #}</span><br><span class="line">{% if messages %}</span><br><span class="line">  &amp;lt;ul class="messages"&amp;gt;</span><br><span class="line">    {% for message in messages %}</span><br><span class="line">    &amp;lt;li id="message_{{ forloop.counter }}"</span><br><span class="line">	{% if message.tags %} class="{{ message.tags }}" .</span><br><span class="line">	  {% endif %}&amp;gt;</span><br><span class="line">	{{ message }}</span><br><span class="line">    &amp;lt;/li&amp;gt;</span><br><span class="line">    {% endfor %} </span><br><span class="line">  &amp;lt;/ul&amp;gt;</span><br><span class="line">{% endif %}</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-8-5-2" class="outline-4">
<h4 id="sec-8-5-2"><span class="section-number-4">8.5.2</span> Views + Form Example</h4>
<div class="outline-text-4" id="text-8-5-2">
<p>
Implemente flavor search page<br>
We add the following code to flavors/views.py:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorListView</span><span class="params">(ListView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># Fetch the queryset from the parent get_queryset</span></span><br><span class="line">	queryset = super(FlavorListView, self).get_queryset()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Get the q GET parameter</span></span><br><span class="line">	q = self.request.GET.get(<span class="string">"q"</span>) </span><br><span class="line">	<span class="keyword">if</span> q:</span><br><span class="line">	    <span class="comment"># Return a filtered queryset</span></span><br><span class="line">	    <span class="keyword">return</span> queryset.filter(title__icontains=q) </span><br><span class="line">	<span class="comment"># Return the base queryset</span></span><br><span class="line">	<span class="keyword">return</span> queryset</span><br></pre></td></tr></table></figure>
</div>

<p>
Template:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">{<span class="comment"># templates/flavors/_flavor_search.html #}</span></span><br><span class="line">{% comment %}</span><br><span class="line">  Usage: {% include <span class="string">"flavors/_flavor_search.html"</span> %}</span><br><span class="line">{% endcomment %}</span><br><span class="line">&amp;lt;form action=<span class="string">"{% url "</span>flavor_list<span class="string">" %}"</span> .method=<span class="string">"GET"</span>&amp;gt;</span><br><span class="line">  &amp;lt;input type=<span class="string">"text"</span> name=<span class="string">"q"</span> /&amp;gt;</span><br><span class="line">  &amp;lt;button type=<span class="string">"submit"</span>&amp;gt;search&amp;lt;/button&amp;gt; </span><br><span class="line">&amp;lt;/form&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-8-6" class="outline-3">
<h3 id="sec-8-6"><span class="section-number-3">8.6</span> Using Just django.views.generic.View</h3>
<div class="outline-text-3" id="text-8-6">
<p>
What we find really useful, even on projects which use a lot of generic class-based views, is using the django.views.generic.View class with a GET method for displaying JSON, PDF or other non-HTML content. All the tricks that we’ve used for rendering CSV, Excel, and PDF  les in function-based views apply when using the GET method. For example:<br>
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse .</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="keyword">from</span> .reports <span class="keyword">import</span> make_flavor_pdf</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PDFFlavorView</span><span class="params">(LoginRequiredMixin, View)</span>:</span> </span><br><span class="line">    <span class="comment"># Get the flavor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">	flavor = get_object_or_404(Flavor, slug=kwargs[<span class="string">'slug'</span>])</span><br><span class="line">	<span class="comment"># create the response</span></span><br><span class="line">	response = HttpResponse(content_type=<span class="string">'application/pdf'</span>)</span><br><span class="line">	<span class="comment"># generate the PDF stream and attach to the response</span></span><br><span class="line">	response = make_flavor_pdf(response, flavor)</span><br><span class="line">	<span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Form Fundamentals</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1"><span class="section-number-3">9.1</span> Validate All Incoming Data With Django Forms</h3>
<div class="outline-text-3" id="text-9-1">
<p>
舉個input data為csv file的例子<br>
Bad Example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Purchase </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_csv_purchases</span><span class="params">(rows)</span>:</span></span><br><span class="line">    rows = StringIO.StringIO(rows)</span><br><span class="line">    records_added = <span class="number">0</span></span><br><span class="line">    <span class="comment"># Generate a dict per row, with the first CSV row being the keys </span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> csv.DictReader(rows, delimiter=<span class="string">","</span>):</span><br><span class="line">	<span class="comment"># DON'T DO THIS: Tossing unvalidated data into your model.</span></span><br><span class="line">	Purchase.objects.create(**row)</span><br><span class="line">	records_added += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> records_added</span><br></pre></td></tr></table></figure>
</div>
<p>
以上Bad example在Purchase create前需要自己寫input data驗證code<br>
</p>

<p>
Good Example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> csv <span class="keyword">import</span> StringIO</span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Purchase, Seller </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PurchaseForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">	model = Purchase</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_seller</span><span class="params">(self)</span>:</span></span><br><span class="line">	seller = self.cleaned_data[<span class="string">"seller"</span>] </span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">	    Seller.objects.get(name=seller) </span><br><span class="line">	<span class="keyword">except</span> Seller.DoesNotExist:</span><br><span class="line">	    msg = <span class="string">"{0} does not exist in purchase #{1}."</span>.format(</span><br><span class="line">		seller,</span><br><span class="line">		self.cleaned_data[<span class="string">"purchase_number"</span>]</span><br><span class="line">	    )</span><br><span class="line">	<span class="keyword">raise</span> forms.ValidationError(msg) <span class="keyword">return</span> seller</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_csv_purchases</span><span class="params">(rows)</span>:</span></span><br><span class="line">    rows = StringIO.StringIO(rows)</span><br><span class="line">    records_added = <span class="number">0</span></span><br><span class="line">    errors = []</span><br><span class="line">    <span class="comment"># Generate a dict per row, with the first CSV row being the k</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> csv.DictReader(rows, delimiter=<span class="string">","</span>):</span><br><span class="line">	<span class="comment"># Bind the row data to the PurchaseForm. </span></span><br><span class="line">	form = PurchaseForm(row)</span><br><span class="line">	<span class="comment"># Check to see if the row data is valid. </span></span><br><span class="line">	<span class="keyword">if</span> form.is_valid():</span><br><span class="line">	    <span class="comment"># Row data is valid so save the record.</span></span><br><span class="line">	    form.save()</span><br><span class="line">	    records_added += <span class="number">1</span></span><br><span class="line">	<span class="keyword">else</span>: </span><br><span class="line">	    errors.append(form.errors)</span><br><span class="line">    <span class="keyword">return</span> recordded, errors</span><br></pre></td></tr></table></figure>
</div>
<p>
利用django ModelForm的is_valid來做input驗證<br>
</p>
</div>
</div>
<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2"><span class="section-number-3">9.2</span> Always Use CSRF Protection and POST With HTTP Forms That Modify Data</h3>
<div class="outline-text-3" id="text-9-2">
<p>
You should use Django’s CsrfViewMiddleware as blanket protection across your site rather than manually decorating views with csrf protect.<br>
You should use Django’s CSRF protection even when posting data via AJAX.<br>
</p>
</div>
</div>
<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3"><span class="section-number-3">9.3</span> Understand How to Add Django Form Instance Attributes</h3>
<div class="outline-text-3" id="text-9-3">
<p>
Inserting the request.user object into forms<br>
form:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Taster</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasterForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">	model = Taster</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">	<span class="comment"># set the user as an attribute of the form </span></span><br><span class="line">	self.user = kwargs.pop(<span class="string">'user'</span>)</span><br><span class="line">	super(TasterForm, self).__init__(*args, **kwargs)</span><br></pre></td></tr></table></figure>
</div>

<p>
view:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> UpdateView </span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> TasterForm </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Taster</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TasterUpdateView</span><span class="params">(LoginRequiredMixin, UpdateView)</span>:</span> </span><br><span class="line">    model = Taster</span><br><span class="line">    form_class = TasterForm</span><br><span class="line">    success_url = <span class="string">"/someplace/"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_form_kwargs</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="string">"""This method is what injects forms with their keyword arguments."""</span> </span><br><span class="line">	<span class="comment"># grab the current set of form #kwargs</span></span><br><span class="line">	kwargs = super(TasterUpdateView, self).get_form_kwargs()</span><br><span class="line">	<span class="comment"># Update the kwargs with the user_id</span></span><br><span class="line">	kwargs[<span class="string">'user'</span>] = self.request.user</span><br><span class="line">	<span class="keyword">return</span> kwargs</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4"><span class="section-number-3">9.4</span> Know How Form Validation Works</h3>
<div class="outline-text-3" id="text-9-4">
<p>
Form validation workflow:<br>
</p>
<ul class="org-ul">
<li>If the form has bound data, form.is valid() calls the form.full clean() method.<br>
</li>
<li>form.fullclean() iterates through the form fields and each field validates itself:<br>
<ul class="org-ul">
<li>Data coming into the  eld is coerced into Python via the to python() method or raises a ValidationError.<br>
</li>
<li>Data is validated against  eld-speci c rules, including custom validators. Failure raises a ValidationError.<br>
</li>
<li>If there are any custom clean &lt;field&gt;() methods in the form, they are called at this time.<br>
</li>
</ul>
</li>
<li>form.fullclean() executes the form.clean() method.<br>
</li>
<li>If it’s a ModelForm instance, form. post clean() does the following:<br>
<ul class="org-ul">
<li>Sets ModelForm data to the Model instance, regardless of whether form.is valid() is True or False.<br>
</li>
<li>Calls the model’s clean() method. For reference, saving a model instance through the ORM does not call the model’s clean() method.<br>
</li>
</ul>
</li>
</ul>
</div>
<div id="outline-container-sec-9-4-1" class="outline-4">
<h4 id="sec-9-4-1"><span class="section-number-4">9.4.1</span> ModelForm Data Is Saved to the Form, Then the Model In- stance</h4>
<div class="outline-text-4" id="text-9-4-1">
<p>
In a ModelForm, form data is saved in two distinct steps:<br>
</p>
<ol class="org-ol">
<li>First, form data is saved to the form instance.<br>
</li>
<li>Later, form data is saved to the model instance.<br>
</li>
</ol>

<p>
For example, perhaps you need to catch the details of failed submission attempts for a form, saving both the user-supplied form data as well as the intended model instance changes.<br>
</p>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ModelFormFailureHistory</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    form_data = models.TextField()</span><br><span class="line">    model_data = models.TextField()</span><br></pre></td></tr></table></figure>
</div>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views.py import json</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> messages </span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> core.models <span class="keyword">import</span> ModelFormFailureHistory </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorActionMixin</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="decorator">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">success_msg</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">NotImplemented</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">	messages.info(self.request, self.success_msg)</span><br><span class="line">	<span class="keyword">return</span> super(FlavorActionMixin, self).form_valid(form)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_invalid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">	<span class="string">"""Save invalid form and model data for later reference."""</span> </span><br><span class="line">	form_data = json.dumps(form.cleaned_data)</span><br><span class="line">	model_data = serializers.serialize(<span class="string">"json"</span>,</span><br><span class="line">		    [form.instance])[<span class="number">1</span>:-<span class="number">1</span>]</span><br><span class="line">	ModelFormFailureHistory.objects.create(</span><br><span class="line">	    form_data=form_data,</span><br><span class="line">	    model_data=model_data</span><br><span class="line">	)</span><br><span class="line">	<span class="keyword">return</span> super(FlavorActionMixin, self).form_invalid(form)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5"><span class="section-number-3">9.5</span> Add Errors to Forms with Form.add error()</h3>
<div class="outline-text-3" id="text-9-5">
<p>
We can streamline Form.clean() with the Form.add error() method.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamReviewForm</span><span class="params">(forms.Form)</span>:</span> </span><br><span class="line">    <span class="comment"># Rest of tester form goes here ...</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">	cleaned_data = super(TasterForm, self).clean()</span><br><span class="line">	flavor = cleaned_data.get(<span class="string">"flavor"</span>)</span><br><span class="line">	age = cleaned_data.get(<span class="string">"age"</span>)</span><br><span class="line">	<span class="keyword">if</span> flavor == <span class="string">'coffee'</span> <span class="keyword">and</span> age &amp;lt; <span class="number">3</span>:</span><br><span class="line">	    <span class="comment"># Record errors that will be displayed later. </span></span><br><span class="line">	    msg = <span class="string">u"Coffee Ice Cream is not for Babies."</span> </span><br><span class="line">	    self.add_error(<span class="string">'flavor'</span>, msg) </span><br><span class="line">	    self.add_error(<span class="string">'age'</span>, msg)</span><br><span class="line">	<span class="comment"># Always return the full collection of cleaned data. </span></span><br><span class="line">	<span class="keyword">return</span> cleaned_data</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> Common Patterns for Forms</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1"><span class="section-number-3">10.1</span> Pattern 1: Simple ModelForm With Default Validators</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> CreateView, UpdateView</span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateView</span><span class="params">(LoginRequiredMixin, CreateView)</span>:</span></span><br><span class="line">    model = Flavor</span><br><span class="line">    fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorUpdateView</span><span class="params">(LoginRequiredMixin, UpdateView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br><span class="line">    fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br></pre></td></tr></table></figure>
</div>
<ul class="org-ul">
<li>FlavorCreateView and FlavorUpdateView are assigned Flavor as their model.<br>
</li>
<li>Both views auto-generate a ModelForm based on the Flavor model.<br>
</li>
<li>Those ModelForms rely on the default field validation rules of the Flavor model.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2"><span class="section-number-3">10.2</span> Pattern 2: Custom Form Field Validators in ModelForms</h3>
<div class="outline-text-3" id="text-10-2">
<p>
write validator:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/validators.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ValidationError</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_tasty</span><span class="params">(value)</span>:</span></span><br><span class="line">    <span class="string">"""Raise a ValidationError if the value doesn't start with the word 'Tasty'."""</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> value.startswith(<span class="string">u"Tasty"</span>): </span><br><span class="line">	msg = <span class="string">u"Must start with Tasty"</span> </span><br><span class="line">	<span class="keyword">raise</span> ValidationError(msg)</span><br></pre></td></tr></table></figure>
</div>
<p>
In Django, a custom field validator is simply a function that raises an error if the submitted argument doesn’t pass its test.<br>
</p>

<p>
validator可以加在兩個地方<br>
</p>
</div>
<div id="outline-container-sec-10-2-1" class="outline-4">
<h4 id="sec-10-2-1"><span class="section-number-4">10.2.1</span> put validator in Model</h4>
<div class="outline-text-4" id="text-10-2-1">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> .validators <span class="keyword">import</span> validate_tasty </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TastyTitleAbstractModel</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>, validators=[validate_tasty])</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span> </span><br><span class="line">	abstract = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
</div>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> core.models <span class="keyword">import</span> TastyTitleAbstractModel .</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flavor</span><span class="params">(TastyTitleAbstractModel)</span>:</span></span><br><span class="line">    slug = models.SlugField()</span><br><span class="line">    scoops_remaining = models.IntegerField(default=<span class="number">0</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> reverse(<span class="string">"flavors:detail"</span>, kwargs={<span class="string">"slug"</span>: self.slug})</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-10-2-2" class="outline-4">
<h4 id="sec-10-2-2"><span class="section-number-4">10.2.2</span> put validator in Form</h4>
<div class="outline-text-4" id="text-10-2-2">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> core.validators <span class="keyword">import</span> validate_tasty <span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">	super(FlavorForm, self).__init__(*args, **kwargs)</span><br><span class="line">	self.fields[<span class="string">"title"</span>].validators.append(validate_tasty)</span><br><span class="line">	self.fields[<span class="string">"slug"</span>].validators.append(validate_tasty)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">	model = Flavor</span><br></pre></td></tr></table></figure>
</div>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> messages</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> CreateView, UpdateView, DetailView</span><br><span class="line"><span class="keyword">from</span> braces.views <span class="keyword">import</span> LoginRequiredMixin </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> FlavorForm </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorActionMixin</span><span class="params">(object)</span>:</span></span><br><span class="line">    model = Flavor</span><br><span class="line">    fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br><span class="line"><span class="decorator">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">success_msg</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">NotImplemented</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span> </span><br><span class="line">	messages.info(self.request, self.success_msg)</span><br><span class="line">	<span class="keyword">return</span> super(FlavorActionMixin, self).form_valid(form)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateView</span><span class="params">(LoginRequiredMixin, FlavorActionMixin, CreateView)</span>:</span></span><br><span class="line">    success_msg = <span class="string">"created"</span></span><br><span class="line">    <span class="comment"># Explicitly attach the FlavorForm class</span></span><br><span class="line">    form_class = FlavorForm</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorUpdateView</span><span class="params">(LoginRequiredMixin, FlavorActionMixin, UpdateView)</span>:</span></span><br><span class="line">    success_msg = <span class="string">"updated"</span></span><br><span class="line">    <span class="comment"># Explicitly attach the FlavorForm class</span></span><br><span class="line">    form_class = FlavorForm</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorDetailView</span><span class="params">(DetailView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3"><span class="section-number-3">10.3</span> Pattern 3: Overriding the Clean Stage of Validation</h3>
<div class="outline-text-3" id="text-10-3">
<p>
use cases:<br>
</p>
<ul class="org-ul">
<li>Multi-field validation<br>
</li>
<li>Validation involving existing data from the database that has already been validate<br>
</li>
</ul>

<p>
Django provides a second stage and process for validating incoming data, this time via the clean() method and clean &lt;field name&gt;() methods.<br>
</p>
<ul class="org-ul">
<li>clean() validate two or more fields against each other.<br>
</li>
<li>clean &lt;field name&gt;() validate against persistent data.<br>
</li>
</ul>

<p>
Example:<br>
clean slug(): prevent users from ordering flavors that are out of stock<br>
clean(): validate the flavor and toppings fields against each other<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> flavors.models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamOrderForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    <span class="string">"""Normally done with forms.ModelForm. But we use forms.Form here</span><br><span class="line">	to demonstrate that these sorts of techniques work on every</span><br><span class="line">	type of form.</span><br><span class="line">    """</span></span><br><span class="line">    slug = forms.ChoiceField(<span class="string">"Flavor"</span>)</span><br><span class="line">    toppings = forms.CharField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span> </span><br><span class="line">	super(IceCreamOrderForm, self).__init__(*args,</span><br><span class="line">		**kwargs)</span><br><span class="line">	<span class="comment"># We dynamically set the choices here rather than</span></span><br><span class="line">	<span class="comment"># in the flavor field definition. Setting them in</span></span><br><span class="line">	<span class="comment"># the field definition means status updates won't</span></span><br><span class="line">	<span class="comment"># be reflected in the form without server restarts.</span></span><br><span class="line">	self.fields[<span class="string">"slug"</span>].choices = [</span><br><span class="line">	    (x.slug, x.title) <span class="keyword">for</span> x <span class="keyword">in</span> Flavor.objects.all() </span><br><span class="line">	]</span><br><span class="line">	<span class="comment"># <span class="doctag">NOTE:</span> We could filter by whether or not a flavor</span></span><br><span class="line">	<span class="comment">#       has any scoops, but this is an example of</span></span><br><span class="line">	<span class="comment">#       how to use clean_slug, not filter().</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_slug</span><span class="params">(self)</span>:</span></span><br><span class="line">	slug = self.cleaned_data[<span class="string">"slug"</span>]</span><br><span class="line">	<span class="keyword">if</span> Flavor.objects.get(slug=slug).scoops_remaining &amp;lt;= <span class="number">0</span>:</span><br><span class="line">	    msg = <span class="string">u"Sorry, we are out of that flavor."</span></span><br><span class="line">	    <span class="keyword">raise</span> forms.ValidationError(msg) </span><br><span class="line">	<span class="keyword">return</span> slug</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">	cleaned_data = super(IceCreamOrderForm, self).clean()</span><br><span class="line">	slug = cleaned_data.get(<span class="string">"slug"</span>, <span class="string">""</span>)</span><br><span class="line">	toppings = cleaned_data.get(<span class="string">"toppings"</span>, <span class="string">""</span>)</span><br><span class="line">	<span class="comment"># Silly "too much chocolate" validation example</span></span><br><span class="line">	<span class="keyword">if</span> <span class="string">u"chocolate"</span> <span class="keyword">in</span> slug.lower() <span class="keyword">and</span> \ <span class="string">u"chocolate"</span> <span class="keyword">in</span> toppings.lower():</span><br><span class="line">	    msg = <span class="string">u"Your order has too much chocolate."</span></span><br><span class="line">	    <span class="keyword">raise</span> forms.ValidationError(msg) <span class="keyword">return</span> cleaned_data</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-10-4" class="outline-3">
<h3 id="sec-10-4"><span class="section-number-3">10.4</span> Pattern 4: Hacking Form Fields (2 CBVs, 2 Forms, 1 Model)</h3>
<div class="outline-text-3" id="text-10-4">
<p>
example:<br>
IceCreamStore在create時只需要填入title, address，update時再強制其補上phone, description<br>
</p>

<p>
IceCreamStore Model:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStore</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>) </span><br><span class="line">    block_address = models.TextField() .</span><br><span class="line">    phone = models.CharField(max_length=<span class="number">20</span>, blank=<span class="keyword">True</span>) </span><br><span class="line">    description = models.TextField(blank=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> reverse(<span class="string">"store_detail"</span>, kwargs={<span class="string">"pk"</span>: self.pk})</span><br></pre></td></tr></table></figure>
</div>

<p>
First we see the bad approach:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># stores/forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> IceCreamStore</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStoreUpdateForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="comment"># Don't do this! Duplication of the model field!</span></span><br><span class="line">    phone = forms.CharField(required=<span class="keyword">True</span>)</span><br><span class="line">    <span class="comment"># Don't do this! Duplication of the model field!</span></span><br><span class="line">    description = forms.TextField(required=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    model = IceCreamStore</span><br></pre></td></tr></table></figure>
</div>
<p>
上面的方法幾乎是copy了model中的field，想像一下若我們需要在description中加入help text，就必須同時在model與form中同時加上不然沒有作用，這不是一個好的設計<br>
</p>

<p>
Now we use form.fields[].required to do this.<br>
Form:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># stores/forms.py</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> IceCreamStore</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStoreCreateForm</span><span class="params">(forms.ModelForm)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">	model = IceCreamStore</span><br><span class="line">	fields = (<span class="string">"title"</span>, <span class="string">"block_address"</span>, )</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStoreUpdateForm</span><span class="params">(IceCreamStoreCreateForm)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *args, **kwargs)</span>:</span> </span><br><span class="line">	super(IceCreamStoreUpdateForm,</span><br><span class="line">		self).__init__(*args, **kwargs)</span><br><span class="line">	self.fields[<span class="string">"phone"</span>].required = <span class="keyword">True</span></span><br><span class="line">	self.fields[<span class="string">"description"</span>].required = <span class="keyword">True</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span><span class="params">(IceCreamStoreCreateForm.Meta)</span>:</span></span><br><span class="line">	<span class="comment"># show all the fields!</span></span><br><span class="line">	fields = (<span class="string">"title"</span>, <span class="string">"block_address"</span>, <span class="string">"phone"</span>, <span class="string">"description"</span>, )</span><br></pre></td></tr></table></figure>
</div>
<p>
Views:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># stores/views</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> CreateView, UpdateView</span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> IceCreamStoreCreateForm </span><br><span class="line"><span class="keyword">from</span> .forms <span class="keyword">import</span> IceCreamStoreUpdateForm </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> IceCreamStore</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamCreateView</span><span class="params">(CreateView)</span>:</span></span><br><span class="line">    model = IceCreamStore</span><br><span class="line">    form_class = IceCreamStoreCreateForm</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamUpdateView</span><span class="params">(UpdateView)</span>:</span> </span><br><span class="line">    model = IceCreamStore</span><br><span class="line">    form_class = IceCreamStoreUpdateForm</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-10-5" class="outline-3">
<h3 id="sec-10-5"><span class="section-number-3">10.5</span> Pattern 5: Reusable Search Mixin View</h3>
<div class="outline-text-3" id="text-10-5">
<p>
In this example, we’re going to cover how to reuse a search form in two views that correspond to two different models.<br>
simple search mixin for our view:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/views.py</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TitleSearchMixin</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="comment"># Fetch the queryset from the parent's get_queryset </span></span><br><span class="line">	queryset = super(TitleSearchMixin, self).get_queryset()</span><br><span class="line">	<span class="comment"># Get the q GET parameter</span></span><br><span class="line">	q = self.request.GET.get(<span class="string">"q"</span>) </span><br><span class="line">	<span class="keyword">if</span> q:</span><br><span class="line">	    <span class="comment"># return a filtered queryset</span></span><br><span class="line">	    <span class="keyword">return</span> queryset.filter(title__icontains=q) </span><br><span class="line">	<span class="comment"># No q is specified so we return queryset </span></span><br><span class="line">	<span class="keyword">return</span> queryset</span><br></pre></td></tr></table></figure>
</div>

<p>
views:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add to flavors/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView</span><br><span class="line"><span class="keyword">from</span> core.views <span class="keyword">import</span> TitleSearchMixin </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorListView</span><span class="params">(TitleSearchMixin, ListView)</span>:</span> </span><br><span class="line">    model = Flavor</span><br></pre></td></tr></table></figure>
</div>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add to store/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> ListView</span><br><span class="line"><span class="keyword">from</span> core.views <span class="keyword">import</span> TitleSearchMixin </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Store</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStoreListView</span><span class="params">(TitleSearchMixin, ListView)</span>:</span></span><br><span class="line">    model = Store</span><br></pre></td></tr></table></figure>
</div>

<p>
template:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{# form to go into stores/store_list.html template #} </span><br><span class="line">&amp;lt;form action="" method="GET"&amp;gt;</span><br><span class="line">  &amp;lt;input type="text" name="q" /&amp;gt; </span><br><span class="line">  &amp;lt;button type="submit"&amp;gt;search&amp;lt;/button&amp;gt;</span><br><span class="line">&amp;lt;/form&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{# form to go into flavors/flavor_list.html template #} </span><br><span class="line">&amp;lt;form action="" method="GET"&amp;gt;</span><br><span class="line">  &amp;lt;button type="submit"&amp;gt;search&amp;lt;/button&amp;gt;</span><br><span class="line">  &amp;lt;input type="text" name="q" /&amp;gt; </span><br><span class="line">&amp;lt;/form&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11"><span class="section-number-2">11</span> Templates</h2>
<div class="outline-text-2" id="text-11">
</div><div id="outline-container-sec-11-1" class="outline-3">
<h3 id="sec-11-1"><span class="section-number-3">11.1</span> Keep Templates Mostly in templates/</h3>
<div class="outline-text-3" id="text-11-1">
<p>
Template layout:<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">templates/</span><br><span class="line">    base.html</span><br><span class="line">    ... (other sitewide templates <span class="keyword">in</span> here)</span><br><span class="line">    freezers/</span><br><span class="line">	(<span class="string">"freezers"</span> app templates <span class="keyword">in</span> here)</span><br></pre></td></tr></table></figure>
</div>

<p>
However, some tutorials advocate putting templates within a subdirectory of each app. We find that the extra nesting is a pain to deal with<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">freezers/</span><br><span class="line">    templates/</span><br><span class="line">	freezers/</span><br><span class="line">	    ... (<span class="string">"freezers"</span> app templates <span class="keyword">in</span> here)</span><br><span class="line">templates/</span><br><span class="line">    base.html</span><br><span class="line">    ... (other sitewide templates <span class="keyword">in</span> here)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-11-2" class="outline-3">
<h3 id="sec-11-2"><span class="section-number-3">11.2</span> Template Architecture Patterns</h3>
<div class="outline-text-3" id="text-11-2">
</div><div id="outline-container-sec-11-2-1" class="outline-4">
<h4 id="sec-11-2-1"><span class="section-number-4">11.2.1</span> 2-Tier Template Architecture Example</h4>
<div class="outline-text-4" id="text-11-2-1">
<p>
all templates inherit from a single root base.html<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">templates/</span><br><span class="line">    base.html</span><br><span class="line">    dashboard.html <span class="comment"># extends base.html</span></span><br><span class="line">    profiles/</span><br><span class="line">	profile_detail.html <span class="comment"># extends base.html</span></span><br><span class="line">	profile_form.html <span class="comment"># extends base.html</span></span><br></pre></td></tr></table></figure>
</div>
<p>
This is best for sites with a consistent overall layout from app to app.<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-2-2" class="outline-4">
<h4 id="sec-11-2-2"><span class="section-number-4">11.2.2</span> 3-Tier Template Architecture Example</h4>
<div class="outline-text-4" id="text-11-2-2">
<ul class="org-ul">
<li>Each app has a base_&lt;app name&gt;.html template. App-level base templates share a common parent base.html template.<br>
</li>
<li>Templates within apps share a common parent base_&lt;app name&gt;.html template.<br>
</li>
<li>Any template at the same level as base.html inherits base.html.<br>
</li>
</ul>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">templates/</span><br><span class="line">    base.html</span><br><span class="line">    dashboard.html <span class="comment"># extends base.html</span></span><br><span class="line">    profiles/</span><br><span class="line">	base_profiles.html <span class="comment"># extends base.html</span></span><br><span class="line">	profile_detail.html <span class="comment"># extends base_profiles.html</span></span><br><span class="line">	profile_form.html <span class="comment"># extends base_profiles.html</span></span><br></pre></td></tr></table></figure>
</div>
<p>
The 3-tier architecture is best for websites where each section requires a distinctive layout. For example, a news site might have a local news section, a classified ads section, and an events section. Each of these sections requires its own custom layout.<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-2-3" class="outline-4">
<h4 id="sec-11-2-3"><span class="section-number-4">11.2.3</span> Flat Is Better Than Nested</h4>
<div class="outline-text-4" id="text-11-2-3">
<p>
template層數越少越好維護<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-11-3" class="outline-3">
<h3 id="sec-11-3"><span class="section-number-3">11.3</span> Limit Processing in Templates</h3>
<div class="outline-text-3" id="text-11-3">
<p>
Whenever you iterate over a queryset in a template, ask yourself the following questions:<br>
</p>
<ul class="org-ul">
<li>How large is the queryset? Looping over gigantic querysets in your templates is almost always a bad idea.<br>
</li>
<li>How large are the objects being retrieved? Are all the fields needed in this template?<br>
</li>
<li>During each iteration of the loop, how much processing occurs?<br>
</li>
</ul>

<p>
Let’s now explore some examples of template code that can be rewritten more efficiently.<br>
Model:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vouchers/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> .managers <span class="keyword">import</span> VoucherManager</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Voucher</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="string">"""Vouchers for free pints of ice c.ream."""</span> </span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>) </span><br><span class="line">    email = models.EmailField()</span><br><span class="line">    address = models.TextField()</span><br><span class="line">    birth_date = models.DateField(blank=<span class="keyword">True</span>) </span><br><span class="line">    sent = models.BooleanField(default=<span class="keyword">False</span>) </span><br><span class="line">    redeemed = models.BooleanField(default=<span class="keyword">False</span>)</span><br><span class="line">    objects = VoucherManager()</span><br></pre></td></tr></table></figure>
</div>
</div>
<div id="outline-container-sec-11-3-1" class="outline-4">
<h4 id="sec-11-3-1"><span class="section-number-4">11.3.1</span> Gotcha 1: Aggregation in Templates</h4>
<div class="outline-text-4" id="text-11-3-1">
<ul class="org-ul">
<li>Don’t iterate over the entire voucher list in your template’s JavaScript section, using JavaScript variables to hold age range counts.<br>
</li>
<li>Don’t use the add template  lter to sum up the voucher counts.<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-11-3-2" class="outline-4">
<h4 id="sec-11-3-2"><span class="section-number-4">11.3.2</span> Gotcha 2: Filtering With Conditionals in Templates</h4>
<div class="outline-text-4" id="text-11-3-2">
<p>
A very bad way to implement this would be with giant loops and if statements at the template level.<br>
Bad Example:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&amp;lt;h2&amp;gt;Greenfelds Who Want Ice Cream&amp;lt;/h2&amp;gt; </span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">{% <span class="keyword">for</span> voucher <span class="keyword">in</span> voucher_list %}</span><br><span class="line">    {<span class="comment"># Don't do this: conditional filtering in templates #}</span></span><br><span class="line">    {% <span class="keyword">if</span> <span class="string">"greenfeld"</span> <span class="keyword">in</span> voucher.name.lower %}</span><br><span class="line">	&amp;lt;li&amp;gt;{{ voucher.name }}&amp;lt;/li&amp;gt; </span><br><span class="line">    {% endif %}</span><br><span class="line">{% endfor %} </span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br><span class="line"></span><br><span class="line">&amp;lt;h2&amp;gt;Roys Who Want Ice Cream&amp;lt;/h2&amp;gt; </span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">{% <span class="keyword">for</span> voucher <span class="keyword">in</span> voucher_list %}</span><br><span class="line">    {<span class="comment"># Don't do this: conditional filtering in templates #}</span></span><br><span class="line">    {% <span class="keyword">if</span> <span class="string">"roy"</span> <span class="keyword">in</span> voucher.name.lower %}</span><br><span class="line">	&amp;lt;li&amp;gt;{{ voucher.name }}&amp;lt;/li&amp;gt; </span><br><span class="line">    {% endif %}</span><br><span class="line">{% endfor %} </span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>

<p>
Good Example<br>
views:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vouchers/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> TemplateView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Voucher</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GreenfeldRoyView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line">    template_name = <span class="string">"vouchers/views_conditional.html"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">	context = super(GreenfeldRoyView, self).get_context_data(**kwargs) </span><br><span class="line">	context[<span class="string">"greenfelds"</span>] = Voucher.objects.filter(name__icontains=<span class="string">"greenfeld"</span>) </span><br><span class="line">	context[<span class="string">"roys"</span>] = Voucher.objects.filter(name__icontains=<span class="string">"roy"</span>) </span><br><span class="line">	<span class="keyword">return</span> context</span><br></pre></td></tr></table></figure>
</div>
<p>
template:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&amp;lt;h2&amp;gt;Greenfelds Who Want Ice Cream&amp;lt;/h2&amp;gt; </span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">{% <span class="keyword">for</span> voucher <span class="keyword">in</span> greenfelds %}</span><br><span class="line">    &amp;lt;li&amp;gt;{{ voucher.name }}&amp;lt;/li&amp;gt; </span><br><span class="line">{% endfor %}</span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br><span class="line"></span><br><span class="line">&amp;lt;h2&amp;gt;Roys Who Want Ice Cream&amp;lt;/h2&amp;gt; </span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">{% <span class="keyword">for</span> voucher <span class="keyword">in</span> roys %}</span><br><span class="line">    &amp;lt;li&amp;gt;{{ voucher.name }}&amp;lt;/li&amp;gt; </span><br><span class="line">{% endfor %}</span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>

<div id="outline-container-sec-11-3-3" class="outline-4">
<h4 id="sec-11-3-3"><span class="section-number-4">11.3.3</span> Gotcha 3: Complex Implied Queries in Templates</h4>
<div class="outline-text-4" id="text-11-3-3">
<p>
Bad Example:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">{<span class="comment"># list generated via User.object.all() #}</span></span><br><span class="line">&amp;lt;h1&amp;gt;Ice Cream Fans <span class="keyword">and</span> their favorite flavors.&amp;lt;/h1&amp;gt; </span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">{% <span class="keyword">for</span> user <span class="keyword">in</span> user_list %}</span><br><span class="line">    &amp;lt;li&amp;gt;</span><br><span class="line">	{{ user.name }}:</span><br><span class="line">	{<span class="comment"># DON'T DO THIS: Generated implicit query per user #}</span></span><br><span class="line">	{{ user.flavor.title }}</span><br><span class="line">	{<span class="comment"># DON'T DO THIS: Second implicit query per user!!! #}</span></span><br><span class="line">	{{ user.flavor.scoops_remaining }}</span><br><span class="line">    &amp;lt;/li&amp;gt; </span><br><span class="line">{% endfor %}</span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>

<p>
One quick correction is to use the Django ORM’s <b>select related()</b> method:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">{% comment %}</span><br><span class="line">List generated via User.object.all().select_related(<span class="string">"flavors"</span>) </span><br><span class="line">{% endcomment %}</span><br><span class="line">&amp;lt;h1&amp;gt;Ice Cream Fans <span class="keyword">and</span> their favorite flavors.&amp;lt;/h1&amp;gt;</span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">{% <span class="keyword">for</span> user <span class="keyword">in</span> user_list %}</span><br><span class="line">    &amp;lt;li&amp;gt;</span><br><span class="line">	{{ user.name }}:</span><br><span class="line">	{{ user.flavor.title }}</span><br><span class="line">	{{ user.flavor.scoops_remaining }} </span><br><span class="line">    &amp;lt;/li&amp;gt;</span><br><span class="line">{% endfor %} </span><br><span class="line">&amp;lt;/ul&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-3-4" class="outline-4">
<h4 id="sec-11-3-4"><span class="section-number-4">11.3.4</span> Gotcha 4: Hidden CPU Load in Templates</h4>
<div class="outline-text-4" id="text-11-3-4">
<p>
需要大量CPU LOAD的code不該在template中，例如save image to file system<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-3-5" class="outline-4">
<h4 id="sec-11-3-5"><span class="section-number-4">11.3.5</span> Gotcha 5: Hidden REST API Calls in Templates</h4>
<div class="outline-text-4" id="text-11-3-5">
<p>
REST API call不該放在template中，由於REST API可能會跑很久<br>
建議在javascript code or view 中處理REST API call<br>
</p>
<ul class="org-ul">
<li>JavaScript code so after your project serves out its content, the client’s browser handles the work.  is way you can entertain or distract the client while they wait for data to load.<br>
</li>
<li>The view’s Python code where slow processes might be handled in a variety of ways including message queues, additional threads, multiprocesses, or more.<br>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-11-4" class="outline-3">
<h3 id="sec-11-4"><span class="section-number-3">11.4</span> Exploring Template Inheritance</h3>
<div class="outline-text-3" id="text-11-4">
<p>
base.html:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{# simple base.html #} </span><br><span class="line">{% load staticfiles %} </span><br><span class="line">&amp;lt;html&amp;gt;</span><br><span class="line">&amp;lt;head&amp;gt;</span><br><span class="line">    &amp;lt;title&amp;gt;</span><br><span class="line">	{% block title %}Two Scoops of Django{% endblock title %}</span><br><span class="line">    &amp;lt;/title&amp;gt;</span><br><span class="line">    {% block stylesheets %}</span><br><span class="line">	&amp;lt;link rel="stylesheet" type="text/css" href="{% static "css/project.css" %}"&amp;gt;</span><br><span class="line">    {% endblock stylesheets %} &amp;lt;/head&amp;gt;</span><br><span class="line">&amp;lt;body&amp;gt;</span><br><span class="line">    &amp;lt;div class="content"&amp;gt;</span><br><span class="line">	{% block content %} </span><br><span class="line">	    &amp;lt;h1&amp;gt;Two Scoops&amp;lt;/h1&amp;gt;</span><br><span class="line">	{% endblock content %} </span><br><span class="line">    &amp;lt;/div&amp;gt;</span><br><span class="line">&amp;lt;/body&amp;gt; </span><br><span class="line">&amp;lt;/html&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
The base.html file contains the following features:<br>
</p>
<ul class="org-ul">
<li>A title block containing “Two Scoops of Django”.<br>
</li>
<li>A stylesheets block containing a link to a project.css file used across our site.<br>
</li>
<li>A content block containing “&lt;h1&gt;Two Scoops&lt;/h1&gt;”.<br>
</li>
</ul>
<p>
<br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Template Tag</th>
<th scope="col" class="left">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">{% load %}</td>
<td class="left">Loads the staticfiles built-in template tag library</td>
</tr>

<tr>
<td class="left">{% block %}</td>
<td class="left">Since base.html is a parent template, these define which child blocks can be filled in by child templates. We place links and scripts inside them so we can override if necessary.</td>
</tr>

<tr>
<td class="left">{% static %}</td>
<td class="left">Resolves the named static media argument to the static media server.</td>
</tr>
</tbody>
</table>
<p>
<br>
</p>

<p>
we’ll have a simple about.html inherit the following from it:<br>
</p>
<ul class="org-ul">
<li>A custom title.<br>
</li>
<li>The original stylesheet and an additional stylesheet.<br>
</li>
<li>The original header, a sub header, and paragraph content.<br>
</li>
<li>The use of child blocks.<br>
</li>
<li>The use of the  template variable.<br>
</li>
</ul>

<p>
<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{% extends "base.html" %}</span><br><span class="line">{% load staticfiles %}</span><br><span class="line">{% block title %}About Audrey and Daniel{% endblock title %}</span><br><span class="line">{% block stylesheets %}</span><br><span class="line">    {{ block.super }}</span><br><span class="line">    &amp;lt;link rel="stylesheet" type="text/css" href="{% static "css/about.css" %}"&amp;gt;</span><br><span class="line">{% endblock stylesheets %}</span><br><span class="line">{% block content %}</span><br><span class="line">    {{ block.super }}</span><br><span class="line">    &amp;lt;h2&amp;gt;About Audrey and Daniel&amp;lt;/h2&amp;gt; </span><br><span class="line">    &amp;lt;p&amp;gt;They enjoy eating ice cream&amp;lt;/p&amp;gt;</span><br><span class="line">{% endblock content %}</span><br></pre></td></tr></table></figure>
</div>
<p>
it generates the following HTML:<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&amp;lt;html&amp;gt; </span><br><span class="line">&amp;lt;head&amp;gt;</span><br><span class="line">    &amp;lt;title&amp;gt;</span><br><span class="line">	About Audrey and Daniel</span><br><span class="line">    &amp;lt;/title&amp;gt;</span><br><span class="line">    &amp;lt;link rel="stylesheet" type="text/css" href="/static/css/project.css"&amp;gt; </span><br><span class="line">    &amp;lt;link rel="stylesheet" type="text/css" href="/static/css/about.css"&amp;gt;</span><br><span class="line">&amp;lt;/head&amp;gt; </span><br><span class="line">&amp;lt;body&amp;gt;</span><br><span class="line">    &amp;lt;div class="content"&amp;gt; </span><br><span class="line">	&amp;lt;h1&amp;gt;Two Scoops&amp;lt;/h1&amp;gt;</span><br><span class="line">	&amp;lt;h2&amp;gt;About Audrey and Daniel&amp;lt;/h2&amp;gt;</span><br><span class="line">	&amp;lt;p&amp;gt;They enjoy eating ice cream&amp;lt;/p&amp;gt; </span><br><span class="line">    &amp;lt;/div&amp;gt;</span><br><span class="line">&amp;lt;/body&amp;gt; </span><br><span class="line">&amp;lt;/html&amp;gt;</span><br></pre></td></tr></table></figure>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Template Object</th>
<th scope="col" class="left">Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">{% extends %}</td>
<td class="left">Informs Django that about.html is inheriting or extending from base.html</td>
</tr>

<tr>
<td class="left">{% block %}</td>
<td class="left">Since about.html is a child template, block overrides the content provided by base.html. This means our title will render as &lt;title&gt;Audrey and Daniel&lt;/title&gt;</td>
</tr>

<tr>
<td class="left">{{ block.super }}</td>
<td class="left">When placed in a child template's block, it ensures that the parent's content is also included in the block. In the content block of the about.html template, this will render &lt;h1&gt;Two Scoops&lt;/h1&gt;.</td>
</tr>
</tbody>
</table>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-5" class="outline-3">
<h3 id="sec-11-5"><span class="section-number-3">11.5</span> block.super Gives the Power of Control</h3>
<div class="outline-text-3" id="text-11-5">
<p>
Here are three examples:<br>
<br>
Template using both project.css and a custom link:<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{% extends "base.html" %}</span><br><span class="line">{% block stylesheets %}</span><br><span class="line">    {{ block.super }} {# this brings in project.css #}</span><br><span class="line">    &amp;lt;link rel="stylesheet" type="text/css" href="{% static "css/custom.css" %}" /&amp;gt; </span><br><span class="line">{% endblock %}</span><br></pre></td></tr></table></figure>
</div>

<p>
Dashboard template that excludes the project.css link:<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{% extends "base.html" %}</span><br><span class="line">{% block stylesheets %} .</span><br><span class="line">    &amp;lt;link rel="stylesheet" type="text/css" href="{% static "css/dashboard.css" %}" /&amp;gt;</span><br><span class="line">    {% comment %}</span><br><span class="line">	By not using {{ block.super }}, this block overrides the stylesheet block of base.html .</span><br><span class="line">    {% endcomment %}</span><br><span class="line">{% endblock %}</span><br></pre></td></tr></table></figure>
</div>

<p>
Template just linking the project.css file:<br>
</p>
<div class="org-src-container">

<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">{% extends "base.html" %}</span><br><span class="line">{% comment %}</span><br><span class="line">    By not using {% block stylesheets %}, this template inherits the</span><br><span class="line">    stylesheets block from the base.html parent, in this case the</span><br><span class="line">    default project.css link.</span><br><span class="line">{% endcomment %}</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-6" class="outline-3">
<h3 id="sec-11-6"><span class="section-number-3">11.6</span> Useful Things to Consider</h3>
<div class="outline-text-3" id="text-11-6">
</div><div id="outline-container-sec-11-6-1" class="outline-4">
<h4 id="sec-11-6-1"><span class="section-number-4">11.6.1</span> Avoid Coupling Styles Too Tightly to Python Code</h4>
<div class="outline-text-4" id="text-11-6-1">
<p>
Aim to control the styling of all rendered templates entirely via CSS and JS.<br>
</p>
<ul class="org-ul">
<li>If you have magic constants in your Python code that are entirely related to visual design layout, you should probably move them to a CSS file.<br>
</li>
<li>The same applies to JavaScript.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-11-6-2" class="outline-4">
<h4 id="sec-11-6-2"><span class="section-number-4">11.6.2</span> Common Conventions</h4>
<div class="outline-text-4" id="text-11-6-2">
<p>
<br>
</p>
<ul class="org-ul">
<li>We prefer underscores over dashes in template names, block names, and other names in tem- plates. Most Django users seem to follow this convention. Why? Well, because underscores are allowed in names of Python objects but dashes are forbidden.<br>
</li>
<li>We rely on clear, intuitive names for blocks. {% block javascript %} is good.<br>
</li>
<li>We include the name of the block tag in the endblock. Never write just {% endblock %}, include the whole {% endblock javascript %}.<br>
</li>
<li>Templates called by other templates are prefixed with ‘_’.  is applies to templates called via {% include %} or custom template tags. It does not apply to templates inheritance controls such as {% extends %} or {% block %}.<br>
</li>
</ul>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-6-3" class="outline-4">
<h4 id="sec-11-6-3"><span class="section-number-4">11.6.3</span> Location</h4>
<div class="outline-text-4" id="text-11-6-3">
<p>
Templates should usually go into the root of the Django project, at the same level as the apps.<br>
The only exception is when you bundle up an app into a third-party package. That packages template directory should go into app directly.<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-6-4" class="outline-4">
<h4 id="sec-11-6-4"><span class="section-number-4">11.6.4</span> Use Named Context Objects</h4>
<div class="outline-text-4" id="text-11-6-4">
<p>
<br>
use {{ topping list }} and {{ topping }} in your templates, instead of {{ object list }} and {{ object }}<br>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-6-5" class="outline-4">
<h4 id="sec-11-6-5"><span class="section-number-4">11.6.5</span> Use URL Names Instead of Hardcoded Paths</h4>
<div class="outline-text-4" id="text-11-6-5">
<p>
A common developer mistake is to hardcode URLs in templates like this:<br>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&amp;lt;a href=<span class="string">"/flavors/"</span>&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
Instead, we use the {% url %} tag and references the names in our URLConf  les:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&amp;lt;a href=<span class="string">"{% url 'flavors_list' %}"</span>&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-11-6-6" class="outline-4">
<h4 id="sec-11-6-6"><span class="section-number-4">11.6.6</span> Debugging Complex Templates</h4>
<div class="outline-text-4" id="text-11-6-6">
<p>
A trick recommended by Lennart Regebro is that when templates are complex and it becomes dif-  cult to determine where a variable is failing, you can force more verbose errors through the use of the string if invalid option in OPTIONS of your TEMPLATES setting:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings/local.py</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    {</span><br><span class="line">	<span class="string">'BACKEND'</span>: <span class="string">'django.template.backends.django.DjangoTemplates'</span>,</span><br><span class="line">	<span class="string">'APP_DIRS'</span>: <span class="keyword">True</span>,</span><br><span class="line">	<span class="string">'OPTIONS'</span>:</span><br><span class="line">	    <span class="string">'string_if_invalid'</span>: <span class="string">'INVALID EXPRESSION: %s'</span></span><br><span class="line">    }, </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-11-7" class="outline-3">
<h3 id="sec-11-7"><span class="section-number-3">11.7</span> Error Page Templates</h3>
<div class="outline-text-3" id="text-11-7">
<p>
It’s standard practice to create at least 404.html and 500.html templates.<br>
We suggest serving your error pages from a static file server (e.g. Nginx or Apache) as entirely self- contained static HTML files. That way, if your entire Django site goes down but your static  le server is still up, then your error pages can still be served.<br>
</p>

<p>
GitHub’s 404 and 500 error pages are great examples of fancy but entirely static, self-contained error pages:<br>
</p>
<ul class="org-ul">
<li><a href="https://github.com/404" target="_blank" rel="external">https://github.com/404</a><br>
</li>
<li><a href="https://github.com/500" target="_blank" rel="external">https://github.com/500</a><br>
</li>
<li>All CSS styles are inline in the head of the same HTML page, eliminating the need for a separate stylesheet.<br>
</li>
<li>All images are entirely contained as data within the HTML page.  ere are no &lt;img&gt; links to external URLs.<br>
</li>
<li>All JavaScript needed for the page is contained within the HTML page. There are no external links to JavaScript assets.<br>
</li>
</ul>

<p>
For more information, see the Github HTML Styleguide:<br>
</p>
<ul class="org-ul">
<li><a href="https://github.com/styleguide" target="_blank" rel="external">https://github.com/styleguide</a><br>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12"><span class="section-number-2">12</span> Template Tags and Filters</h2>
<div class="outline-text-2" id="text-12">
</div><div id="outline-container-sec-12-1" class="outline-3">
<h3 id="sec-12-1"><span class="section-number-3">12.1</span> Filters Are Functions</h3>
<div class="outline-text-3" id="text-12-1">
<p>
Filters are functions that accept just one or two arguments.<br>
大多數的filters都只是作很簡單的事，通常都是將實作寫在utils.py，再由filters去import utils.py<br>
可參考django的default filters實作：<a href="https://github.com/django/django/blob/stable/1.8.x/django/template/defaultfilters.py" target="_blank" rel="external">https://github.com/django/django/blob/stable/1.8.x/django/template/defaultfilters.py</a><br>
django.template.defaultfilters.slugify是呼叫django.utils.text.slugify<br>
</p>
</div>
<div id="outline-container-sec-12-1-1" class="outline-4">
<h4 id="sec-12-1-1"><span class="section-number-4">12.1.1</span> When to Write Filters</h4>
<div class="outline-text-4" id="text-12-1-1">
<p>
<b>Filters are good for modifying the presentation of data</b>, and they can be readily reused in REST APIs and other output formats.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-12-2" class="outline-3">
<h3 id="sec-12-2"><span class="section-number-3">12.2</span> Custom Template Tags</h3>
<div class="outline-text-3" id="text-12-2">
<ul class="org-ul">
<li>Template Tags Are Harder to Debug<br>
</li>
<li>Template Tags Make Code Reuse Harder<br>
</li>
<li>The Performance Cost of Template Tags<br>
</li>
</ul>
</div>
<div id="outline-container-sec-12-2-1" class="outline-4">
<h4 id="sec-12-2-1"><span class="section-number-4">12.2.1</span> When to Write Template Tags</h4>
<div class="outline-text-4" id="text-12-2-1">
<p>
Think these before writing custom tags:<br>
</p>
<ul class="org-ul">
<li>Anything that causes a read/write of data might be better placed in a model or object method.<br>
</li>
<li>Since we implement a consistent naming standard across our projects, we can add an abstract base class model to our core.models module. Can a method or property in our project’s abstract base class model do the same work as a custom template tag?<br>
</li>
</ul>

<p>
When should you write new template tags? We recommend writing them in situations where they are only responsible for rendering of HTML. For example, projects with very complex HTML layouts with many different models or data types might use them to create a more  exible, understandable template architecture.<br>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-12-3" class="outline-3">
<h3 id="sec-12-3"><span class="section-number-3">12.3</span> Naming Your Template Tag Libraries</h3>
<div class="outline-text-3" id="text-12-3">
<p>
The convention we follow is &lt;app name&gt;_tags.py.<br>
</p>
<ul class="org-ul">
<li>flavors_tags.py<br>
</li>
<li>blog_tags.py<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-12-4" class="outline-3">
<h3 id="sec-12-4"><span class="section-number-3">12.4</span> Loading Your Template Tag Modules</h3>
<div class="outline-text-3" id="text-12-4">
<p>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">{% extends <span class="string">"base.html"</span> %}</span><br><span class="line"></span><br><span class="line">{% load flavors_tags %}</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
<div id="outline-container-sec-12-4-1" class="outline-4">
<h4 id="sec-12-4-1"><span class="section-number-4">12.4.1</span> Watch Out for This Crazy Anti-Pattern</h4>
<div class="outline-text-4" id="text-12-4-1">
<p>
<b>Don't Use This</b><br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Don't use this code!</span></span><br><span class="line"><span class="comment"># It's an evil anti-pattern! </span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template </span><br><span class="line">template.add_to_builtins(</span><br><span class="line">    <span class="string">"flavors.templatetags.flavors_tags"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13"><span class="section-number-2">13</span> Building REST APIs</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1"><span class="section-number-3">13.1</span> Fundamentals of Basic REST API Design</h3>
<div class="outline-text-3" id="text-13-1">
<p>
HTTP method:<br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Purpose of Request</th>
<th scope="col" class="left">HTTP Method</th>
<th scope="col" class="left">Rough SQL equivalent</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">Create a new resource</td>
<td class="left">POST</td>
<td class="left">INSERT</td>
</tr>

<tr>
<td class="left">Read an existing resource</td>
<td class="left">GET</td>
<td class="left">SELECT</td>
</tr>

<tr>
<td class="left">Request the metadata of an existing resource</td>
<td class="left">HEAD</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Update an existing resource</td>
<td class="left">PUT</td>
<td class="left">UPDATE</td>
</tr>

<tr>
<td class="left">Update part of an existing resource</td>
<td class="left">PATCH</td>
<td class="left">UPDATE</td>
</tr>

<tr>
<td class="left">Delete an existing resource</td>
<td class="left">DELETE</td>
<td class="left">DELETE</td>
</tr>

<tr>
<td class="left">Return the supported HTTP methods for the given URL</td>
<td class="left">OPTIONS</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Echo back the request</td>
<td class="left">TRACE</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="left">Tunneling over TCP/IP (usually not implemented)</td>
<td class="left">CONNECT</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
some common HTTP status codes:<br>
<i><img src="/my_blog/2016/02/19/django學習筆記/table16_2.png" alt="table16_2.png" title=""></i><br>
</p>
</div>
</div>

<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2"><span class="section-number-3">13.2</span> Implementing a Simple JSON API</h3>
<div class="outline-text-3" id="text-13-2">
<p>
<b>use django-rest-framework</b><br>
model:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flavor</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    slug = models.SlugField(unique=<span class="keyword">True</span>) </span><br><span class="line">    scoops_remaining = models.IntegerField(default=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_absolute_url</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> reverse(<span class="string">"flavors:detail"</span>, kwargs={<span class="string">"slug"</span>: self.slug})</span><br></pre></td></tr></table></figure>
</div>
<p>
Define the serializer class:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">	model = flavor</span><br><span class="line">	fields = (<span class="string">'title'</span>, <span class="string">'slug'</span>, <span class="string">'scoops_remaining'</span>)</span><br></pre></td></tr></table></figure>
</div>
<p>
Views:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/views</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListCreateAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> RetrieveUpdateDestroyAPIView </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Flavor</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> FlavorSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateReadView</span><span class="params">(ListCreateAPIView)</span>:</span></span><br><span class="line">    queryset = Flavor.objects.all()</span><br><span class="line">    serializer_class = FlavorSerializer</span><br><span class="line">    lookup_field = <span class="string">'slug'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorReadUpdateDeleteView</span><span class="params">(RetrieveUpdateDestroyAPIView)</span>:</span> </span><br><span class="line">    queryset = Flavor.objects.all()</span><br><span class="line">    serializer_class = FlavorSerializer</span><br><span class="line">    lookup_field = <span class="string">'slug'</span></span><br></pre></td></tr></table></figure>
</div>
<p>
flavors/urls.py:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> flavors <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(</span><br><span class="line">	regex=<span class="string">r"ˆapi/$"</span>, </span><br><span class="line">	view=views.FlavorCreateReadView.as_view(), </span><br><span class="line">	name=<span class="string">"flavor_rest_api"</span></span><br><span class="line">    ), </span><br><span class="line">    url(</span><br><span class="line">	regex=<span class="string">r"ˆapi/(?P&amp;lt;slug&amp;gt;[-\w]+)/$"</span>,</span><br><span class="line">	view=views.FlavorReadUpdateDeleteView.as_view(),</span><br><span class="line">	name=<span class="string">"flavor_rest_api"</span></span><br><span class="line">    )</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Url</th>
<th scope="col" class="left">View</th>
<th scope="col" class="left">Url Name (same)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left"><i>flavors/api</i></td>
<td class="left">FlavorCreateReadView</td>
<td class="left">flavor_rest api</td>
</tr>

<tr>
<td class="left"><i>flavors/api</i>:slug/</td>
<td class="left">FlavorReadUpdateDeleteView</td>
<td class="left">flavor_rest api</td>
</tr>
</tbody>
</table>

<p>
Don't forget to add authenticate and permissions:<br>
</p>
<ul class="org-ul">
<li><a href="http://www.django-rest-framework.org/api-guide/authentication/" target="_blank" rel="external">http://www.django-rest-framework.org/api-guide/authentication/</a><br>
</li>
<li><a href="http://www.django-rest-framework.org/api-guide/permissions/" target="_blank" rel="external">http://www.django-rest-framework.org/api-guide/permissions/</a><br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3"><span class="section-number-3">13.3</span> REST API Architecture</h3>
<div class="outline-text-3" id="text-13-3">
</div><div id="outline-container-sec-13-3-1" class="outline-4">
<h4 id="sec-13-3-1"><span class="section-number-4">13.3.1</span> Code for a Project Should Be Neatly Organized</h4>
<div class="outline-text-4" id="text-13-3-1">
<p>
For example, we might place all our views, serializers, and other API components in an app titled apiv4.<br>
The downside is the possibility for the API app to become too large and disconnected from the apps that power it. Hence why we consider an alternative in the next subsection.<br>
</p>
</div>
</div>
<div id="outline-container-sec-13-3-2" class="outline-4">
<h4 id="sec-13-3-2"><span class="section-number-4">13.3.2</span> Code for an App Should Remain in the App</h4>
<div class="outline-text-4" id="text-13-3-2">
<p>
REST APIs are just views. For simpler, smaller projects, REST API views should go into views.py or viewsets.py modules<br>
The downside is that if there are too many small, interconnecting apps, it can be hard to keep track of the myriad of places API components are placed. Hence why we considered another approach in the previous subsection.<br>
</p>
</div>
</div>

<div id="outline-container-sec-13-3-3" class="outline-4">
<h4 id="sec-13-3-3"><span class="section-number-4">13.3.3</span> Grouping API URLs</h4>
<div class="outline-text-4" id="text-13-3-3">
<p>
If you have REST API views in multiple Django apps, how do you build a project-wide API that looks like this?<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">api/flavors/ <span class="comment"># GET, POST </span></span><br><span class="line">api/flavors/:slug/ <span class="comment"># GET, PUT, DELETE</span></span><br><span class="line">api/users/ <span class="comment"># GET, POST</span></span><br><span class="line">api/users/:slug/ <span class="comment"># GET, PUT, DELETE</span></span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> <span class="comment"># core/api.py</span></span><br><span class="line"><span class="string">"""Called from the project root's urls.py URLConf thus:</span><br><span class="line">	url(r"ˆapi/", include("core.api", namespace="api")), </span><br><span class="line">"""</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> flavors <span class="keyword">import</span> views <span class="keyword">as</span> flavor_views </span><br><span class="line"><span class="keyword">from</span> users <span class="keyword">import</span> views <span class="keyword">as</span> user_views</span><br><span class="line"></span><br><span class="line"> urlpatterns = [</span><br><span class="line">     <span class="comment"># {% url "api:flavors" %}</span></span><br><span class="line">     url(</span><br><span class="line">	regex=<span class="string">r"ˆflavors/$"</span>, </span><br><span class="line">	view=flavor_views.FlavorCreateReadView.as_view(), </span><br><span class="line">	name=<span class="string">"flavors"</span> .</span><br><span class="line">     ),</span><br><span class="line"></span><br><span class="line">     <span class="comment"># {% url "api:flavors" flavor.slug %}</span></span><br><span class="line">     url(</span><br><span class="line">	regex=<span class="string">r"ˆflavors/(?P&amp;lt;slug&amp;gt;[-\w]+)/$"</span>, </span><br><span class="line">	view=flavor_views.FlavorReadUpdateDeleteView.as_view(), </span><br><span class="line">	name=<span class="string">"flavors"</span></span><br><span class="line">     ),</span><br><span class="line"></span><br><span class="line">     <span class="comment"># {% url "api:users" %}</span></span><br><span class="line">     url(</span><br><span class="line">	regex=<span class="string">r"ˆusers/$"</span>, </span><br><span class="line">	view=user_views.UserCreateReadView.as_view(), </span><br><span class="line">	name=<span class="string">"users"</span></span><br><span class="line">     ),</span><br><span class="line"></span><br><span class="line">     <span class="comment"># {% url "api:users" user.slug %}</span></span><br><span class="line">     url(</span><br><span class="line">	  regex=<span class="string">r"ˆusers/(?P&amp;lt;slug&amp;gt;[-\w]+)/$"</span>, </span><br><span class="line">	  view=user_views.UserReadUpdateDeleteView.as_view(), </span><br><span class="line">	  name=<span class="string">"users"</span> .</span><br><span class="line">    ),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>
</div>
</div>
<div id="outline-container-sec-13-3-4" class="outline-4">
<h4 id="sec-13-3-4"><span class="section-number-4">13.3.4</span> Version Your API</h4>
<div class="outline-text-4" id="text-13-3-4">
<p>
It’s a good practice to abbreviate the urls of your API with the version number e.g. /api/v1/flavors or /api/v1/users and then as the API changes, /api/v2/flavors or /api/v2/users.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-13-4" class="outline-3">
<h3 id="sec-13-4"><span class="section-number-3">13.4</span> Shutting Down an External API</h3>
<div class="outline-text-3" id="text-13-4">
<ol class="org-ol">
<li>Notify User<br>
</li>
<li>Replace API With 410 Error View<br>
</li>
</ol>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/apiv1_shutdown.py</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseGone</span><br><span class="line"></span><br><span class="line">apiv1_gone_msg = <span class="string">"""APIv1 was removed on April 2, 2015. Please switch to APIv3:</span><br><span class="line">&amp;lt;ul&amp;gt;</span><br><span class="line">    &amp;lt;li&amp;gt;</span><br><span class="line">	&amp;lt;a href="https://www.example.com/api/v3/"&amp;gt;APIv3 Endpoint&amp;lt;/a&amp;gt;</span><br><span class="line">    &amp;lt;/li&amp;gt; </span><br><span class="line">    &amp;lt;li&amp;gt;</span><br><span class="line">	&amp;lt;a href="https://example.com/apiv3_docs/"&amp;gt;APIv3 Documentation&amp;lt;/a&amp;gt;</span><br><span class="line">    &amp;lt;/li&amp;gt; </span><br><span class="line">    &amp;lt;li&amp;gt;</span><br><span class="line">	&amp;lt;a href="http://example.com/apiv1_shutdown/"&amp;gt;APIv1 shut down notice&amp;lt;/a&amp;gt;</span><br><span class="line">    &amp;lt;/li&amp;gt;</span><br><span class="line">&amp;lt;/ul&amp;gt; </span><br><span class="line">"""</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">apiv1_gone</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponseGone(apiv1_gone_msg)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-13-5" class="outline-3">
<h3 id="sec-13-5"><span class="section-number-3">13.5</span> Rate Limiting Your API</h3>
<div class="outline-text-3" id="text-13-5">
<p>
Rate limiting is when an API restricts how many requests can be made by a user of the API within a period of time.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14"><span class="section-number-2">14</span> Working With the Django Admin</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1"><span class="section-number-3">14.1</span> It's Not for End Users</h3>
<div class="outline-text-3" id="text-14-1">
<p>
The Django admin interface is designed for site administrators, not end users.<br>
</p>
</div>
</div>
<div id="outline-container-sec-14-2" class="outline-3">
<h3 id="sec-14-2"><span class="section-number-3">14.2</span> Add <span class="underline"><span class="underline">str</span></span> to Model</h3>
<div class="outline-text-3" id="text-14-2">
<p>
The default admin page for a Django app looks something like this:<br>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure19_2.png" alt="figure19_2.png" title=""></i><br>
</p>

<p>
Implementing __str__():<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> python_2_unicode_compatible</span><br><span class="line"></span><br><span class="line"><span class="decorator">@python_2_unicode_compatible # For Python 3.4 and 2.7 </span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamBar</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    shell = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    filling = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    has_stick = models.BooleanField(default=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span> </span><br><span class="line">	<span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>
</div>
<p>
The result:<br>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure19_3.png" alt="figure19_3.png" title=""></i><br>
</p>

<p>
If you still want to show data for additional  elds on the app’s admin list page, you can then use list display:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> IceCreamBar</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamBarAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = (<span class="string">"name"</span>, <span class="string">"shell"</span>, <span class="string">"filling"</span>,)</span><br><span class="line"></span><br><span class="line">admin.site.register(IceCreamBar, IceCreamBarAdmin)</span><br></pre></td></tr></table></figure>
</div>
<p>
The result with the specified fields:<br>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure19_5.png" alt="figure19_5.png" title=""></i><br>
</p>
</div>
</div>
<div id="outline-container-sec-14-3" class="outline-3">
<h3 id="sec-14-3"><span class="section-number-3">14.3</span> Adding Callables to ModelAdmin Classes</h3>
<div class="outline-text-3" id="text-14-3">
<p>
For example, it’s not uncommon to want to see the exact URL of a model instance in the Django admin.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html</span><br><span class="line"><span class="keyword">from</span> icecreambars.models <span class="keyword">import</span> IceCreamBar </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamBarAdmin</span><span class="params">(admin.ModelAdmin)</span>:</span></span><br><span class="line">    list_display = (<span class="string">"name"</span>, <span class="string">"shell"</span>, <span class="string">"filling"</span>,)</span><br><span class="line">    readonly_fields = (<span class="string">"show_url"</span>,)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">show_url</span><span class="params">(self, instance)</span>:</span></span><br><span class="line">	url = reverse(<span class="string">"ice_cream_bar_detail"</span>,</span><br><span class="line">		kwargs={<span class="string">"pk"</span>: instance.pk})</span><br><span class="line">	response = format_html(<span class="string">"""&amp;lt;a href="{0}"&amp;gt;{1}&amp;lt;/a&amp;gt;"""</span>, url, url) </span><br><span class="line">	<span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    show_url.short_description = <span class="string">"Ice Cream Bar URL"</span></span><br><span class="line">    <span class="comment"># Displays HTML tags</span></span><br><span class="line">    <span class="comment"># Never set allow_tags to True against user submitted data!!!</span></span><br><span class="line">    show_url.allow_tags = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">admin.site.register(IceCreamBar, IceCreamBarAdmin)</span><br></pre></td></tr></table></figure>
</div>
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure19_6.png" alt="figure19_6.png" title=""></i><br>
</p>
</div>
</div>
<div id="outline-container-sec-14-4" class="outline-3">
<h3 id="sec-14-4"><span class="section-number-3">14.4</span> Django's Admin Documentation Generator</h3>
<div class="outline-text-3" id="text-14-4">
<ol class="org-ol">
<li>pip install docutils into your project’s virtualenv.<br>
</li>
<li>Add django.contrib.admindocs to your INSTALLED APPS.<br>
</li>
<li>Add (r'ˆadmin/doc/', include('django.contrib.admindocs.urls')) to your root URLConf. Make sure it’s included before the r'ˆadmin/' entry, so that requests to <i>admin/doc</i> don’t get handled by the latter entry.<br>
</li>
<li>Optional : Linking to templates requires the ADMIN FOR setting to be con gured.<br>
</li>
<li>Optional : Using the admindocs bookmarklets requires the XViewMiddleware to be installed.<br>
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-14-5" class="outline-3">
<h3 id="sec-14-5"><span class="section-number-3">14.5</span> Securing the Django Admin and Django Admin Docs</h3>
</div>
</div>
<div id="outline-container-sec-15" class="outline-2">
<h2 id="sec-15"><span class="section-number-2">15</span> Dealing With the User Model</h2>
<div class="outline-text-2" id="text-15">
</div><div id="outline-container-sec-15-1" class="outline-3">
<h3 id="sec-15-1"><span class="section-number-3">15.1</span> Use Django's Tools for Finding the User Model</h3>
<div class="outline-text-3" id="text-15-1">
<p>
The advised way to get to the user class is as follows:<br>
</p>
<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line"># Stock user model definition</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; from django.contrib.auth import get_user_model</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; get_user_model()</span><br><span class="line">&amp;lt;class 'django.contrib.auth.models.User'&amp;gt; .</span><br><span class="line"></span><br><span class="line"># When the project has a custom user model definition </span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; from django.contrib.auth import get_user_model </span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; get_user_model()</span><br><span class="line">&amp;lt;class 'profiles.models.UserProfile'&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
</div>
<div id="outline-container-sec-15-1-1" class="outline-4">
<h4 id="sec-15-1-1"><span class="section-number-4">15.1.1</span> Use settings.AUTH_USER_MODEL for Foreign Keys to User</h4>
<div class="outline-text-4" id="text-15-1-1">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStore</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    owner = models.OneToOneField(settings.AUTH_USER_MODEL)</span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-15-1-2" class="outline-4">
<h4 id="sec-15-1-2"><span class="section-number-4">15.1.2</span> Don't Use get user model() for Foreign Keys to User</h4>
<div class="outline-text-4" id="text-15-1-2">
<p>
This is bad, as it tends to create import loops.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># DON'T DO THIS!</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamStore</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># This following line tends to create import loops.</span></span><br><span class="line">    owner = models.OneToOneField(get_user_model())</span><br><span class="line">    title = models.CharField(max_length=<span class="number">255</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-15-2" class="outline-3">
<h3 id="sec-15-2"><span class="section-number-3">15.2</span> Custom User Fields for Django 1.8 Projects</h3>
<div class="outline-text-3" id="text-15-2">
</div><div id="outline-container-sec-15-2-1" class="outline-4">
<h4 id="sec-15-2-1"><span class="section-number-4">15.2.1</span> Option 1: Subclass AbstractUser</h4>
<div class="outline-text-4" id="text-15-2-1">
<p>
Choose this option if you like Django’s User model  elds the way they are, but need extra fields.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># profiles/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext_lazy <span class="keyword">as</span> _</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KarmaUser</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    karma = models.PositiveIntegerField(verbose_name=_(<span class="string">"karma"</span>), default=<span class="number">0</span>, blank=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
</div>
<p>
The other thing you have to do is set this in your settings:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">AUTH_USER_MODEL = <span class="string">"profiles.KarmaUser"</span> .</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-15-2-2" class="outline-4">
<h4 id="sec-15-2-2"><span class="section-number-4">15.2.2</span> Option 2: Subclass AbstractBaseUser</h4>
<div class="outline-text-4" id="text-15-2-2">
<p>
AbstractBaseUser is the bare-bones option with only 3 fields: password, last login, and is active.<br>
Choose this option if:<br>
</p>
<ul class="org-ul">
<li>You’re unhappy with the  elds that the User model provides by default, such as first name and last name.<br>
</li>
<li>You prefer to subclass from an extremely bare-bones clean slate but want to take advantage of the AbstractBaseUser sane default approach to storing passwords.<br>
</li>
</ul>

<p>
If you want to go down this path, we recommend the following reading:<br>
</p>
<ul class="org-ul">
<li>Official Django Documentation Example <a href="http://2scoops.co/1.8-custom-user-model-example" target="_blank" rel="external">http://2scoops.co/1.8-custom-user-model-example</a><br>
</li>
<li>Source code of django-authtools (Especially admin.py,forms.py,andmodels.py) <a href="https://github.com/fusionbox/django-authtools" target="_blank" rel="external">https://github.com/fusionbox/django-authtools</a><br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-15-2-3" class="outline-4">
<h4 id="sec-15-2-3"><span class="section-number-4">15.2.3</span> Option 3: Linking Back From a Related Model</h4>
<div class="outline-text-4" id="text-15-2-3">
<p>
<i>Use Case: Creating a Third Party Package</i><br>
</p>
<ul class="org-ul">
<li>We are creating a third-party package for publication on PyPI.<br>
</li>
<li>The package needs to store additional information per user, perhaps a Stripe ID or another payment gateway identifier.<br>
</li>
<li>We want to be as unobtrusive to the existing project code as possible. Loose coupling!<br>
</li>
</ul>

<p>
<i>Use Case: Internal Project Needs</i><br>
</p>
<ul class="org-ul">
<li>We are working on our own Django project.<br>
</li>
<li>We want different types of users to have different fields.<br>
</li>
<li>We might have some users with a combination of different user types.<br>
</li>
<li>We want to handle this at the model level, instead of at other levels.<br>
</li>
<li>We want this to be used in conjunction with a custom user model from options #1 or #2.<br>
</li>
</ul>

<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># profiles/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> flavors.models <span class="keyword">import</span> Flavor </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EaterProfile</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># Default user profile</span></span><br><span class="line">    <span class="comment"># If you do this you need to either have a post_save signal or</span></span><br><span class="line">    <span class="comment">#     redirect to a profile_edit view on initial login.</span></span><br><span class="line">    user = models.OneToOneField(settings.AUTH_USER_MODEL)</span><br><span class="line">    favorite_ice_cream = models.ForeignKey(Flavor, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ScooperProfile</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    user = models.OneToOneField(settings.AUTH_USER_MODEL)</span><br><span class="line">    scoops_scooped = models.IntegerField(default=<span class="number">0</span>) </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InventorProfile</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    user = models.OneToOneField(setting.s.AUTH_USER_MODEL)</span><br><span class="line">    flavors_invented = models.ManyToManyField(Flavor, null=<span class="keyword">True</span>, blank=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-16" class="outline-2">
<h2 id="sec-16"><span class="section-number-2">16</span> Third-Party Packages</h2>
<div class="outline-text-2" id="text-16">
<p>
PyPI (<a href="https://pypi.python.org/pypi" target="_blank" rel="external">https://pypi.python.org/pypi</a>)<br>
Django Packages (<a href="https://www.djangopackages.com/" target="_blank" rel="external">https://www.djangopackages.com/</a>)<br>
</p>
</div>
<div id="outline-container-sec-16-1" class="outline-3">
<h3 id="sec-16-1"><span class="section-number-3">16.1</span> Wiring Up Django Packages: The Basics</h3>
<div class="outline-text-3" id="text-16-1">
<ul class="org-ul">
<li>Step 1: Read the Documentation for the Package<br>
</li>
<li>Step 2: Add Package and Version Number to Your Requirements<br>
</li>
<li>Step 3: Install the Requirements Into Your Virtualenv<br>
</li>
<li>Step 4: Follow the Package's Installation Instructions Exactl<br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-17" class="outline-2">
<h2 id="sec-17"><span class="section-number-2">17</span> Testing</h2>
<div class="outline-text-2" id="text-17">
</div><div id="outline-container-sec-17-1" class="outline-3">
<h3 id="sec-17-1"><span class="section-number-3">17.1</span> Useful Library for Testing Django Projects</h3>
<div class="outline-text-3" id="text-17-1">
<p>
<a href="https://bitbucket.org/ned/coveragepy" target="_blank" rel="external">coverage.py</a><br>
</p>
</div>
</div>
<div id="outline-container-sec-17-2" class="outline-3">
<h3 id="sec-17-2"><span class="section-number-3">17.2</span> How to Structure Tests</h3>
<div class="outline-text-3" id="text-17-2">
<p>
<i>“Flat is better than nested,”</i><br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">popsicles/</span><br><span class="line">    __init__.py</span><br><span class="line">    admin.py</span><br><span class="line">    forms.py</span><br><span class="line">    models.py</span><br><span class="line">    <span class="built_in">test</span>_forms.py</span><br><span class="line">    <span class="built_in">test</span>_models.py</span><br><span class="line">    <span class="built_in">test</span>_views.py</span><br><span class="line">    views.py</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-17-3" class="outline-3">
<h3 id="sec-17-3"><span class="section-number-3">17.3</span> How to Write Unit Tests</h3>
<div class="outline-text-3" id="text-17-3">
</div><div id="outline-container-sec-17-3-1" class="outline-4">
<h4 id="sec-17-3-1"><span class="section-number-4">17.3.1</span> Each Test Method Tests One Thing</h4>
<div class="outline-text-4" id="text-17-3-1">
<p>
example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># flavors/test_api.py </span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.core.urlresolvers <span class="keyword">import</span> reverse </span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"><span class="keyword">from</span> flavors.models <span class="keyword">import</span> Flavor</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DjangoRestFrameworkTests</span><span class="params">(TestCase)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">	Flavor.objects.get_or_create(title=<span class="string">"title1"</span>, slug=<span class="string">"slug1"</span>) </span><br><span class="line">	Flavor.objects.get_or_create(title=<span class="string">"title2"</span>, slug=<span class="string">"slug2"</span>)</span><br><span class="line">	self.create_read_url = reverse(<span class="string">"flavor_rest_api"</span>)</span><br><span class="line">	self.read_update_delete_url = reverse(<span class="string">"flavor_rest_api"</span>, kwargs={<span class="string">"slug"</span>: <span class="string">"slug1"</span>})</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_list</span><span class="params">(self)</span>:</span></span><br><span class="line">	response = self.client.get(self.create_read_url)</span><br><span class="line">	<span class="comment"># Are both titles in the conten.t? </span></span><br><span class="line">	self.assertContains(response, <span class="string">"title1"</span>) </span><br><span class="line">	self.assertContains(response, <span class="string">"title2"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_detail</span><span class="params">(self)</span>:</span></span><br><span class="line">	response = self.client.get(self.read_update_delete_url) </span><br><span class="line">	data = json.loads(response.content)</span><br><span class="line">	content = {<span class="string">"id"</span>: <span class="number">1</span>, <span class="string">"title"</span>: <span class="string">"title1"</span>, <span class="string">"slug"</span>: <span class="string">"slug1"</span>, <span class="string">"scoops_remaining"</span>: <span class="number">0</span>}</span><br><span class="line">	self.assertEquals(data, content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_create</span><span class="params">(self)</span>:</span></span><br><span class="line">	post = {<span class="string">"title"</span>: <span class="string">"title3"</span>, <span class="string">"slug"</span>: <span class="string">"slug3"</span>}</span><br><span class="line">	response = self.client.post(self.create_read_url, post) </span><br><span class="line">	data = json.loads(response.content) </span><br><span class="line">	self.assertEquals(response.status_code, <span class="number">201</span>)</span><br><span class="line">	content = {<span class="string">"id"</span>: <span class="number">3</span>, <span class="string">"title"</span>: <span class="string">"title3"</span>, <span class="string">"slug"</span>: <span class="string">"slug3"</span>, <span class="string">"scoops_remaining"</span>: <span class="number">0</span>}</span><br><span class="line">	self.assertEquals(data, content)</span><br><span class="line">	self.assertEquals(Flavor.objects.count(), <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_delete</span><span class="params">(self)</span>:</span></span><br><span class="line">	response = self.client.delete(self.read_update_delete_url) </span><br><span class="line">	self.assertEquals(response.status_code, <span class="number">204</span>) </span><br><span class="line">	self.assertEquals(Flavor.objects.count(), <span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-17-3-2" class="outline-4">
<h4 id="sec-17-3-2"><span class="section-number-4">17.3.2</span> For Views, When Possible Use the Request Factory</h4>
<div class="outline-text-4" id="text-17-3-2">
<p>
The django.test.client.RequestFactory provides a way to generate a request instance that can be used as the first argument to any view.<br>
But the request factory doesn’t support middleware, including session and authentication.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AnonymousUser</span><br><span class="line"><span class="keyword">from</span> django.contrib.sessions.middleware <span class="keyword">import</span> SessionMiddleware </span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase, RequestFactory</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> cheese_flavors</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_middleware_to_request</span><span class="params">(request, .middleware_class)</span>:</span> </span><br><span class="line">    middleware = middleware_class() </span><br><span class="line">    middleware.process_request(request)</span><br><span class="line">    <span class="keyword">return</span> request</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_middleware_to_response</span><span class="params">(request, middleware_class)</span>:</span> </span><br><span class="line">    middleware = middleware_class() </span><br><span class="line">    middleware.process_request(request)</span><br><span class="line">    <span class="keyword">return</span> request</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SavoryIceCreamTest</span><span class="params">(TestCase)</span>:</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="comment"># Every test needs access to the request factory.</span></span><br><span class="line">	self.factory = RequestFactory()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_cheese_flavors</span><span class="params">(self)</span>:</span></span><br><span class="line">	request = self.factory.get(<span class="string">'/cheesy/broccoli/'</span>)</span><br><span class="line">	request.user = AnonymousUser()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Annotate the request object with a session</span></span><br><span class="line">	request = add_middleware_to_request(request, SessionMiddleware)</span><br><span class="line">	request.session.save()</span><br><span class="line"></span><br><span class="line">	<span class="comment"># process and test the request</span></span><br><span class="line">	response = cheese_flavors(request)</span><br><span class="line">	self.assertContains(response, <span class="string">"bleah!"</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-17-3-3" class="outline-4">
<h4 id="sec-17-3-3"><span class="section-number-4">17.3.3</span> Don't Repeat Yourself Doesn't Apply to Writing Tests</h4>
</div>
<div id="outline-container-sec-17-3-4" class="outline-4">
<h4 id="sec-17-3-4"><span class="section-number-4">17.3.4</span> Don't Rely on Fixtures</h4>
<div class="outline-text-4" id="text-17-3-4">
<p>
Rather than wrestle with  xtures, we’ve found it’s easier to write code that relies on the ORM. Other people like to use third-party packages.(factory boy, model mommy, mock)<br>
</p>
</div>
</div>
<div id="outline-container-sec-17-3-5" class="outline-4">
<h4 id="sec-17-3-5"><span class="section-number-4">17.3.5</span> Things That Should Be Tested</h4>
<div class="outline-text-4" id="text-17-3-5">
<p>
Everything! Seriously, you should test whatever you can, including:<br>
</p>

<p>
<b>Views:</b> Viewing of data, changing of data, and custom class-based view methods.<br>
<b>Models:</b> Creating/updating/deleting of models, model methods, model manager methods.<br>
<b>Forms:</b> Form methods, clean() methods, and custom  elds.<br>
<b>Validators:</b> Really dig in and write multiple test methods against each custom validator you write. Pretend you are a malignant intruder attempting to damage the data in the site.<br>
<b>Signals:</b> Since they act at a distance, signals can cause grief especially if you lack tests on them.<br>
<b>Filters:</b> Since  lters are essentially just functions accepting one or two arguments, writing tests for them should be easy.<br>
<b>Template</b> Tags: Since template tags can do anything and can even accept template context, writing tests often becomes much more challenging. This means you really need to test them, since otherwise you may run into edge cases.<br>
<b>Miscellany:</b> Context processors, middleware, email, and anything else not covered in this list.<br>
<b>Failure</b> What happens when any of the above fail?<br>
</p>
</div>
</div>

<div id="outline-container-sec-17-3-6" class="outline-4">
<h4 id="sec-17-3-6"><span class="section-number-4">17.3.6</span> Test for Failure</h4>
<div class="outline-text-4" id="text-17-3-6">
<p>
It is up to us to learn how to test for the exceptions our code my throw:<br>
</p>
<ul class="org-ul">
<li><a href="https://docs.python.org/2/library/unittest.html#unittest.TestCase.assertRaises" target="_blank" rel="external">https://docs.python.org/2/library/unittest.html#unittest.TestCase.assertRaises</a><br>
</li>
<li><a href="http://pytest.org/latest/assert.html#assertions-about-expected-exceptions" target="_blank" rel="external">http://pytest.org/latest/assert.html#assertions-about-expected-exceptions</a><br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-17-3-7" class="outline-4">
<h4 id="sec-17-3-7"><span class="section-number-4">17.3.7</span> Use Mock to Keep Unit Tests From Touching the World</h4>
<div class="outline-text-4" id="text-17-3-7">
<p>
during tests we should not access external APIs, receive emails or webhooks, or anything that is not part of of the tested action.<br>
when you are trying to write a unit test for a function that interacts with an external API, you have two choices:<br>
</p>
<ul class="org-ul">
<li>Choice #1: Change the unit test to be an Integration Test.<br>
</li>
<li>Choice #2: Use the Mock library to fake the response from the external API.<br>
</li>
</ul>
<p>
Test list_flavors_sorted():<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> mock <span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">import</span> icecreamapi</span><br><span class="line"><span class="keyword">from</span> flavors.exceptions <span class="keyword">import</span> CantListFlavors</span><br><span class="line"><span class="keyword">from</span> flavors.utils <span class="keyword">import</span> list_flavors_sorted </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestIceCreamSorting</span><span class="params">(unittest.TestCase)</span>:</span></span><br><span class="line">    <span class="comment"># Set up monkeypatch of icecreamapi.get_flavors() </span></span><br><span class="line"><span class="decorator">    @mock.patch.object(icecreamapi, "get_flavors") </span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_flavor_sort</span><span class="params">(self, get_flavors)</span>:</span></span><br><span class="line">	<span class="comment"># Instructs icecreamapi.get_flavors() to return an unordered list.</span></span><br><span class="line">	get_flavors.return_value = [<span class="string">'chocolate'</span>, <span class="string">'vanilla'</span>, <span class="string">'strawberry'</span>, ]</span><br><span class="line"></span><br><span class="line">	<span class="comment"># list_flavors_sorted() calls t.he icecreamapi.get_flavors()</span></span><br><span class="line">	<span class="comment"># function. Since we've monkeypatched the function, it will always</span></span><br><span class="line">	<span class="comment">#   return ['chocolate', 'strawberry', 'vanilla', ]. Which the.</span></span><br><span class="line">	<span class="comment">#   list_flavors_sorted() will sort alphabetically</span></span><br><span class="line">	flavors = list_flavors_sorted()</span><br><span class="line">	self.assertEqual(</span><br><span class="line">	    flavors,</span><br><span class="line">	    [<span class="string">'chocolate'</span>, <span class="string">'strawberry'</span>, <span class="string">'vanilla'</span>, ]</span><br><span class="line">	)</span><br></pre></td></tr></table></figure>
</div>
<p>
Now let’s demonstrate how to test the behavior of the list flavors sorted() function when the Ice Cream API is innaccessible.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="decorator">@mock.patch.object(icecreamapi, "get_flavors") </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_flavor_sort_failure</span><span class="params">(self, get_flavors)</span>:</span></span><br><span class="line">    <span class="comment"># Instructs icecreamapi.get_flavors() to throw a FlavorError.</span></span><br><span class="line">    get_flavors.side_effect = icecreamapi.FlavorError()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># list_flavors_sorted() catches the icecreamapi.FlavorError()</span></span><br><span class="line">    <span class="comment">#   and passes on a CantListFlavors exception.</span></span><br><span class="line">    <span class="keyword">with</span> self.assertRaises(CantListFlavors):</span><br><span class="line">	list_flavors_sorted()</span><br></pre></td></tr></table></figure>
</div>
<p>
As an added bonus for API authors, here’s how we test how code handles two different python- requests connection problems:<br>
</p>
<div class="org-src-container">

<figure class="highlight"><table><tr><td class="code"><pre><span class="line">@mock.patch.object(requests, "get") </span><br><span class="line">def test_request_failure(self, get)</span><br><span class="line">    """Test if the target site is innaccessible."""</span><br><span class="line">    get.side_effect = requests.exception.ConnectionError()</span><br><span class="line"></span><br><span class="line">    with self.assertRaises(CantListFlavors):</span><br><span class="line">	list_flavors_sorted()</span><br><span class="line"></span><br><span class="line">@mock.patch.object(requests, "get") </span><br><span class="line">def test_request_failure(self, get)</span><br><span class="line">    """Test if we can handle SSL problems elegantly."""</span><br><span class="line">    get.side_effect = requests.exception.SSLError()</span><br><span class="line"></span><br><span class="line">    with self.assertRaises(CantListFlavors):</span><br><span class="line">	list_flavors_sorted()</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-17-3-8" class="outline-4">
<h4 id="sec-17-3-8"><span class="section-number-4">17.3.8</span> Use Fancier Assertion Methods</h4>
<div class="outline-text-4" id="text-17-3-8">
<ul class="org-ul">
<li><a href="https://docs.python.org/2/library/unittest.html#assert-methods" target="_blank" rel="external">https://docs.python.org/2/library/unittest.html#assert-methods</a><br>
</li>
<li><a href="https://docs.python.org/3/library/unittest.html#assert-methods" target="_blank" rel="external">https://docs.python.org/3/library/unittest.html#assert-methods</a><br>
</li>
<li><a href="https://docs.djangoproject.com/en/1.8/topics/testing/tools/#assertions" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/testing/tools/#assertions</a><br>
</li>
</ul>
<p>
We’ve found the following assert methods extremely useful:<br>
</p>
<ul class="org-ul">
<li>assertRaises<br>
</li>
<li>Python 2.7: ListItemsEqual(), Python 3+ assertCountEqual()<br>
</li>
<li>assertDictEqual()<br>
</li>
<li>assertFormError()<br>
</li>
<li>assertContains() Check status 200, checks in response.content.<br>
</li>
<li>assertHTMLEqual() Amongst many things, ignores whitespace differences.<br>
</li>
<li>assertJSONEqual()<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-17-3-9" class="outline-4">
<h4 id="sec-17-3-9"><span class="section-number-4">17.3.9</span> Document the Purpose of Each Test</h4>
</div>
</div>
<div id="outline-container-sec-17-4" class="outline-3">
<h3 id="sec-17-4"><span class="section-number-3">17.4</span> What About Integration Tests?</h3>
<div class="outline-text-3" id="text-17-4">
<ul class="org-ul">
<li>Selenium tests to con rm that an application works in the browser.<br>
</li>
<li>Actual testing against a third-party API instead of mocking responses. For example, Django Packages conducts periodic tests against GitHub, BitBucket, and PyPI API to ensure that its interaction with those systems is valid.<br>
</li>
<li>Interacting with <a href="http://requestb.in" target="_blank" rel="external">http://requestb.in</a> or <a href="http://httpbin.org/" target="_blank" rel="external">http://httpbin.org/</a> to confirm the validity of out-bound requests.<br>
</li>
<li>Using <a href="http://runscope.com" target="_blank" rel="external">http://runscope.com</a> to validate that our API is working as expected.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-17-5" class="outline-3">
<h3 id="sec-17-5"><span class="section-number-3">17.5</span> Continuous Integration</h3>
<div class="outline-text-3" id="text-17-5">
<p>
For projects of any size, we recommend setting up a continuous integration (CI) server to run the project’s test suite whenever code is committed and pushed to the project repo.<br>
</p>
</div>
</div>
<div id="outline-container-sec-17-6" class="outline-3">
<h3 id="sec-17-6"><span class="section-number-3">17.6</span> Setting Up the Test Coverage Game</h3>
<div class="outline-text-3" id="text-17-6">
</div><div id="outline-container-sec-17-6-1" class="outline-4">
<h4 id="sec-17-6-1"><span class="section-number-4">17.6.1</span> Step 1: Start Writing Tests</h4>
</div>
<div id="outline-container-sec-17-6-2" class="outline-4">
<h4 id="sec-17-6-2"><span class="section-number-4">17.6.2</span> Step 2: Run Tests and Generate Coverage Report</h4>
<div class="outline-text-4" id="text-17-6-2">
<p>
In the command-line, at the &lt;project root&gt;, type:<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ coverage run manage.py <span class="built_in">test</span> --settings=twoscoops.settings.test</span><br></pre></td></tr></table></figure>
</div>
<p>
If we have nothing except for the default tests for two apps, we should get a response that looks like:<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Creating <span class="built_in">test</span> database <span class="keyword">for</span> <span class="built_in">alias</span> <span class="string">"default"</span>...</span><br><span class="line">..</span><br><span class="line">-----------------------------------------------</span><br><span class="line">Ran <span class="number">2</span> tests <span class="keyword">in</span> <span class="number">0.008</span>s</span><br><span class="line">OK</span><br><span class="line">Destroying <span class="built_in">test</span> database <span class="keyword">for</span> <span class="built_in">alias</span> <span class="string">"default"</span>...</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-17-6-3" class="outline-4">
<h4 id="sec-17-6-3"><span class="section-number-4">17.6.3</span> Step 3: Generate the Report!</h4>
<div class="outline-text-4" id="text-17-6-3">
<p>
In the command-line, at the &lt;project root&gt;:<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ coverage html --omit=<span class="string">"admin.py"</span></span><br></pre></td></tr></table></figure>
</div>
<p>
After this runs, in the &lt;project root&gt; directory there is a new directory called htmlcov/ . In the htmlcov/ directory, open the index.html file using any browser.<br>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-18" class="outline-2">
<h2 id="sec-18"><span class="section-number-2">18</span> Documentation</h2>
<div class="outline-text-2" id="text-18">
</div><div id="outline-container-sec-18-1" class="outline-3">
<h3 id="sec-18-1"><span class="section-number-3">18.1</span> Use reStructuredText for Python Docs</h3>
<div class="outline-text-3" id="text-18-1">
<p>
<a href="http://docutils.sourceforge.net/docs/ref/rst/restructuredtext.html" target="_blank" rel="external">http://docutils.sourceforge.net/docs/ref/rst/restructuredtext.html</a><br>
here is a quick primer of some very useful commands you should learn:<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Section Header</span><br><span class="line"></span><br><span class="line">**emphasis (bold/strong)**</span><br><span class="line"></span><br><span class="line">*italics*</span><br><span class="line"></span><br><span class="line">Simple link: http://django.<span class="number">2</span>scoops.org</span><br><span class="line">Fancier Link: `Two Scoops of Django`_</span><br><span class="line"></span><br><span class="line">.. _Two Scoops of Django: https://django.<span class="number">2</span>scoops.org</span><br><span class="line"></span><br><span class="line">Subsection Header</span><br><span class="line"></span><br><span class="line"><span class="comment">#) An enumerated list item</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#) Second item</span></span><br><span class="line"></span><br><span class="line"> * First bullet</span><br><span class="line"></span><br><span class="line"> * Second bullet</span><br><span class="line"></span><br><span class="line">   * Indented Bullet</span><br><span class="line"></span><br><span class="line">   * Note carriage <span class="built_in">return</span> and indents</span><br><span class="line"></span><br><span class="line">Literal code block::</span><br><span class="line"></span><br><span class="line">    def like():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">"I like Ice Cream"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">	like()</span><br><span class="line"></span><br><span class="line">Python colored code block (requires pygments):</span><br><span class="line"></span><br><span class="line">code-block:: python</span><br><span class="line"></span><br><span class="line">    <span class="comment"># You need to "pip install pygments" to make this work.</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>): </span><br><span class="line">	like()</span><br><span class="line"></span><br><span class="line">JavaScript colored code block:</span><br><span class="line"></span><br><span class="line">code-block:: javascript</span><br><span class="line"></span><br><span class="line">    console.log(<span class="string">"Don't use alert()"</span>);</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-18-2" class="outline-3">
<h3 id="sec-18-2"><span class="section-number-3">18.2</span> Use Sphinx to Generate Documentation From reStructuredText</h3>
<div class="outline-text-3" id="text-18-2">
<p>
Sphinx is a tool for generating nice-looking docs from your .rst  les. Output formats include HTML, LaTeX, manual pages, and plain text.<br>
Follow the instructions to generate Sphinx docs: <a href="http://sphinx-doc.org/" target="_blank" rel="external">http://sphinx-doc.org/</a>.<br>
</p>
</div>
</div>
<div id="outline-container-sec-18-3" class="outline-3">
<h3 id="sec-18-3"><span class="section-number-3">18.3</span> What Docs Should Django Projects Contain?</h3>
<div class="outline-text-3" id="text-18-3">
<p>
Here we provide a table that describes what we consider the absolute minimum documentation:<br>
<i><img src="/my_blog/2016/02/19/django學習筆記/table23_1.png" alt="table23_1.png" title=""></i><br>
</p>
</div>
</div>

<div id="outline-container-sec-18-4" class="outline-3">
<h3 id="sec-18-4"><span class="section-number-3">18.4</span> Additional Documentation Resources</h3>
<div class="outline-text-3" id="text-18-4">
<ul class="org-ul">
<li><a href="http://www.python.org/dev/peps/pep-0257" target="_blank" rel="external">http://www.python.org/dev/peps/pep-0257</a> Official speci cation on docstrings.<br>
</li>
<li><a href="https://readthedocs.org/" target="_blank" rel="external">https://readthedocs.org/</a> Read the Docs is a free service that can host your Sphinx documentation.<br>
</li>
<li><a href="http://pythonhosted.org/" target="_blank" rel="external">http://pythonhosted.org/</a> Python Hosted is another free service for documentation hosting.<br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-19" class="outline-2">
<h2 id="sec-19"><span class="section-number-2">19</span> Finding and Reducing Bottlenecks</h2>
<div class="outline-text-2" id="text-19">
</div><div id="outline-container-sec-19-1" class="outline-3">
<h3 id="sec-19-1"><span class="section-number-3">19.1</span> Should You Even Care?</h3>
<div class="outline-text-3" id="text-19-1">
<p>
Remember, premature optimization is bad. If your site is small- or medium-sized and the pages are loading  ne, then it’s okay to skip this chapter.<br>
</p>
</div>
</div>
<div id="outline-container-sec-19-2" class="outline-3">
<h3 id="sec-19-2"><span class="section-number-3">19.2</span> Speed Up Query-Heavy Pages</h3>
<div class="outline-text-3" id="text-19-2">
</div><div id="outline-container-sec-19-2-1" class="outline-4">
<h4 id="sec-19-2-1"><span class="section-number-4">19.2.1</span> Find Excessive Queries With Django Debug Toolbar</h4>
<div class="outline-text-4" id="text-19-2-1">
<p>
You’ll find bottlenecks such as:<br>
</p>
<ul class="org-ul">
<li>Duplicate queries in a page.<br>
</li>
<li>ORM calls that resolve to many more queries than you expected.<br>
</li>
<li>Slow queries.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-19-2-2" class="outline-4">
<h4 id="sec-19-2-2"><span class="section-number-4">19.2.2</span> Reduce the Number of Queries</h4>
<div class="outline-text-4" id="text-19-2-2">
<ul class="org-ul">
<li>Try using select_related() in your ORM calls to combine queries. It follows ForeignKey relations and combines more data into a larger query. If using CBVs, django-braces makes doing this trivial with the SelectRelatedMixin.<br>
</li>
<li>For many-to-many and many-to-one relationships that can’t be optimized with select_related(), explore using prefetch_related() instead.<br>
</li>
<li>If the same query is being generated more than once per template, move the query into the Python view, add it to the context as a variable, and point the template ORM calls at this new context variable.<br>
</li>
<li>Implement caching using a key/value store such as Memcached.  en write tests to assert the number of queries run in a view. See <a href="http://2scoops.co/1.8-test-num-queries" target="_blank" rel="external">http://2scoops.co/1.8-test-num-queries</a> for instructions.<br>
</li>
<li>Use the django.utils.functional.cached_property decorator to cache in memory the result of method call for the life of an object instance. This is incredibly useful.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-19-2-3" class="outline-4">
<h4 id="sec-19-2-3"><span class="section-number-4">19.2.3</span> Speed Up Common Queries</h4>
<div class="outline-text-4" id="text-19-2-3">
<ul class="org-ul">
<li>Make sure your indexes are helping speed up your most common slow queries. Look at the raw SQL generated by those queries, and index on the fields that you filter/sort on most frequently. Look at the generated WHERE and ORDER BY clauses.<br>
</li>
<li>Understand what your indexes are actually doing in production. Development machines will never perfectly replicate what happens in production, so learn how to analyze and understand what’s really happening with your database.<br>
</li>
<li>Look at the query plans generated by common queries.<br>
</li>
<li>Turn on your database’s slow query logging feature and see if any slow queries occur frequently.<br>
</li>
<li>Use django-debug-toolbar in development to identify potentially-slow queries defensively, before they hit production.<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-19-2-4" class="outline-4">
<h4 id="sec-19-2-4"><span class="section-number-4">19.2.4</span> Switch ATOMIC REQUESTS to False</h4>
</div>
</div>

<div id="outline-container-sec-19-3" class="outline-3">
<h3 id="sec-19-3"><span class="section-number-3">19.3</span> Know What Doesn't Belong in the Database</h3>
<div class="outline-text-3" id="text-19-3">
<p>
Three things that should never go into any large site’s relational database:<br>
<b>Logs.</b> Don’t add logs to the database. Logs may seem OK on the surface, especially in development. Yet adding this many writes to a production database will slow their performance. When the ability to easily perform complex queries against your logs is necessary, we recommend third-party services such as Splunk or Loggly, or use of document-based NoSQL databases.<br>
</p>

<p>
<b>Ephemeral data.</b> Don’t store ephemeral data in the database. What this means is data that re- quires constant rewrites is not ideal for use in relational databases.  is includes examples such as django.contrib.sessions, django.contrib.messages, and metrics. Instead, move this data to things like Memcached, Redis, Riak, and other non-relational stores.<br>
</p>

<p>
<b>Binary Data</b><br>
</p>
</div>
</div>
<div id="outline-container-sec-19-4" class="outline-3">
<h3 id="sec-19-4"><span class="section-number-3">19.4</span> Cache Queries With Memcached or Redis</h3>
<div class="outline-text-3" id="text-19-4">
<p>
Reference material:<br>
</p>
<ul class="org-ul">
<li><a href="https://docs.djangoproject.com/en/1.8/topics/cache/" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/cache/</a><br>
</li>
<li><a href="https://github.com/sebleier/django-redis-cache/" target="_blank" rel="external">https://github.com/sebleier/django-redis-cache/</a><br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-19-5" class="outline-3">
<h3 id="sec-19-5"><span class="section-number-3">19.5</span> Identify Specific Places to Cache</h3>
<div class="outline-text-3" id="text-19-5">
<p>
Here are things to think about:<br>
</p>
<ul class="org-ul">
<li>Which views/templates contain the most queries?<br>
</li>
<li>Which URLs are being requested the most?<br>
</li>
<li>When should a cache for a page be invalidated?<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-19-6" class="outline-3">
<h3 id="sec-19-6"><span class="section-number-3">19.6</span> Compression and Minification of HTML, CSS, and JavaScript</h3>
<div class="outline-text-3" id="text-19-6">
<ul class="org-ul">
<li>Apache and Nginx compression modules<br>
</li>
<li>django-pipeline<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-19-7" class="outline-3">
<h3 id="sec-19-7"><span class="section-number-3">19.7</span> Use Upstream Caching or a Content Delivery Network</h3>
<div class="outline-text-3" id="text-19-7">
<p>
<b>Upstream caches</b> such as <b>Varnish</b> are very useful. They run in front of your web server and speed up web page or content serving signi cantly. See <a href="http://varnish-cache.org/" target="_blank" rel="external">http://varnish-cache.org/</a>.<br>
</p>

<p>
<b>Content Delivery Networks (CDNs)</b> like Fastly, Akamai, and Amazon Cloudfront serve static me- dia such as images, video, CSS, and JavaScript  les.  ey usually have servers all over the world, which serve out your static content from the nearest location. Using a CDN rather than serving static content from your application servers can speed up your projects.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-20" class="outline-2">
<h2 id="sec-20"><span class="section-number-2">20</span> Asynchronous Task Queues</h2>
<div class="outline-text-2" id="text-20">
<p>
An asynchronous task queue is one where tasks are executed at a different time from when they are created, and possibly not in the same order they were created.<br>
</p>
</div>
<div id="outline-container-sec-20-1" class="outline-3">
<h3 id="sec-20-1"><span class="section-number-3">20.1</span> Do We Need a Task Queue?</h3>
<div class="outline-text-3" id="text-20-1">
<p>
Here is a useful rule of thumb for determining if a task queue should be used:<br>
<b>Results take time to process:</b> Task queue should probably be used.<br>
<b>Users can and should see results immediately:</b> Task queue should not be used.<br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Use Task Queue?</th>
<th scope="col" class="left">Issue</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">Yes</td>
<td class="left">Sending bulk email</td>
</tr>

<tr>
<td class="left">Yes</td>
<td class="left">Modifying files (including images)</td>
</tr>

<tr>
<td class="left">Yes</td>
<td class="left">Fetching large amounts of data from third-party Ice Cream APIs</td>
</tr>

<tr>
<td class="left">Yes</td>
<td class="left">Inserting or updating a lot of records into a table</td>
</tr>

<tr>
<td class="left">No</td>
<td class="left">Updating a user profile</td>
</tr>

<tr>
<td class="left">No</td>
<td class="left">Adding a blog or CMS entry</td>
</tr>

<tr>
<td class="left">Yes</td>
<td class="left">Performing time-intensive calculations</td>
</tr>

<tr>
<td class="left">Yes</td>
<td class="left">Sending or receiving of webhooks</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>Sites with small-to-medium amounts of traffic may never need a task queue for any of these actions.<br>
</li>
<li>Sites with larger amounts of traffic may discover that nearly every user action requires use of a task queue.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-20-2" class="outline-3">
<h3 id="sec-20-2"><span class="section-number-3">20.2</span> Choosing Task Queue Software</h3>
<div class="outline-text-3" id="text-20-2">
<p>
Celery, Redis Queue, django-background-tasks, which to choose? Let’s go over their pros and cons:<br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Software</th>
<th scope="col" class="left">Pros</th>
<th scope="col" class="left">Cons</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left"><a href="http://www.celeryproject.org/" target="_blank" rel="external">Celery</a></td>
<td class="left">Defacto Django standard, many different storage types, flexible, full-featured, great for high volume</td>
<td class="left">Challenging setup, overkill for slower traffic sites</td>
</tr>

<tr>
<td class="left"><a href="http://python-rq.org/" target="_blank" rel="external">Redis Queue</a></td>
<td class="left">Flexible, powered by Redis, lower memory footprint then Celery, great for high volume, can use django-rq or not</td>
<td class="left">Not as many features as Celery, medium difficulty setup, Redis only option for storage</td>
</tr>

<tr>
<td class="left"><a href="https://pypi.python.org/pypi/django-background-tasks" target="_blank" rel="external">django-background-tasks</a></td>
<td class="left">Very easy setup, easy to use, good for small volume or batch jobs, uses Django ORM for backend</td>
<td class="left">Uses Django ORM for backend, absolutely terrible for medium-to-high volume</td>
</tr>
</tbody>
</table>

<p>
Here is our general rule of thumb:<br>
</p>
<ul class="org-ul">
<li>For most high-to-low volume projects, we recommend Redis Queue.<br>
</li>
<li>For high-volume projects with the need for complex task management, we recommend Celery.<br>
</li>
<li>For small volume projects, especially for running of periodic batch jobs, we recommend django-background-tasks<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-20-3" class="outline-3">
<h3 id="sec-20-3"><span class="section-number-3">20.3</span> Best Practices for Task Queues</h3>
<div class="outline-text-3" id="text-20-3">
</div><div id="outline-container-sec-20-3-1" class="outline-4">
<h4 id="sec-20-3-1"><span class="section-number-4">20.3.1</span> Treat Tasks Like Views</h4>
<div class="outline-text-4" id="text-20-3-1">
<p>
we recommend that views contain as little code as possible, calling methods and functions from other places in the code base. We believe the same thing applies to tasks.<br>
you can put your task code into a function, put that function into a helper module, and then call that function from a task function.<br>
</p>
</div>
</div>
<div id="outline-container-sec-20-3-2" class="outline-4">
<h4 id="sec-20-3-2"><span class="section-number-4">20.3.2</span> Tasks Aren't Free</h4>
</div>
<div id="outline-container-sec-20-3-3" class="outline-4">
<h4 id="sec-20-3-3"><span class="section-number-4">20.3.3</span> Only Pass JSON-Serializable Values to Task Functions</h4>
<div class="outline-text-4" id="text-20-3-3">
<p>
That limits us to integers,  oats, strings, lists, tuples, and dictionaries. Don’t pass in complex objects.<br>
Passing in an object representing persistent data (ORM instances for example can cause a race condition.)<br>
</p>
</div>
</div>
<div id="outline-container-sec-20-3-4" class="outline-4">
<h4 id="sec-20-3-4"><span class="section-number-4">20.3.4</span> Learn How to Monitor Tasks and Workers</h4>
<div class="outline-text-4" id="text-20-3-4">
<p>
Some useful tools:<br>
</p>
<ul class="org-ul">
<li>Celery: <a href="https://pypi.python.org/pypi/flower" target="_blank" rel="external">https://pypi.python.org/pypi/flower</a><br>
</li>
<li>Redis Queue: <a href="https://pypi.python.org/pypi/django-redisboard" target="_blank" rel="external">https://pypi.python.org/pypi/django-redisboard</a> for using Redis Queue directly.<br>
</li>
<li>django-rq: <a href="https://pypi.python.org/pypi/django-rq" target="_blank" rel="external">https://pypi.python.org/pypi/django-rq</a> for using django-rq.<br>
</li>
<li>django.contrib.admin for django-background-tasks.<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-20-3-5" class="outline-4">
<h4 id="sec-20-3-5"><span class="section-number-4">20.3.5</span> Logging!</h4>
</div>
<div id="outline-container-sec-20-3-6" class="outline-4">
<h4 id="sec-20-3-6"><span class="section-number-4">20.3.6</span> Monitor the Backlog</h4>
<div class="outline-text-4" id="text-20-3-6">
<p>
As traffic increases, tasks can pile up if there aren’t enough workers. When we see this happening, it’s time to increase the number of workers.<br>
</p>
</div>
</div>
<div id="outline-container-sec-20-3-7" class="outline-4">
<h4 id="sec-20-3-7"><span class="section-number-4">20.3.7</span> Periodically Clear Out Dead Tasks</h4>
</div>
<div id="outline-container-sec-20-3-8" class="outline-4">
<h4 id="sec-20-3-8"><span class="section-number-4">20.3.8</span> Use the Queue's Error Handling</h4>
<div class="outline-text-4" id="text-20-3-8">
<ul class="org-ul">
<li>Max retries for a task<br>
</li>
<li>Retry delays<br>
</li>
</ul>
<p>
When a task fails, we like to wait at least 10 seconds before trying again. Even better, if the task queue software allows it, increase the delay each time an attempt is made.<br>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-21" class="outline-2">
<h2 id="sec-21"><span class="section-number-2">21</span> Security</h2>
<div class="outline-text-2" id="text-21">
</div><div id="outline-container-sec-21-1" class="outline-3">
<h3 id="sec-21-1"><span class="section-number-3">21.1</span> Know Django's Security Features</h3>
<div class="outline-text-3" id="text-21-1">
<p>
Django 1.8’s security features include:<br>
</p>
<ul class="org-ul">
<li>Cross-site scripting (XSS) protection.<br>
</li>
<li>Cross-site request forgery (CSRF) protection.<br>
</li>
<li>SQL injection protection.<br>
</li>
<li>Clickjacking protection.<br>
</li>
<li>Support for TLS/HTTPS/HSTS, including secure cookies.<br>
</li>
<li>Secure password storage, using the PBKDF2 algorithm with a SHA256 hash by default.<br>
</li>
<li>Automatic HTML escaping.<br>
</li>
<li>An expat parser hardened against XML bomb attacks.<br>
</li>
<li>Hardened JSON, YAML, and XML serialization/deserialization tools.<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-21-2" class="outline-3">
<h3 id="sec-21-2"><span class="section-number-3">21.2</span> Turn Off DEBUG Mode in Production</h3>
<div class="outline-text-3" id="text-21-2">
<p>
Keep in mind that when you turn off DEBUG mode, you will need to set ALLOWED HOSTS or risk raising a SuspiciousOperation error, which generates a 500 error that can be hard to debug.<br>
</p>
</div>
</div>
<div id="outline-container-sec-21-3" class="outline-3">
<h3 id="sec-21-3"><span class="section-number-3">21.3</span> Keep Your Secret Keys Secret</h3>
</div>
<div id="outline-container-sec-21-4" class="outline-3">
<h3 id="sec-21-4"><span class="section-number-3">21.4</span> HTTPS Everywhere</h3>
<div class="outline-text-3" id="text-21-4">
</div><div id="outline-container-sec-21-4-1" class="outline-4">
<h4 id="sec-21-4-1"><span class="section-number-4">21.4.1</span> Use django.middleware.security.SecurityMiddleware</h4>
<div class="outline-text-4" id="text-21-4-1">
<p>
The tool of choice for projects on Django 1.8+ for enforcing HTTPS/SSL across an entire site through middleware is built right in. To activate this middleware just follow these steps:<br>
</p>
<ol class="org-ol">
<li>Add django.middleware.security.SecurityMiddleware to the settings.MIDDLEWARE CLASSES definition.<br>
</li>
<li>Set settings.SECURE SSL HOST to True.<br>
</li>
</ol>

<p>
django.middleware.security.SecurityMiddleware Does Not Include static/media, static assets are typically served directly by the web<br>
server (nginx, Apache)<br>
</p>
</div>
</div>
<div id="outline-container-sec-21-4-2" class="outline-4">
<h4 id="sec-21-4-2"><span class="section-number-4">21.4.2</span> Use Secure Cookies</h4>
<div class="outline-text-4" id="text-21-4-2">
<p>
Your site should inform the target browser to never send cookies unless via HTTPS. You’ll need to set the following in your settings:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SESSION_COOKIE_SECURE = <span class="keyword">True</span></span><br><span class="line">CSRF_COOKIE_SECURE = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-21-4-3" class="outline-4">
<h4 id="sec-21-4-3"><span class="section-number-4">21.4.3</span> Use HTTP Strict Transport Security (HSTS)</h4>
<div class="outline-text-4" id="text-21-4-3">
<p>
HSTS can be con gured at the web server level. Follow the instructions for your web server, platform- as-a-service, and Django itself (via settings.SECURE HSTS SECONDS).<br>
</p>
</div>
</div>
<div id="outline-container-sec-21-4-4" class="outline-4">
<h4 id="sec-21-4-4"><span class="section-number-4">21.4.4</span> HTTPS Configuration Tools</h4>
<div class="outline-text-4" id="text-21-4-4">
<p>
Mozilla provides a SSL con guration generator at the <a href="https://mozilla.github.io/server-side-tls/ssl-config-generator/" target="_blank" rel="external">https://mozilla.github.io/server-side-tls/ssl-config-generator/</a><br>
Once you have a server set up (preferably a test server), use the Qualys SSL Labs server test at <a href="https://www.ssllabs.com/ssltest/" target="_blank" rel="external">https://www.ssllabs.com/ssltest/</a> to see how well you did.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-21-5" class="outline-3">
<h3 id="sec-21-5"><span class="section-number-3">21.5</span> Use Allowed Hosts Validation</h3>
<div class="outline-text-3" id="text-21-5">
<p>
We recommend that you avoid setting wildcard values here.<br>
<a href="https://docs.djangoproject.com/en/1.8/ref/settings/#allowed-hosts" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/ref/settings/#allowed-hosts</a><br>
<a href="https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest.get_host" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/ref/request-response/#django.http.HttpRequest.get_host</a><br>
</p>
</div>
</div>
<div id="outline-container-sec-21-6" class="outline-3">
<h3 id="sec-21-6"><span class="section-number-3">21.6</span> Always Use CSRF Protection With HTTP Forms That Modify Data</h3>
</div>
<div id="outline-container-sec-21-7" class="outline-3">
<h3 id="sec-21-7"><span class="section-number-3">21.7</span> Obfuscate Primary Keys with UUIDs</h3>
<div class="outline-text-3" id="text-21-7">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid <span class="keyword">as</span> uuid_lib</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils.encoding <span class="keyword">import</span> python_2_unicode_compatible</span><br><span class="line"></span><br><span class="line"><span class="decorator">@python_2_unicode_compatible</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IceCreamPayment</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"></span><br><span class="line">    uuid = models.UUIDField(</span><br><span class="line">	db_index=<span class="keyword">True</span>,</span><br><span class="line">	default=uuid_lib.uuid4,</span><br><span class="line">	editable=<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span> </span><br><span class="line">	<span class="keyword">return</span> str(self.pk)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-22" class="outline-2">
<h2 id="sec-22"><span class="section-number-2">22</span> Logging</h2>
<div class="outline-text-2" id="text-22">
</div><div id="outline-container-sec-22-1" class="outline-3">
<h3 id="sec-22-1"><span class="section-number-3">22.1</span> When to Use Each Log Level</h3>
<div class="outline-text-3" id="text-22-1">
<p>
In your production environment, we recommend using every log level except for DEBUG.<br>
</p>
</div>
<div id="outline-container-sec-22-1-1" class="outline-4">
<h4 id="sec-22-1-1"><span class="section-number-4">22.1.1</span> Log Catastrophes With CRITICAL</h4>
<div class="outline-text-4" id="text-22-1-1">
<p>
For example, if your code relies on an internal web service being available, and if that web service is part of your site’s core functionality, then you might log at the CRITICAL level anytime that the web service is inaccessible.<br>
</p>
</div>
</div>
<div id="outline-container-sec-22-1-2" class="outline-4">
<h4 id="sec-22-1-2"><span class="section-number-4">22.1.2</span> Log Production Errors With ERROR</h4>
<div class="outline-text-4" id="text-22-1-2">
<p>
whenever code raises an exception that is not caught, the event gets logged by Django using the following code:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Taken directly from core Django code.</span></span><br><span class="line"><span class="comment"># Used here to illustrate an example only, so don't</span></span><br><span class="line"><span class="comment"># copy this into your project.</span></span><br><span class="line">logger.error(<span class="string">"Internal Server Error: %s"</span>, request.path,</span><br><span class="line">    exc_info=exc_info,</span><br><span class="line">    extra={</span><br><span class="line">	<span class="string">"status_code"</span>: <span class="number">500</span>,</span><br><span class="line">	<span class="string">"request"</span>: request</span><br><span class="line">    }</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
</div>
<p>
we recommend that you use the ERROR log level whenever you need to log an error that is worthy of being emailed to you or your site admins.<br>
</p>
</div>
</div>
<div id="outline-container-sec-22-1-3" class="outline-4">
<h4 id="sec-22-1-3"><span class="section-number-4">22.1.3</span> Log Lower-Priority Problems With WARNING</h4>
<div class="outline-text-4" id="text-22-1-3">
<p>
This level is good for logging events that are unusual and potentially bad, but not as bad as ERROR- level events.<br>
For example, when an incoming POST request is missing its csrf token, the event gets logged as follows:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Taken directly from core Django code.</span></span><br><span class="line"><span class="comment"># Used here to illustrate an example only, so don't</span></span><br><span class="line"><span class="comment"># copy this into your project.</span></span><br><span class="line">logger.warning(<span class="string">"Forbidden (%s): %s"</span>,</span><br><span class="line">	       REASON_NO_CSRF_COOKIE, request.path,</span><br><span class="line">    extra={</span><br><span class="line">	<span class="string">"status_code"</span>: <span class="number">403</span>,</span><br><span class="line">	<span class="string">"request"</span>: request,</span><br><span class="line">} )</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-22-1-4" class="outline-4">
<h4 id="sec-22-1-4"><span class="section-number-4">22.1.4</span> Log Useful State Information With INFO</h4>
<div class="outline-text-4" id="text-22-1-4">
<p>
We recommend using this level to log any details that may be particularly important when analysis is needed. These include:<br>
</p>
<ul class="org-ul">
<li>Startup and shutdown of important components not logged elsewhere<br>
</li>
<li>State changes that occur in response to important events<br>
</li>
<li>Changes to permissions, e.g. when users are granted admin access<br>
</li>
</ul>
<p>
In addition to this, the INFO level is great for logging any general information that may help in performance analysis.<br>
</p>
</div>
</div>
<div id="outline-container-sec-22-1-5" class="outline-4">
<h4 id="sec-22-1-5"><span class="section-number-4">22.1.5</span> Log Debug-Related Messages to DEBUG</h4>
<div class="outline-text-4" id="text-22-1-5">
<p>
In development, we recommend using DEBUG and occasionally INFO level logging wherever you’d consider throwing a print statement into your code for debugging purposes.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> TemplateView</span><br><span class="line"><span class="keyword">from</span> .helpers <span class="keyword">import</span> pint_counter</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PintView</span><span class="params">(TemplateView)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_context_data</span><span class="params">(self, *args, **kwargs)</span>:</span></span><br><span class="line">	context = super(PintView, self).get_context_data(**kwargs) </span><br><span class="line">	pints_remaining = pint_counter()</span><br><span class="line">	logger.debug(<span class="string">"Only %d pints of ice cream left."</span> % pints_remaining) </span><br><span class="line">	<span class="keyword">return</span> context</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-22-2" class="outline-3">
<h3 id="sec-22-2"><span class="section-number-3">22.2</span> Log Tracebacks When Catching Exceptions</h3>
<div class="outline-text-3" id="text-22-2">
<ol class="org-ol">
<li>Logger.exception() automatically includes the traceback and logs at ERROR level.<br>
</li>
<li>For other log levels, use the optional exc_info keyword argument.<br>
</li>
</ol>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> logging <span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_additional_data</span><span class="params">()</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	r = requests.get(<span class="string">"http://example.com/something-optional/"</span>) </span><br><span class="line">    <span class="keyword">except</span> requests.HTTPError <span class="keyword">as</span> e:</span><br><span class="line">	logger.exception(e)</span><br><span class="line">	logger.debug(<span class="string">"Could not get additional data"</span>, exc_info=<span class="keyword">True</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">None</span> </span><br><span class="line">    <span class="keyword">return</span> r</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-22-3" class="outline-3">
<h3 id="sec-22-3"><span class="section-number-3">22.3</span> One Logger Per Module That Uses Logging</h3>
<div class="outline-text-3" id="text-22-3">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># You can place this snippet at the top</span></span><br><span class="line"><span class="comment"># of models.py, views.py, or any other</span></span><br><span class="line"><span class="comment"># file where you need to log. </span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br></pre></td></tr></table></figure>
</div>
<p>
If you’re running into a strange issue in production that you can’t replicate locally, you can temporarily turn on DEBUG logging for just the module related to the issue<br>
</p>
</div>
</div>
<div id="outline-container-sec-22-4" class="outline-3">
<h3 id="sec-22-4"><span class="section-number-3">22.4</span> Log Locally to Rotating Files</h3>
<div class="outline-text-3" id="text-22-4">
<p>
A common way to set up log rotation is to use the UNIX logrotate utility with log- ging.handlers.WatchedFileHandler.<br>
Note that if you are using a platform-as-a-service, you might not be able to set up rotating log files. In this case, you may need to use an external logging service such as Loggly: <a href="http://loggly.com/" target="_blank" rel="external">http://loggly.com/</a>.<br>
</p>
</div>
</div>
<div id="outline-container-sec-22-5" class="outline-3">
<h3 id="sec-22-5"><span class="section-number-3">22.5</span> Log settings files</h3>
<div class="outline-text-3" id="text-22-5">
<p>
<a href="https://docs.djangoproject.com/en/1.8/topics/logging/" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/logging/</a><br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-23" class="outline-2">
<h2 id="sec-23"><span class="section-number-2">23</span> Signals: Use Cases and Avoidance Techniques</h2>
<div class="outline-text-2" id="text-23">
<p>
Signals can be useful, but they should be used as a last resort, only when there’s no good way to avoid using them.<br>
</p>
</div>
<div id="outline-container-sec-23-1" class="outline-3">
<h3 id="sec-23-1"><span class="section-number-3">23.1</span> When to Use and Avoid Signals</h3>
<div class="outline-text-3" id="text-23-1">
<p>
Do not use signals when:<br>
</p>
<ul class="org-ul">
<li>The signal relates to one particular model and can be moved into one of that model’s methods, possibly called by save().<br>
</li>
<li>The signal can be replaced with a custom model manager method.<br>
</li>
<li>The signal relates to a particular view and can be moved into that view.<br>
</li>
</ul>

<p>
It might be okay to use signals when:<br>
</p>
<ul class="org-ul">
<li>Your signal receiver needs to make changes to more than one model.<br>
</li>
<li>You want to dispatch the same signal from multiple apps and have them handled the same way by a common receiver.<br>
</li>
<li>You want to invalidate a cache after a model save.<br>
</li>
<li>You have an unusual scenario that needs a callback, and there’s no other way to handle it besides using a signal. For example, you want to trigger something based on the save() or init() of a third-party app’s model. You can’t modify the third-party code and extending it might be impossible, so a signal provides a trigger for a callback.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-23-2" class="outline-3">
<h3 id="sec-23-2"><span class="section-number-3">23.2</span> Signal Avoidance Techniques</h3>
<div class="outline-text-3" id="text-23-2">
</div><div id="outline-container-sec-23-2-1" class="outline-4">
<h4 id="sec-23-2-1"><span class="section-number-4">23.2.1</span> Using Custom Model Manager Methods Instead of Signals</h4>
<div class="outline-text-4" id="text-23-2-1">
<p>
Let’s imagine that our site handles user-submitted ice cream-themed events, and each ice cream event goes through an approval process. These events are set with a status of “Unreviewed” upon creation. The problem is that we want our site administrators to get an email for each event submission so they know to review and post things quickly.<br>
We could have done this with a signal, but unless we put in extra logic in the post save() code, even administrator created events would generate emails.<br>
</p>

<p>
Use custom model manager instead of signals to solve above.<br>
EventManager:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># events/managers.py</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_event</span><span class="params">(self, title, start, end, creator)</span>:</span></span><br><span class="line">	event = self.model(title=title,</span><br><span class="line">			    start=start,</span><br><span class="line">			    end=end,</span><br><span class="line">			    creator=creator)</span><br><span class="line">	event.save() </span><br><span class="line">	event.notify_admins() </span><br><span class="line">	<span class="keyword">return</span> event</span><br></pre></td></tr></table></figure>
</div>
<p>
Let’s attach it to our model (which comes with a notify admins() method:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># events/models.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.core.mail <span class="keyword">import</span> mail_admins </span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> model_utils.models <span class="keyword">import</span> TimeStampedModel</span><br><span class="line"><span class="keyword">from</span> .managers <span class="keyword">import</span> EventManager</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span><span class="params">(TimeStampedModel)</span>:</span></span><br><span class="line">    STATUS_UNREVIEWED, STATUS_REVIEWED = (<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    STATUS_CHOICES = (</span><br><span class="line">	(STATUS_UNREVIEWED, <span class="string">"Unreviewed"</span>),</span><br><span class="line">	(STATUS_REVIEWED, <span class="string">"Reviewed"</span>),</span><br><span class="line">    )</span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    start = models.DateTimeField()</span><br><span class="line">    end = models.DateTimeField()</span><br><span class="line">    status = models.IntegerField(choices=STATUS_CHOICES,</span><br><span class="line">				    default=STATUS_UNREVIEWED)</span><br><span class="line">    creator = models.ForeignKey(settings.AUTH_USER_MODEL)</span><br><span class="line">    objects = EventManager()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify_admins</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="comment"># create the subject and message</span></span><br><span class="line">	subject = <span class="string">"{user} submitted a new event!"</span>.format(</span><br><span class="line">				user=self.creator.get_full_name())</span><br><span class="line">		message = <span class="string">"""TITLE: {title}</span><br><span class="line">	START: {start}</span><br><span class="line">	END: {end}"""</span>.format(title=self.title, start=self.start,</span><br><span class="line">				end=self.end)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># Send to the admins!</span></span><br><span class="line">	mail_admins(subject=subject,</span><br><span class="line">	    message=message,</span><br><span class="line">	    fail_silently=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
</div>
<p>
To generate an event, instead of calling create(), we call a create event() method.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&amp;gt;&amp;gt;&amp;gt; <span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; <span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; <span class="keyword">from</span> events.models <span class="keyword">import</span> Event</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; user = get_user_model().get(username=<span class="string">"audreyr"</span>)</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; now = timezone.now()</span><br><span class="line">&amp;gt;&amp;gt;&amp;gt; event = Event.objects.create_event(</span><br><span class="line"><span class="prompt">... </span>    title=<span class="string">"International Ice Cream Tasting Competition"</span>,</span><br><span class="line"><span class="prompt">... </span>    start=now,</span><br><span class="line"><span class="prompt">... </span>    end=now,</span><br><span class="line"><span class="prompt">... </span>    user=user</span><br><span class="line"><span class="prompt">... </span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-23-2-2" class="outline-4">
<h4 id="sec-23-2-2"><span class="section-number-4">23.2.2</span> Validate Your Model Elsewhere</h4>
<div class="outline-text-4" id="text-23-2-2">
<p>
If you’re using a pre save signal to trigger input cleanup for a speci c model, try writing a custom validator for your  eld(s) instead.<br>
If validating through a ModelForm, try overriding your model’s clean() method instead.<br>
</p>
</div>
</div>
<div id="outline-container-sec-23-2-3" class="outline-4">
<h4 id="sec-23-2-3"><span class="section-number-4">23.2.3</span> Override Your Model's Save or Delete Method Instead</h4>
<div class="outline-text-4" id="text-23-2-3">
<p>
If you’re using pre save and post save signals to trigger logic that only applies to one particular model, you might not need those signals. You can often simply move the signal logic into your model’s save() method.<br>
</p>
</div>
</div>
<div id="outline-container-sec-23-2-4" class="outline-4">
<h4 id="sec-23-2-4"><span class="section-number-4">23.2.4</span> Use a Helper Function Instead of Signals</h4>
<div class="outline-text-4" id="text-23-2-4">
<p>
We find this approach useful under two conditions:<br>
</p>
<ul class="org-ul">
<li><i>Refactoring:</i> Once we realize that certain bits of code no longer need to be obfuscated as signals and want to refactor, the question of ‘Where do we put the code that was in a signal?’ arises. If it doesn’t belong in a model manager, custom validator, or overloaded model method, where does it belong?<br>
</li>
<li><i>Architecture:</i> Sometimes developers use signals because we feel the model has become too heavyweight and we need a place for code. While Fat Models are a nice approach, we admit it’s not much fun to have to parse through a 500 or 2000 line chunk of code.<br>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-24" class="outline-2">
<h2 id="sec-24"><span class="section-number-2">24</span> Utilities</h2>
<div class="outline-text-2" id="text-24">
</div><div id="outline-container-sec-24-1" class="outline-3">
<h3 id="sec-24-1"><span class="section-number-3">24.1</span> Create a Core App for Your Utilities</h3>
<div class="outline-text-3" id="text-24-1">
<p>
<b>TIP: Always make the core app a real Django app</b><br>
Our core app would therefore look like:<br>
</p>
<div class="org-src-container">

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">core/</span><br><span class="line">    __init__.py</span><br><span class="line">    managers.py <span class="comment"># contains the custom model manager(s)</span></span><br><span class="line">    models.py</span><br><span class="line">    views.py  <span class="comment"># Contains the custom view mixin(s)</span></span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-24-2" class="outline-3">
<h3 id="sec-24-2"><span class="section-number-3">24.2</span> Optimize Apps with Utility Modules</h3>
<div class="outline-text-3" id="text-24-2">
<p>
Synonymous with helpers, these are commonly called <b>utils.py</b> and sometimes <b>helpers.py.</b><br>
</p>
</div>
<div id="outline-container-sec-24-2-1" class="outline-4">
<h4 id="sec-24-2-1"><span class="section-number-4">24.2.1</span> Trimming Models</h4>
<div class="outline-text-4" id="text-24-2-1">
<p>
One day we notice that our fat model has reached brobdingnagian proprtions and is over a thousand lines of code.<br>
We start looking for methods (or properties or classmethods) whose logic can be easily encapsulated in functions stored in  <i>flavors/utils.py.</i><br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-24-3" class="outline-3">
<h3 id="sec-24-3"><span class="section-number-3">24.3</span> Django's Own Swiss Army Knife</h3>
<div class="outline-text-3" id="text-24-3">
<p>
Most of the modules in django.utils are designed for internal use and only the following parts can be considered stable and thus backwards compatible<br>
<a href="https://docs.djangoproject.com/en/1.8/ref/utils/" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/ref/utils/</a><br>
</p>

<p>
Some useful utils from django:<br>
</p>
<ul class="org-ul">
<li>django.contrib.humanize<br>
</li>
<li>django.utils.decorators.method decorator(decorator)<br>
</li>
<li>django.utils.decorators.decorator from middleware( middleware)<br>
</li>
<li>django.utils.encoding.force text(value)<br>
</li>
<li>django.utils.functional.cached property<br>
</li>
<li>django.utils.html.format html(format str, args, **kwargs)<br>
</li>
<li>django.utils.html.strip tags(value)<br>
</li>
<li>django.utils.six<br>
</li>
<li>django.utils.text.slugify(value)<br>
</li>
<li>django.utils.timezone<br>
</li>
<li>django.utils.translation<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-24-4" class="outline-3">
<h3 id="sec-24-4"><span class="section-number-3">24.4</span> Exceptions</h3>
<div class="outline-text-3" id="text-24-4">
<p>
<a href="https://docs.djangoproject.com/en/dev/ref/exceptions" target="_blank" rel="external">https://docs.djangoproject.com/en/dev/ref/exceptions</a><br>
</p>
</div>
<div id="outline-container-sec-24-4-1" class="outline-4">
<h4 id="sec-24-4-1"><span class="section-number-4">24.4.1</span> django.core.exceptions.ImproperlyConfigured</h4>
<div class="outline-text-4" id="text-24-4-1">
<p>
The purpose of this module is to inform anyone attempting to run Django that there is a con guration issue.<br>
</p>
</div>
</div>
<div id="outline-container-sec-24-4-2" class="outline-4">
<h4 id="sec-24-4-2"><span class="section-number-4">24.4.2</span> django.core.exceptions.ObjectDoesNotExist</h4>
<div class="outline-text-4" id="text-24-4-2">
<p>
We’ve found this is a really nice tool for working with utility functions that fetch generic model instances and do something with them. Here is a simple example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/utils.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ObjectDoesNotExist</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BorkedObject</span><span class="params">(object)</span>:</span> </span><br><span class="line">    loaded = <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generic_load_tool</span><span class="params">(model, pk)</span>:</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	instance = model.objects.get(pk=pk) </span><br><span class="line">    <span class="keyword">except</span> ObjectDoesNotExist:</span><br><span class="line">	<span class="keyword">return</span> BorkedObject() </span><br><span class="line">    instance.loaded = <span class="keyword">True</span> </span><br><span class="line">    <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>
</div>
<p>
We can create our own variant of django's django.shortcuts.getobjector404 function, perhaps raising a HTTP 403 exception instead of a 404:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/utils.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> MultipleObjectsReturned </span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ObjectDoesNotExist </span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> PermissionDenied</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_object_or_403</span><span class="params">(model, **kwargs)</span>:</span> .</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">return</span> model.objects.get(**kwargs)</span><br><span class="line">    <span class="keyword">except</span> ObjectDoesNotExist: </span><br><span class="line">	<span class="keyword">raise</span> PermissionDenied</span><br><span class="line">    <span class="keyword">except</span> MultipleObjectsReturned: </span><br><span class="line">	<span class="keyword">raise</span> PermissionDenied</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-24-4-3" class="outline-4">
<h4 id="sec-24-4-3"><span class="section-number-4">24.4.3</span> django.core.exceptions.PermissionDenied</h4>
<div class="outline-text-4" id="text-24-4-3">
<p>
if something bad happens, instead of just returning a 500 exception, which may rightly alarm users, we simply provide a “Permission Denied” screen.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># stores/calc.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">finance_data_adjudication</span><span class="params">(store, sales, issues)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> store.something_not_right: </span><br><span class="line">	msg = <span class="string">"Something is not right. Please contact the support team."</span></span><br><span class="line">	<span class="keyword">raise</span> PermissionDenied(msg)</span><br><span class="line">    <span class="comment"># Continue on to perform other logic.</span></span><br></pre></td></tr></table></figure>
</div>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"><span class="comment"># This demonstrates the use of a custom permission denied view. The default</span></span><br><span class="line"><span class="comment"># view is django.views.defaults.permission_denied</span></span><br><span class="line">handler403 = <span class="string">'core.views.permission_denied_view'</span></span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-24-5" class="outline-3">
<h3 id="sec-24-5"><span class="section-number-3">24.5</span> Serializers and Deserializers</h3>
<div class="outline-text-3" id="text-24-5">
<p>
Django has some great tools for working with serialization and deserialization of data of JSON, Python, YAML and XML data.<br>
Here is how we serialize data:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># serializer_example.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.serializers <span class="keyword">import</span> get_serializer</span><br><span class="line"><span class="keyword">from</span> favorites.models <span class="keyword">import</span> Favorite</span><br><span class="line"><span class="comment"># Get and instantiate the serializer class</span></span><br><span class="line"><span class="comment"># The 'json' can be replaced with 'python' or 'xml'.</span></span><br><span class="line"><span class="comment"># If you have pyyaml installed, you can replace it with # 'pyyaml'</span></span><br><span class="line">JSONSerializer = get_serializer(<span class="string">"json"</span>).</span><br><span class="line">serializer = JSONSerializer()</span><br><span class="line"></span><br><span class="line">favs = Favorite.objects.filter()[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Serialize model data</span></span><br><span class="line">serialized_data = serializer.serialize(favs)</span><br><span class="line"></span><br><span class="line"><span class="comment"># save the serialized data for use in the next example</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"data.json"</span>, <span class="string">"w"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(serialized_data)</span><br></pre></td></tr></table></figure>
</div>

<p>
Here is how we deserialize data:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># deserializer_example.py</span></span><br><span class="line"><span class="keyword">from</span> django.core.serializers <span class="keyword">import</span> get_serializer</span><br><span class="line"><span class="keyword">from</span> favorites.models <span class="keyword">import</span> Favorite </span><br><span class="line"></span><br><span class="line">favs = Favorite.objects.filter()[:<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get and instantiate the serializer class</span></span><br><span class="line"><span class="comment"># The 'json' can be replaced with 'python' or 'xml'.</span></span><br><span class="line"><span class="comment"># If you have pyyaml installed, you can replace it with</span></span><br><span class="line"><span class="comment">#   'pyyaml'</span></span><br><span class="line">JSONSerializer = get_serializer(<span class="string">"json"</span>)</span><br><span class="line">serializer = JSONSerializer()</span><br><span class="line"></span><br><span class="line"><span class="comment"># open the serialized data file</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"data.txt"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    serialized_data = f.read()</span><br><span class="line"></span><br><span class="line"><span class="comment"># deserialize model data into a generator object</span></span><br><span class="line"><span class="comment">#   we'll call 'python data'</span></span><br><span class="line">python_data = serializer.deserialize(serialized_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate through the python_data </span></span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> python_data:</span><br><span class="line">    <span class="comment"># Prints 'django.core.serializers.base.DeserializedObject' </span></span><br><span class="line">    print(type(element))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Elements have an 'object' that are literally instantiated </span></span><br><span class="line">    <span class="comment"># model instances (in this case, favorites.models.Favorite) </span></span><br><span class="line">    print(element.object.pk, element.object.created)</span><br></pre></td></tr></table></figure>
</div>

<p>
using Django’s built-in serializers and deserializers: they can cause problems. From painful experience, we know that they don’t handle complex data structures well.<br>
Consider these guidelines that we follow in our projects:<br>
</p>
<ul class="org-ul">
<li>Serialize data at the simplest level.<br>
</li>
<li>Any database schema change may invalidate the serialized data.<br>
</li>
<li>Don’t just import serialized data. Consider using Django’s form libraries to validate incoming data before saving to the database.<br>
</li>
</ul>
</div>
<div id="outline-container-sec-24-5-1" class="outline-4">
<h4 id="sec-24-5-1"><span class="section-number-4">24.5.1</span> django.core.serializers.json.DjangoJSONEncoder</h4>
<div class="outline-text-4" id="text-24-5-1">
<p>
Python’s built-in JSON module can’t handle encoding of date/time or decimal types.<br>
Fortunately for all of us, Django provides a very useful JSONEncoder class. See the code example below:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># json_encoding_example.py </span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django.core.serializers.json <span class="keyword">import</span> DjangoJSONEncoder </span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"></span><br><span class="line">data = {<span class="string">"date"</span>: timezone.now()}</span><br><span class="line"></span><br><span class="line"><span class="comment"># If you don't add the DjangoJSONEncoder class then</span></span><br><span class="line"><span class="comment"># the json library will throw a TypeError.</span></span><br><span class="line">json_data = json.dumps(data, cls=DjangoJSONEncoder)</span><br><span class="line">print(json_data)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-25" class="outline-2">
<h2 id="sec-25"><span class="section-number-2">25</span> Deployment:Platforms as a Service</h2>
<div class="outline-text-2" id="text-25">
<p>
The most commonly-used Django-friendly PaaS companies as of this writing are:<br>
</p>
<ul class="org-ul">
<li>Heroku (<a href="http://heroku.com" target="_blank" rel="external">http://heroku.com</a>) is a popular option in the Python community well known for its documentation and add-ons system. If you choose this option, please read <a href="http://www.theherokuhackersguide.com/" target="_blank" rel="external">http://www.theherokuhackersguide.com/</a> by Randall Degges.<br>
</li>
<li>PythonAnywhere (<a href="https://www.pythonanywhere.com" target="_blank" rel="external">https://www.pythonanywhere.com</a>) is a Python-powered PaaS that is incredibly beginner-friendly.<br>
</li>
</ul>
</div>
<div id="outline-container-sec-25-1" class="outline-3">
<h3 id="sec-25-1"><span class="section-number-3">25.1</span> Automate All the Things!</h3>
<div class="outline-text-3" id="text-25-1">
<p>
Use simple automation using one of the following tools:<br>
</p>
<ul class="org-ul">
<li><b>Makefiles</b> are useful for simple projects. Their limited capability means we won’t be tempted to make things too fancy. As soon as you need more power, it’s time to use something else. Something like Invoke as described in the next bullet.<br>
</li>
<li><b>Invoke</b> is the direct descendant of the venerable Fabric library. It is similar to Fabric, but is designed for running tasks locally rather than on a remote server. Tasks are de ned in Python code, which allows for a bit more complexity in task de nitions (although it’s easy to take things too far). It has full support for Python 3.4.<br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-26" class="outline-2">
<h2 id="sec-26"><span class="section-number-2">26</span> Deploying Django Projects</h2>
<div class="outline-text-2" id="text-26">
<p>
<a href="https://docs.djangoproject.com/en/1.8/howto/deployment/" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/howto/deployment/</a><br>
</p>
</div>
<div id="outline-container-sec-26-1" class="outline-3">
<h3 id="sec-26-1"><span class="section-number-3">26.1</span> Single-Server for Small Projects</h3>
<div class="outline-text-3" id="text-26-1">
</div><div id="outline-container-sec-26-1-1" class="outline-4">
<h4 id="sec-26-1-1"><span class="section-number-4">26.1.1</span> Example: Quick Ubuntu + Gunicorn Setup</h4>
<div class="outline-text-4" id="text-26-1-1">
<ul class="org-ul">
<li>An old computer or cheap cloud server<br>
</li>
<li>Ubuntu Server OS<br>
</li>
<li>PostgreSQL<br>
</li>
<li>Virtualenv<br>
</li>
<li>Gunicorn<br>
</li>
</ul>
<p>
You can either use a computer that you have lying around your house, or you can use a cheap cloud server from a provider like DigitalOcean, Rackspace, or AWS.<br>
installing at least these:<br>
<b>For pip/virtualenv</b> python-pip, python-virtualenv<br>
<b>For PostgreSQL</b> postgresql, postgresql-contrib, libpq-dev, python-dev<br>
</p>

<p>
Then we do all the server setup basics like updating packages and creating a user account for the project.<br>
At this point, it’s Django time. We clone the Django project repo into our user’s home directory and create a virtualenv with the project’s Python package dependencies, including Gunicorn. We create a PostgreSQL database for the Django project and run python manage.py migrate.<br>
Then we run the Django project in Gunicorn. As of this writing, this requires a simple 1-line com- mand. See: <a href="https://docs.djangoproject.com/en/1.8/howto/deployment/wsgi/gunicorn/" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/howto/deployment/wsgi/gunicorn/</a><br>
adding nginx, Redis, and/or memcached, or setting up Gunicorn behind an nginx proxy.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-26-2" class="outline-3">
<h3 id="sec-26-2"><span class="section-number-3">26.2</span> Multi-Server for Medium to Large Projects</h3>
<div class="outline-text-3" id="text-26-2">
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure31_1.png" alt="figure31_1.png" title=""></i><br>
This is what you need at the most basic level:<br>
</p>
<ul class="org-ul">
<li><b>Database server.</b> Typically PostgreSQL in our projects when we have the choice, though Eventbrite uses MySQL.<br>
</li>
<li><b>WSGI application server.</b> Typically uWSGI or Gunicorn with Nginx, or Apache with mod wsgi.<br>
</li>
</ul>

<p>
Additionally, we may also want one or more of the following:<br>
</p>
<ul class="org-ul">
<li><b>Static file server.</b> If we want to do it ourselves, Nginx or Apache are fast at serving static files. However, CDNs such as Amazon CloudFront are relatively inexpensive at the basic level.<br>
</li>
<li><b>Caching and/or asynchronous message queue server.</b>  is server might run Redis, Memcached or Varnish.<br>
</li>
<li><b>Miscellaneous server.</b> If our site performs any CPU-intensive tasks, or if tasks involve waiting for an external service (e.g. the Twitter API) it can be convenient to offload them onto a server separate from your WSGI app server.<br>
</li>
</ul>

<p>
Finally, we also need to be able to manage processes on each server. We recommend in descending order of preference:<br>
</p>
<ol class="org-ol">
<li>Supervisord<br>
</li>
<li>init scripts<br>
</li>
</ol>
</div>
<div id="outline-container-sec-26-2-1" class="outline-4">
<h4 id="sec-26-2-1"><span class="section-number-4">26.2.1</span> Advanced Multi-Server Setup</h4>
<div class="outline-text-4" id="text-26-2-1">
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/figure31_3.png" alt="figure31_3.png" title=""></i><br>
Load balancers can be hardware- or software-based. Commonly-used examples include:<br>
</p>
<ul class="org-ul">
<li>Software-based: HAProxy, Varnish, Nginx<br>
</li>
<li>Hardware-based: Foundry, Juniper, DNS load balancer<br>
</li>
<li>Cloud-based: Amazon Elastic Load Balancer, Rackspace Cloud Load Balancer<br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-26-3" class="outline-3">
<h3 id="sec-26-3"><span class="section-number-3">26.3</span> WSGI Application Servers</h3>
<div class="outline-text-3" id="text-26-3">
<p>
The most commonly-used WSGI deployment setups are:<br>
</p>
<ol class="org-ol">
<li>uWSGI with Nginx.<br>
</li>
<li>Gunicorn behind a Nginx proxy.<br>
</li>
<li>Apache with mod wsgi.<br>
</li>
</ol>
<p>
<i><img src="/my_blog/2016/02/19/django學習筆記/table31_1.png" alt="table31_1.png" title=""></i><br>
</p>
</div>
</div>
<div id="outline-container-sec-26-4" class="outline-3">
<h3 id="sec-26-4"><span class="section-number-3">26.4</span> Automated, Repeatable Deployments</h3>
</div>
</div>
<div id="outline-container-sec-27" class="outline-2">
<h2 id="sec-27"><span class="section-number-2">27</span> Continuous Integration</h2>
<div class="outline-text-2" id="text-27">
<p>
Here’s a typical development work ow when using continuous integration:<br>
</p>
<ol class="org-ol">
<li>Developer writes code, runs local tests against it, then pushes the code to an instance of a code repository such as Git or Mercurial. This should happen at least once per day.<br>
</li>
<li>The code repository informs an automation tool that code has not been submitted for integration.<br>
</li>
<li>Automation integrates the code into the project, building out the project. Any failures during the build process and the commit is rejected.<br>
</li>
<li>Automation runs developer-authored tests against the new build. Any failures of the tests and the commit is rejected.<br>
</li>
<li>The developer is notified of success or the details of failure. Based on the report, the developer can mitigate the failures. If there are no failures, the developer celebrates and moves to the next task.<br>
</li>
</ol>
</div>
<div id="outline-container-sec-27-1" class="outline-3">
<h3 id="sec-27-1"><span class="section-number-3">27.1</span> Principles of Continuous Integration</h3>
<div class="outline-text-3" id="text-27-1">
</div><div id="outline-container-sec-27-1-1" class="outline-4">
<h4 id="sec-27-1-1"><span class="section-number-4">27.1.1</span> Write Lots of Tests!</h4>
</div>
<div id="outline-container-sec-27-1-2" class="outline-4">
<h4 id="sec-27-1-2"><span class="section-number-4">27.1.2</span> Keeping the Build Fast</h4>
<div class="outline-text-4" id="text-27-1-2">
<ul class="org-ul">
<li>Avoid fixtures. This is yet another reason why we advise against their use.<br>
</li>
<li>Avoid TransactionTestCase except when absolutely necessary.<br>
</li>
<li>Avoid heavyweight setUp() methods.<br>
</li>
<li>Write small, focused tests that run at lightning speed, plus a few larger integration-style tests.<br>
</li>
<li>Learn how to optimize your database for testing.  is is discussed in public forums like Stack Overflow: <a href="http://stackoverflow.com/a/9407940/93270" target="_blank" rel="external">http://stackoverflow.com/a/9407940/93270</a><br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-27-2" class="outline-3">
<h3 id="sec-27-2"><span class="section-number-3">27.2</span> Tools for Continuously Integrating Your Project</h3>
<div class="outline-text-3" id="text-27-2">
</div><div id="outline-container-sec-27-2-1" class="outline-4">
<h4 id="sec-27-2-1"><span class="section-number-4">27.2.1</span> Tox</h4>
<div class="outline-text-4" id="text-27-2-1">
<p>
<a href="http://tox.readthedocs.org/" target="_blank" rel="external">http://tox.readthedocs.org/</a><br>
This is a generic virtualenv management and testing command-line tool that allows us to test our projects against multiple Python and Django versions with a single command at the shell.<br>
</p>
</div>
</div>
<div id="outline-container-sec-27-2-2" class="outline-4">
<h4 id="sec-27-2-2"><span class="section-number-4">27.2.2</span> Jenkins</h4>
<div class="outline-text-4" id="text-27-2-2">
<p>
<a href="http://jenkins-ci.org/" target="_blank" rel="external">http://jenkins-ci.org/</a><br>
Jenkins is a extensible continuous integration engine used in private and open source efforts around the world. It is the standard for automating the components of Continuous Integration, with a huge community and ecosystem around the tool.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-27-3" class="outline-3">
<h3 id="sec-27-3"><span class="section-number-3">27.3</span> Continuous Integration as a Service</h3>
<div class="outline-text-3" id="text-27-3">
<p>
There are various services that provide automation tools powered by Jenkins or analogues. Some of these plug right into popular repo hosting sites like GitHub and BitBucket, and most provide free repos for open source projects. Some of our favorites include:<br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Service</th>
<th scope="col" class="left">Python Versions Supported</th>
<th scope="col" class="left">Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">Travis-CI</td>
<td class="left">3.3, 3.2, 2.7, 2.6, PyPy</td>
<td class="left"><a href="https://travis-ci.org" target="_blank" rel="external">https://travis-ci.org</a></td>
</tr>

<tr>
<td class="left">AppVeyor (Windows)</td>
<td class="left">3.4, 3.3, 2.7</td>
<td class="left"><a href="http://www.appveyor.com/" target="_blank" rel="external">http://www.appveyor.com/</a></td>
</tr>

<tr>
<td class="left">CircleCI</td>
<td class="left">3.4, 3.3, 2.7, 2.6, PyPy, many more</td>
<td class="left"><a href="https://circleci.com" target="_blank" rel="external">https://circleci.com</a></td>
</tr>

<tr>
<td class="left">Drone.io</td>
<td class="left">2.7, 3.3</td>
<td class="left"><a href="https://drone.io/" target="_blank" rel="external">https://drone.io/</a></td>
</tr>

<tr>
<td class="left">Codeship</td>
<td class="left">3.4, 2.7</td>
<td class="left"><a href="https://codeship.com" target="_blank" rel="external">https://codeship.com</a></td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-sec-27-3-1" class="outline-4">
<h4 id="sec-27-3-1"><span class="section-number-4">27.3.1</span> Code Coverage as a Service</h4>
<div class="outline-text-4" id="text-27-3-1">
<p>
<a href="https://codecov.io" target="_blank" rel="external">https://codecov.io</a> can generate coverage reports<br>
</p>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-28" class="outline-2">
<h2 id="sec-28"><span class="section-number-2">28</span> Debugging</h2>
<div class="outline-text-2" id="text-28">
</div><div id="outline-container-sec-28-1" class="outline-3">
<h3 id="sec-28-1"><span class="section-number-3">28.1</span> Debugging in Development</h3>
<div class="outline-text-3" id="text-28-1">
</div><div id="outline-container-sec-28-1-1" class="outline-4">
<h4 id="sec-28-1-1"><span class="section-number-4">28.1.1</span> Use django-debug-toolbar</h4>
<div class="outline-text-4" id="text-28-1-1">
<p>
If you don’t have it set up and con gured, stop everything else you are doing and add it to your project.<br>
</p>
<ul class="org-ul">
<li><a href="https://pypi.python.org/pypi/django-debug-toolbar" target="_blank" rel="external">https://pypi.python.org/pypi/django-debug-toolbar</a> <br>
</li>
<li><a href="http://django-debug-toolbar.readthedocs.org" target="_blank" rel="external">http://django-debug-toolbar.readthedocs.org</a><br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-28-1-2" class="outline-4">
<h4 id="sec-28-1-2"><span class="section-number-4">28.1.2</span> That Annoying CBV Error</h4>
<div class="outline-text-4" id="text-28-1-2">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">twoscoopspress$ python discounts/manage.py runserver <span class="number">8001</span> </span><br><span class="line">Starting development server at http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8001</span>/ </span><br><span class="line">Quit the server <span class="keyword">with</span> CONTROL-C.</span><br><span class="line"></span><br><span class="line">Internal Server Error: /</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File <span class="string">"/Users/python/lib/python2.7/site-packages/django/core/handlers/base.py"</span>,</span><br><span class="line">	line <span class="number">132</span>, <span class="keyword">in</span> get_response response = wrapped_callback(request,</span><br><span class="line">	*callback_args, **callback_kwargs)</span><br><span class="line">File <span class="string">"/Users/python/lib/python2.7/site-packages/django/utils/decorators.py"</span>,</span><br><span class="line">	line <span class="number">145</span>, <span class="keyword">in</span> inner</span><br><span class="line">    <span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">TypeError: __init__() takes exactly <span class="number">1</span> argument (<span class="number">2</span> given)</span><br></pre></td></tr></table></figure>
</div>
<p>
This error is caused because lack as_view() at urls.py<br>
Example of TypeError generating code:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Forgetting the 'as_view()' method </span></span><br><span class="line">url(<span class="string">r'ˆ$'</span>, HomePageView, name=<span class="string">"home"</span>),</span><br></pre></td></tr></table></figure>
</div>
<p>
Example of fixed code:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url(<span class="string">r'ˆ$'</span>, HomePageView.as_view(), name=<span class="string">"home"</span>),</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-28-1-3" class="outline-4">
<h4 id="sec-28-1-3"><span class="section-number-4">28.1.3</span> Master the Python Debugger</h4>
<div class="outline-text-4" id="text-28-1-3">
<p>
ipdb(ipdb does is add the ipython interface to the PDB interface) is also very useful<br>
References:<br>
</p>
<ul class="org-ul">
<li>Python’s pdb documentation: <a href="https://docs.python.org/2/library/pdb.html" target="_blank" rel="external">https://docs.python.org/2/library/pdb.html</a><br>
</li>
<li>IPDB: <a href="https://pypi.python.org/pypi/ipdb" target="_blank" rel="external">https://pypi.python.org/pypi/ipdb</a><br>
</li>
<li>Using PDB with Django: <a href="https://mike.tig.as/blog/2010/09/14/pdb/" target="_blank" rel="external">https://mike.tig.as/blog/2010/09/14/pdb/</a><br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-28-1-4" class="outline-4">
<h4 id="sec-28-1-4"><span class="section-number-4">28.1.4</span> Remember the Essentials for Form File Uploads</h4>
<div class="outline-text-4" id="text-28-1-4">
<p>
There are two easily forgotten items that will cause file uploads to fail silently.<br>
check the following:<br>
</p>

<ol class="org-ol">
<li>Does the &lt;form&gt; tag include an encoding type?<br>
</li>
</ol>
<p>
<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&amp;lt;form action=<span class="string">"{% url 'stores:file_upload' store.pk %}"</span></span><br><span class="line">	method=<span class="string">"post"</span></span><br><span class="line">	enctype=<span class="string">"multipart/form-data"</span>&amp;gt;</span><br></pre></td></tr></table></figure>
</div>
<p>
<br>
</p>

<ol class="org-ol">
<li>Do the views handle request.FILES? In Function-Based Views?<br>
</li>
</ol>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># stores/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect, get_object_or_404 </span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> stores.forms <span class="keyword">import</span> UploadFileForm </span><br><span class="line"><span class="keyword">from</span> stores.models <span class="keyword">import</span> Store</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload_file</span><span class="params">(request, pk)</span>:</span></span><br><span class="line">    <span class="string">"""Simple FBV example"""</span></span><br><span class="line">    store = get_object_or_404(Store, pk=pk) </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">	<span class="comment"># Don't forget to add request.FILES!</span></span><br><span class="line">	form = UploadFileForm(request.POST, request.FILES) </span><br><span class="line">	<span class="keyword">if</span> form.is_valid():</span><br><span class="line">	    store.handle_uploaded_file(request.FILES[<span class="string">'file'</span>]) </span><br><span class="line">	    <span class="keyword">return</span> redirect(store)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">	form = UploadFileForm()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'upload.html'</span>, {<span class="string">'form'</span>: form, <span class="string">'store'</span>: store})</span><br></pre></td></tr></table></figure>
</div>
<p>
Or what about Class-Based Views?<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># stores/views.py</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, redirect, get_object_or_404</span><br><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> View</span><br><span class="line"><span class="keyword">from</span> stores.forms <span class="keyword">import</span> UploadFileForm </span><br><span class="line"><span class="keyword">from</span> stores.models <span class="keyword">import</span> Store</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploadFile</span><span class="params">(View)</span>:</span> </span><br><span class="line">    <span class="string">"""Simple CBV example"""</span> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_object</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> get_object_or_404(Store, pk=self.kwargs[<span class="string">'pk'</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">    store = self.get_object() .</span><br><span class="line">    form = UploadFileForm(request.POST, request.FILES) </span><br><span class="line">    <span class="keyword">if</span> form.is_valid():</span><br><span class="line">	store.handle_uploaded_file(request.FILES[<span class="string">'file'</span>])</span><br><span class="line">	<span class="keyword">return</span> redirect(store)</span><br><span class="line">    <span class="keyword">return</span> redirect(<span class="string">'stores:file_upload'</span>, pk=pk)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">    store = self.get_object()</span><br><span class="line">    form = UploadFileForm()</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'upload.html'</span>, {<span class="string">'form'</span>: form, <span class="string">'store'</span>: store})</span><br></pre></td></tr></table></figure>
</div>

<p>
If a view inherits from one of the following then we don’t need to worry about re- quest.FILES in your view code. Django handles most of the work involved.<br>
</p>
<ul class="org-ul">
<li>django.views.generic.edit.FormMixin<br>
</li>
<li>django.views.generic.edit.FormView<br>
</li>
<li>django.views.generic.edit.CreateView<br>
</li>
<li>django.views.generic.edit.UpdateView<br>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-28-2" class="outline-3">
<h3 id="sec-28-2"><span class="section-number-3">28.2</span> Debugging Production Systems</h3>
<div class="outline-text-3" id="text-28-2">
</div><div id="outline-container-sec-28-2-1" class="outline-4">
<h4 id="sec-28-2-1"><span class="section-number-4">28.2.1</span> Read the Logs the Easy Way</h4>
<div class="outline-text-4" id="text-28-2-1">
<p>
use a log aggregator like Sentry get a better view into what is going on in your application.<br>
</p>
</div>
</div>
<div id="outline-container-sec-28-2-2" class="outline-4">
<h4 id="sec-28-2-2"><span class="section-number-4">28.2.2</span> Mirroring Production</h4>
</div>
<div id="outline-container-sec-28-2-3" class="outline-4">
<h4 id="sec-28-2-3"><span class="section-number-4">28.2.3</span> UserBasedExceptionMiddleware</h4>
<div class="outline-text-4" id="text-28-2-3">
<p>
What if you could provide superusers with access to the settings.DEBUG=True 500 error page in production?<br>
there is a way to use this powerful debugging tool in production.<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># core/middleware.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> django.views.debug <span class="keyword">import</span> technical_500_response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserBasedExceptionMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> request.user.is_superuser:</span><br><span class="line">	    <span class="keyword">return</span> technical_500_response(request, *sys.exc_info())</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-28-2-4" class="outline-4">
<h4 id="sec-28-2-4"><span class="section-number-4">28.2.4</span> That Troublesome settings.ALLOWED HOSTS Error</h4>
<div class="outline-text-4" id="text-28-2-4">
<p>
Unfortunately, as soon as settings.DEBUG is False, a project with an incorrectly set ALLOWED_HOSTS will generate constant 500 errors. Checking the logs will show that SuspiciousOperation errors are being raised, but those errors don’t come with a meaningful message.<br>
</p>

<p>
Therefore, whenever a project is deployed for the first time and always returns a 500 error, check settings.ALLOWED HOSTS. As for knowing what to set, here is a starting example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">ALLOWED_HOSTS = [</span><br><span class="line">    <span class="string">'.djangopackages.com'</span>,</span><br><span class="line">    <span class="string">'localhost'</span>,  <span class="comment"># Ensures we can run DEBUG = False locally</span></span><br><span class="line">    <span class="string">'127.0.0.1'</span>  <span class="comment"># Ensures we can run DEBUG = False locally</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-28-3" class="outline-3">
<h3 id="sec-28-3"><span class="section-number-3">28.3</span> Feature Flags</h3>
<div class="outline-text-3" id="text-28-3">
<p>
<b>Feature Flags</b> allow us to turn a project’s feature on or off via a web-based interface.<br>
What if we could allow a subset of real users (i.e. ‘beta users’) defined through an admin-style interface to interact with a new feature before turning it on for everyone?<br>
This is what feature  ags are all about!<br>
</p>
</div>
<div id="outline-container-sec-28-3-1" class="outline-4">
<h4 id="sec-28-3-1"><span class="section-number-4">28.3.1</span> Feature Flag Packages</h4>
<div class="outline-text-4" id="text-28-3-1">
<ul class="org-ul">
<li><a href="https://github.com/disqus/gargoyle" target="_blank" rel="external">https://github.com/disqus/gargoyle</a><br>
</li>
<li><a href="https://github.com/jsocol/django-waffle" target="_blank" rel="external">https://github.com/jsocol/django-waffle</a><br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-28-3-2" class="outline-4">
<h4 id="sec-28-3-2"><span class="section-number-4">28.3.2</span> Unit Testing Code Affected by Feature Flags</h4>
<div class="outline-text-4" id="text-28-3-2">
<p>
One gotcha with feature  ags is running tests against code that are turned off by them. How do we know that our new feature is tested when the flag to run them is turned off?<br>
The answer to this question is that our tests should cover both code paths, with feature flags on or off. To do this, we need to familiarize ourselves with how to turn a feature  ag on or off within the Django testing framework:<br>
</p>
<ul class="org-ul">
<li><a href="http://gargoyle.readthedocs.org/en/latest/usage/index.html#testing-switches" target="_blank" rel="external">http://gargoyle.readthedocs.org/en/latest/usage/index.html#testing-switches</a><br>
</li>
<li><a href="http://waffle.readthedocs.org/en/latest/testing/automated.html#testing-automated" target="_blank" rel="external">http://waffle.readthedocs.org/en/latest/testing/automated.html#testing-automated</a><br>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-29" class="outline-2">
<h2 id="sec-29"><span class="section-number-2">29</span> Internationalization and Localization</h2>
<div class="outline-text-2" id="text-29">
</div><div id="outline-container-sec-29-1" class="outline-3">
<h3 id="sec-29-1"><span class="section-number-3">29.1</span> Define Python Source Code Encodings</h3>
<div class="outline-text-3" id="text-29-1">
<p>
at the top each module add:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-29-2" class="outline-3">
<h3 id="sec-29-2"><span class="section-number-3">29.2</span> Wrap Content Strings with Translation Functions</h3>
<div class="outline-text-3" id="text-29-2">
<p>
<a href="https://docs.djangoproject.com/en/1.8/topics/i18n/translation/" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/i18n/translation/</a><br>
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Function</th>
<th scope="col" class="left">Purpose</th>
<th scope="col" class="left">Link</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">ugettext()</td>
<td class="left">For content executed at runtime, e.g. form validation errors.</td>
<td class="left"><a href="https://docs.djangoproject.com/en/1.8/topics/i18n/translation/#standard-translation" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/i18n/translation/#standard-translation</a></td>
</tr>

<tr>
<td class="left">ugettext lazy()</td>
<td class="left">For content executed at compile time, e.g. verbose name in models.</td>
<td class="left"><a href="https://docs.djangoproject.com/en/1.8/topics/i18n/translation/#lazy-translation" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/i18n/translation/#lazy-translation</a></td>
</tr>

<tr>
<td class="left">string concat()</td>
<td class="left">Replaces the standard str.join() method for joining strings. Rarely used.</td>
<td class="left"><a href="https://docs.djangoproject.com/en/1.8/topics/i18n/translation/#localized-names-of-languages" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/topics/i18n/translation/#localized-names-of-languages</a></td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-sec-29-2-1" class="outline-4">
<h4 id="sec-29-2-1"><span class="section-number-4">29.2.1</span> Convention: Use the Underscore Alias to Save Typing</h4>
<div class="outline-text-4" id="text-29-2-1">
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> ugettext <span class="keyword">as</span> _</span><br><span class="line"></span><br><span class="line">print(_(<span class="string">"We like gelato."</span>))</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
</div>
<div id="outline-container-sec-29-3" class="outline-3">
<h3 id="sec-29-3"><span class="section-number-3">29.3</span> Don't Interpolate Words in Sentences</h3>
<div class="outline-text-3" id="text-29-3">
<p>
Bad Example:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># DON'T DO THIS!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Skipping the rest of imports for the sake of brevity</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorActionMixin</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line"><span class="decorator">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">action</span><span class="params">(self)</span>:</span></span><br><span class="line">	msg = <span class="string">"{0} is missing action."</span>.format(self.__class__)</span><br><span class="line">	<span class="keyword">raise</span> NotImplementedError(msg)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">	msg = <span class="string">"Flavor {0}!"</span>.format(self.action) </span><br><span class="line">	messages.info(self.request, msg)</span><br><span class="line">	<span class="keyword">return</span> super(FlavorActionMixin, self).form_valid(form)</span><br><span class="line"><span class="comment"># Snipping the rest of this module for the sake of brevity</span></span><br></pre></td></tr></table></figure>
</div>
<p>
want to change above to international string but it does not works:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># DON'T DO THIS!</span></span><br><span class="line"><span class="keyword">from</span> django.utils.translations <span class="keyword">import</span> ugettext <span class="keyword">as</span> _</span><br><span class="line"></span><br><span class="line"><span class="comment"># Skipping the rest of this module for the sake of brevity </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">form_valid</span><span class="params">(self, form)</span>:</span></span><br><span class="line">    <span class="comment"># This generates a useless translation object.</span></span><br><span class="line">    msg = _(<span class="string">"Flavor {0}!"</span>.format(self.action)) messages.info(self.request, msg)</span><br><span class="line">    <span class="keyword">return</span> super(FlavorActionMixin, self).form_valid(form)</span><br><span class="line"><span class="comment"># Skipping the rest of this module for the sake of brevity</span></span><br></pre></td></tr></table></figure>
</div>

<p>
improve above:<br>
</p>
<div class="org-src-container">

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># Skipping the rest of imports for the sake of brevity from django.utils.translation import ugettext as _</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorActionMixin</span><span class="params">(object)</span>:</span></span><br><span class="line"><span class="decorator">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">success_msg</span><span class="params">(self)</span>:</span> .</span><br><span class="line">	<span class="keyword">return</span> <span class="built_in">NotImplemented</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FlavorCreateView</span><span class="params">(LoginRequiredMixin, FlavorActionMixin, CreateView)</span>:</span></span><br><span class="line">    model = Flavor</span><br><span class="line">    <span class="comment"># Slightly longer but more meaningful dialogue</span></span><br><span class="line">    success_msg = _(<span class="string">"Flavor created!"</span>)</span><br></pre></td></tr></table></figure>
</div>
</div>
</div>
<div id="outline-container-sec-29-4" class="outline-3">
<h3 id="sec-29-4"><span class="section-number-3">29.4</span> Unicode Tricks</h3>
<div class="outline-text-3" id="text-29-4">
<ul class="org-ul">
<li>Python 3 Can Make Unicode Easier<br>
</li>
<li>Use django.utils.encoding.force text() Instead of unicode() or str()<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-29-5" class="outline-3">
<h3 id="sec-29-5"><span class="section-number-3">29.5</span> Browser Page Layout</h3>
<div class="outline-text-3" id="text-29-5">
<p>
Assuming you’ve got your content and Django templates internationalized and localized, you can discover that your layouts are broken.<br>
Mozilla’s answer is to determine the width of a title container, then use JavaScript adjust the font size of the title text downwards until the text fits into the container with wrapping.<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-30" class="outline-2">
<h2 id="sec-30"><span class="section-number-2">30</span> Security Settings Reference</h2>
<div class="outline-text-2" id="text-30">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left">

<col class="left">

<col class="left">
</colgroup>
<thead>
<tr>
<th scope="col" class="left">Setting</th>
<th scope="col" class="left">Development</th>
<th scope="col" class="left">Production</th>
</tr>
</thead>
<tbody>
<tr>
<td class="left">ALLOWED_HOSTS</td>
<td class="left">any list</td>
<td class="left"><a href="#sec-28-2-4">see previous chapter</a></td>
</tr>

<tr>
<td class="left">DEBUG</td>
<td class="left">True</td>
<td class="left">False</td>
</tr>

<tr>
<td class="left">DEBUG_PROPAGATE_EXCEPTIONS</td>
<td class="left">False</td>
<td class="left">False</td>
</tr>

<tr>
<td class="left">Email SSL</td>
<td class="left">see below</td>
<td class="left">see below</td>
</tr>

<tr>
<td class="left">MIDDLEWARE_CLASSES</td>
<td class="left">Standard</td>
<td class="left">AddSecurityMiddleware</td>
</tr>

<tr>
<td class="left">SECRET_KEY</td>
<td class="left">Use cryptographic key</td>
<td class="left"><a href="#sec-3-2">see previous chapter</a></td>
</tr>

<tr>
<td class="left">SECURE_PROXY_SSL_HEADER</td>
<td class="left">None</td>
<td class="left">see below</td>
</tr>

<tr>
<td class="left">SECURE_SSL_HOST</td>
<td class="left">False</td>
<td class="left">True</td>
</tr>

<tr>
<td class="left">SESSION_COOKIE_SECURE</td>
<td class="left">False</td>
<td class="left">True</td>
</tr>

<tr>
<td class="left">SESSION SERIALIZER</td>
<td class="left">see below</td>
<td class="left">see below</td>
</tr>
</tbody>
</table>
</div>
<div id="outline-container-sec-30-1" class="outline-3">
<h3 id="sec-30-1"><span class="section-number-3">30.1</span> Email SSL</h3>
<div class="outline-text-3" id="text-30-1">
<p>
<a href="https://docs.djangoproject.com/en/1.8/ref/settings/#email-use-tls" target="_blank" rel="external">https://docs.djangoproject.com/en/1.8/ref/settings/#email-use-tls</a><br>
</p>
<ul class="org-ul">
<li>EMAIL_USE_TLS<br>
</li>
<li>EMAIL_USE_SSL<br>
</li>
<li>EMAIL_SSL_CERTFILE <br>
</li>
<li>EMAIL_SSL_KEYFILE<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-30-2" class="outline-3">
<h3 id="sec-30-2"><span class="section-number-3">30.2</span> SESSION SERIALIZER</h3>
<div class="outline-text-3" id="text-30-2">
<p>
SESSION SERIALIZER = django.contrib.sessions.serializers.JSONSerializer.<br>
</p>
</div>
</div>
<div id="outline-container-sec-30-3" class="outline-3">
<h3 id="sec-30-3"><span class="section-number-3">30.3</span> SECURE PROXY SSL HEADER</h3>
<div class="outline-text-3" id="text-30-3">
<p>
For some setups, most notably Heroku, this should be:<br>
SECURE PROXY SSL HEADER = (`HTTP X FORWARDED PROTO', `https')<br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-31" class="outline-2">
<h2 id="sec-31"><span class="section-number-2">31</span> Some Useful Packages</h2>
<div class="outline-text-2" id="text-31">
</div><div id="outline-container-sec-31-1" class="outline-3">
<h3 id="sec-31-1"><span class="section-number-3">31.1</span> Core</h3>
<div class="outline-text-3" id="text-31-1">
<ul class="org-ul">
<li>django-debug-toolbar <a href="http://django-debug-toolbar.readthedocs.org/" target="_blank" rel="external">http://django-debug-toolbar.readthedocs.org/</a> Display panels used for debugging Django HTML views.<br>
</li>
<li>ipdb <a href="https://pypi.python.org/pypi/ipdb" target="_blank" rel="external">https://pypi.python.org/pypi/ipdb</a> IPython-enabled pdb<br>
</li>
<li>Sphinx <a href="http://sphinx-doc.org/" target="_blank" rel="external">http://sphinx-doc.org/</a> Documentation tool for Python projects.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-2" class="outline-3">
<h3 id="sec-31-2"><span class="section-number-3">31.2</span> Asynchronous</h3>
<div class="outline-text-3" id="text-31-2">
<ul class="org-ul">
<li>celery <a href="http://www.celeryproject.org/" target="_blank" rel="external">http://www.celeryproject.org/</a> Distributed task queue.<br>
</li>
<li>django-rq <a href="https://pypi.python.org/pypi/django-rq" target="_blank" rel="external">https://pypi.python.org/pypi/django-rq</a> A simple app that provides django integration for RQ (Redis Queue).<br>
</li>
<li>django-background-tasks <a href="https://pypi.python.org/pypi/django-background-tasks" target="_blank" rel="external">https://pypi.python.org/pypi/django-background-tasks</a> Database backed asynchronous task queue.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-3" class="outline-3">
<h3 id="sec-31-3"><span class="section-number-3">31.3</span> Deployment</h3>
<div class="outline-text-3" id="text-31-3">
<ul class="org-ul">
<li>Invoke <a href="https://pypi.python.org/pypi/invoke" target="_blank" rel="external">https://pypi.python.org/pypi/invoke</a> Like Fabric, also works in Python 3.<br>
</li>
<li>Supervisor <a href="http://supervisord.org/" target="_blank" rel="external">http://supervisord.org/</a> Supervisord is a client/server system that allows its users to monitor and control a number of processes on UNIX-like operating systems.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-4" class="outline-3">
<h3 id="sec-31-4"><span class="section-number-3">31.4</span> Forms</h3>
<div class="outline-text-3" id="text-31-4">
<ul class="org-ul">
<li>django-crispy-forms <a href="http://django-crispy-forms.readthedocs.org/" target="_blank" rel="external">http://django-crispy-forms.readthedocs.org/</a> Rendering controls for Django forms. Uses Twitter Bootstrap widgets by default, but skinnable.<br>
</li>
<li>django- oppyforms <a href="http://django-floppyforms.readthedocs.org/" target="_blank" rel="external">http://django-floppyforms.readthedocs.org/</a> Form field, widget, and layout that can work with django-crispy-forms.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-5" class="outline-3">
<h3 id="sec-31-5"><span class="section-number-3">31.5</span> Logging</h3>
<div class="outline-text-3" id="text-31-5">
<ul class="org-ul">
<li>Sentry <a href="http://getsentry.com" target="_blank" rel="external">http://getsentry.com</a> Exceptional error aggregation, with an open source code base.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-6" class="outline-3">
<h3 id="sec-31-6"><span class="section-number-3">31.6</span> Project Templates</h3>
<div class="outline-text-3" id="text-31-6">
<ul class="org-ul">
<li>cookiecutter-django <a href="https://github.com/pydanny/cookiecutter-django" target="_blank" rel="external">https://github.com/pydanny/cookiecutter-django</a> The sample project layout detailed in chapter 3 of this book.<br>
</li>
<li>Cookiecutter <a href="http://cookiecutter.readthedocs.org" target="_blank" rel="external">http://cookiecutter.readthedocs.org</a> Not explicitly for Django, a command-line utility for creating project and app templates. It’s focused, heavily tested and well documented. By one of the authors of this book.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-7" class="outline-3">
<h3 id="sec-31-7"><span class="section-number-3">31.7</span> REST APIs</h3>
<div class="outline-text-3" id="text-31-7">
<ul class="org-ul">
<li>django-rest-framework <a href="http://django-rest-framework.org/" target="_blank" rel="external">http://django-rest-framework.org/</a> The defacto REST package for Django. Exposes model and non-model resources as a RESTful API.<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-31-8" class="outline-3">
<h3 id="sec-31-8"><span class="section-number-3">31.8</span> Testing</h3>
<div class="outline-text-3" id="text-31-8">
<ul class="org-ul">
<li>coverage <a href="http://coverage.readthedocs.org/" target="_blank" rel="external">http://coverage.readthedocs.org/</a> Checks how much of your code is covered with tests.<br>
</li>
<li>mock <a href="https://pypi.python.org/pypi/mock" target="_blank" rel="external">https://pypi.python.org/pypi/mock</a> Not explicitly for Django, this allows you to replace parts of your system with mock objects. This project made its way into the standard library as of Python 3.4.<br>
</li>
<li>tox <a href="http://tox.readthedocs.org/" target="_blank" rel="external">http://tox.readthedocs.org/</a> A generic virtualenv management and test command line tool that allows testing of projects against multiple Python version with a single command at the shell.<br>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-31-9" class="outline-3">
<h3 id="sec-31-9"><span class="section-number-3">31.9</span> Views</h3>
<div class="outline-text-3" id="text-31-9">
<ul class="org-ul">
<li>django-braces <a href="http://django-braces.readthedocs.org" target="_blank" rel="external">http://django-braces.readthedocs.org</a> Drop-in mixins that really empower Django’s class-based views.<br>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-31-10" class="outline-3">
<h3 id="sec-31-10"><span class="section-number-3">31.10</span> Feature Flag</h3>
<div class="outline-text-3" id="text-31-10">
<p>
<a href="https://github.com/disqus/gargoyle" target="_blank" rel="external">https://github.com/disqus/gargoyle</a><br>
<a href="https://github.com/jsocol/django-waffle" target="_blank" rel="external">https://github.com/jsocol/django-waffle</a><br>
</p>
</div>
</div>
</div>
<div id="outline-container-sec-32" class="outline-2">
<h2 id="sec-32"><span class="section-number-2">32</span> Reference</h2>
<div class="outline-text-2" id="text-32">
<p>
此筆記大多來自這本書：<br>
Two Scoops of Django: Best Practices for Django 1.8<br>
by Daniel Roy Greenfeld (Author), Audrey Roy Greenfeld (Author)<br>
<a href="https://www.twoscoopspress.com/" target="_blank" rel="external">https://www.twoscoopspress.com/</a><br>
</p>
</div>
</div>

Last Updated 2017-03-10 五 10:26.<br>Render by <a href="https://github.com/CodeFalling/hexo-renderer-org" target="_blank" rel="external">hexo-renderer-org</a> with <a href="http://www.gnu.org/software/emacs/" target="_blank" rel="external">Emacs</a> 25.2.1 (<a href="http://orgmode.org" target="_blank" rel="external">Org</a> mode 8.2.10)

            
                

            
        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/my_blog/tags/django/">django</a> <a class="tag tag--primary tag--small t-link" href="/my_blog/tags/python/">python</a>

            </div>
        
        <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/my_blog/2016/03/03/freenode_irc指令筆記/"  data-tooltip="freenode irc 指令筆記">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/my_blog/2016/02/19/spacemacs筆記/" data-tooltip="spacemacs筆記">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


        
            <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2017 Cwza. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="3">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/my_blog/2016/03/03/freenode_irc指令筆記/"  data-tooltip="freenode irc 指令筆記">
                
                    <i class="fa fa-angle-left"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    <a class="post-action-btn btn btn--default tooltip--top" href="/my_blog/2016/02/19/spacemacs筆記/" data-tooltip="spacemacs筆記">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions"  href="#btn-open-shareoptions">
                <i class="fa fa-share-alt"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-google-plus"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-facebook-official"></i>
            </a>
        </li>
        <li class="post-action hide-xs">
            <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-twitter"></i>
            </a>
        </li>
        
            <li class="post-action">
                <a class="post-action-btn btn btn--default" href="#disqus_thread">
                    <i class="fa fa-comment-o"></i>
                </a>
            </li>
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#">
            
                <i class="fa fa-list"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="3">
    <ul class="share-options">
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-google-plus"></i><span class="">Share on Google Plus</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-facebook-official"></i><span>Share on Facebook</span>
            </a>
        </li>
        <li class="share-option">
            <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=http://cwza.github.io/my_blog/my_blog/2016/02/19/django學習筆記/">
                <i class="fa fa-twitter"></i><span>Share on Twitter</span>
            </a>
        </li>
    </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
            
        </div>
        <!-- Define author's picture -->


    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-remove"></i>
        </div>
        
            <img id="about-card-picture" src="https://www.gravatar.com/avatar/f563bb5ba525d2aa148cd22fb4c2db26?s=110"/>
        
            <h4 id="about-card-name">Cwza</h4>
        
            <h5 id="about-card-bio"><p>Hello everyone.</br> I’m cwza.</br> Welcome to my blog.</br></p>
</h5>
        
        
            <h5 id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Software Engineer</p>

            </h5>
        
        
            <h5 id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                Taiwan/Taipei
            </h5>
        
    </div>
</div>

        
<div id="cover" style="background-image:url('/my_blog/assets/images/cover.jpg');"></div>
    </body>
    <!--SCRIPTS-->
<script src="/my_blog/assets/js/script.min.js"></script>
<!--SCRIPTS END-->

    <script type="text/javascript">
        var disqus_shortname = 'cwzablog';
        (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>


    <script type="text/javascript">
        (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
                (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
            e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
        })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

        _st('install','rxPzK7_9dZFEqRaWyGy2','2.0.0');
    </script>


</html>
